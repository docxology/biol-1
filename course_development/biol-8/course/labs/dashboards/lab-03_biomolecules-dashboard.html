<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 3 Dashboard: Biomolecules | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.card-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3, .card-row-4 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
.btn-active { background: var(--accent); color: #fff; border-color: var(--accent); }

select.form-select {
  padding: 8px 14px; border-radius: 8px; font-size: 14px; font-weight: 500;
  border: 2px solid var(--border); background: #fff; font-family: var(--font);
  cursor: pointer; transition: all 0.15s; min-width: 180px;
}
select.form-select:focus { outline: none; border-color: var(--accent); }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   DATA GRID
   ═══════════════════════════════════════════════════════════════════════ */
.data-grid {
  display: grid; gap: 3px; margin: 10px 0; font-family: var(--mono); font-size: 14px;
}
.data-grid .cell {
  display: flex; align-items: center; justify-content: center;
  height: 38px; border-radius: 4px; font-weight: 700; transition: all 0.2s;
}
.data-grid .cell-header { background: #1a1a1a; color: #fff; font-size: 11px; font-weight: 600; }
.data-grid .cell-label { background: #f1f5f9; color: var(--text); font-size: 12px; font-weight: 600; }
.data-grid .cell-empty { background: #fafafa; border: 1px dashed #d1d5db; color: #d1d5db; }
.data-grid .cell-pos { background: #f0fdf4; color: var(--green); border: 1px solid #bbf7d0; }
.data-grid .cell-neg { background: #fef2f2; color: var(--accent); border: 1px solid #fecaca; }
.data-grid .cell-new { animation: cellPop 0.3s ease; }
@keyframes cellPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

/* ═══════════════════════════════════════════════════════════════════════
   FLIP CARDS
   ═══════════════════════════════════════════════════════════════════════ */
.flip-card { perspective: 800px; cursor: pointer; min-height: 320px; }
.flip-card-inner {
  position: relative; width: 100%; height: 100%; min-height: 320px;
  transition: transform 0.6s; transform-style: preserve-3d;
}
.flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
.flip-card-front, .flip-card-back {
  position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
  border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 20px; border: 1px solid var(--border); background: var(--card);
  overflow-y: auto;
}
.flip-card-back { transform: rotateY(180deg); }
.flip-hint { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 8px; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   RESULTS TABLE
   ═══════════════════════════════════════════════════════════════════════ */
.results-table {
  width: 100%; border-collapse: collapse; font-size: 13px; margin: 12px 0;
}
.results-table th, .results-table td {
  padding: 10px 12px; text-align: center; border: 1px solid var(--border);
}
.results-table th { background: #1a1a1a; color: #fff; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.results-table td { background: #fafafa; }
.results-table td.pos { background: #f0fdf4; color: var(--green); font-weight: 700; }
.results-table td.neg { background: #fef2f2; color: var(--accent); font-weight: 700; }
.results-table td.sample-name { background: #f1f5f9; font-weight: 600; text-align: left; }

/* ═══════════════════════════════════════════════════════════════════════
   ORGAN CLICKABLE
   ═══════════════════════════════════════════════════════════════════════ */
.organ-panel {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px; min-height: 100px;
}
.organ-panel .op-title { font-weight: 700; margin-bottom: 6px; font-size: 16px; }
.organ-panel .op-enzyme { color: var(--accent); font-weight: 700; }
.organ-panel .op-substrate { color: var(--blue); font-weight: 600; }
.organ-panel .op-product { color: var(--green); font-weight: 600; }

/* ═══════════════════════════════════════════════════════════════════════
   MEAL BUILDER
   ═══════════════════════════════════════════════════════════════════════ */
.meal-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px; border-radius: 6px; background: #f8fafc;
  border: 1px solid var(--border); margin: 4px 0; font-size: 13px;
}
.meal-item .mi-name { font-weight: 600; }
.meal-item .mi-cal { font-family: var(--mono); color: var(--text-muted); }
.meal-item .mi-remove { cursor: pointer; color: var(--accent); font-weight: 700; padding: 2px 8px; }

/* ═══════════════════════════════════════════════════════════════════════
   SCORE DISPLAY
   ═══════════════════════════════════════════════════════════════════════ */
.score-display {
  text-align: center; padding: 20px; background: linear-gradient(135deg, #1a1a2e, #2d1b3d);
  border-radius: var(--radius); color: #fff; margin: 12px 0;
}
.score-display .score-val { font-size: 48px; font-weight: 800; font-family: var(--mono); }
.score-display .score-label { font-size: 13px; color: #94a3b8; margin-top: 4px; }

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
  .card-row-4 { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 500px) {
  .card-row-4 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 3 &mdash; Biomolecules</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Indicator Tests</a>
    <a href="#part2"><span class="nav-num">2</span> Macromolecule Cards</a>
    <a href="#part3"><span class="nav-num">3</span> Food Analysis</a>
    <a href="#part4"><span class="nav-num">4</span> Enzyme Digestion</a>
    <a href="#part5"><span class="nav-num">5</span> Nutrition Calculator</a>
    <a href="#part6"><span class="nav-num">6</span> Unknown Challenge</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Biomolecules</h2>
  <p>Perform virtual biochemical tests, explore macromolecule structures, analyze foods, trace enzyme digestion pathways, and calculate nutritional profiles in this interactive lab.</p>
  <div class="bio-tags">
    <span class="bio-tag">Macromolecules</span>
    <span class="bio-tag">Indicator Tests</span>
    <span class="bio-tag">Nutrition</span>
  </div>
</div>

<!-- ═══════════════════════ PART 1: INDICATOR TEST VIRTUAL LAB ════════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Indicator Test Virtual Lab</div>
    <div class="section-subtitle">Select a reagent and food sample to perform biochemical tests</div></div>
  </div>
  <div class="card">
    <div class="card-title">Test Setup</div>
    <div class="card-row">
      <div>
        <label style="font-size:13px;font-weight:600;display:block;margin-bottom:6px;">Reagent</label>
        <select class="form-select" id="reagent-select">
          <option value="benedicts">Benedict's (Simple Sugars)</option>
          <option value="iodine">Iodine (Starch)</option>
          <option value="biuret">Biuret (Protein)</option>
          <option value="sudan">Sudan IV (Lipids)</option>
        </select>
      </div>
      <div>
        <label style="font-size:13px;font-weight:600;display:block;margin-bottom:6px;">Food Sample</label>
        <select class="form-select" id="sample-select">
          <option value="egg_white">Egg White</option>
          <option value="potato">Potato Extract</option>
          <option value="oil">Vegetable Oil</option>
          <option value="apple_juice">Apple Juice</option>
          <option value="milk">Milk</option>
          <option value="unknown">Unknown Sample</option>
        </select>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="runIndicatorTest()">Run Test</button>
      <button class="btn btn-outline" onclick="resetIndicatorTest()">Reset</button>
    </div>
    <div class="card-row">
      <div>
        <div class="chart-wrap"><canvas id="test-tube-canvas" height="300"></canvas></div>
      </div>
      <div>
        <div id="test-result-panel" class="analysis-result" style="min-height:100px;">
          <div class="ar-title">Test Result</div>
          <p style="color:var(--text-muted);">Select a reagent and sample, then click "Run Test" to see the reaction.</p>
        </div>
        <div style="margin-top:12px;">
          <div class="card-title" style="font-size:13px;">Positive/Negative Reference</div>
          <div id="reference-chart"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Results Log</div>
    <table class="results-table" id="indicator-log">
      <thead>
        <tr><th>Sample</th><th>Benedict's</th><th>Iodine</th><th>Biuret</th><th>Sudan IV</th></tr>
      </thead>
      <tbody id="indicator-log-body">
      </tbody>
    </table>
  </div>
</div>

<!-- ═══════════════════════ PART 2: MACROMOLECULE ID CARDS ════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Macromolecule ID Cards</div>
    <div class="section-subtitle">Click any card to flip between structure and function views</div></div>
  </div>
  <div class="card-row-4" id="macro-cards">
    <!-- Carbohydrates -->
    <div class="flip-card" onclick="this.classList.toggle('flipped')">
      <div class="flip-card-inner">
        <div class="flip-card-front" style="border-top:4px solid var(--accent);">
          <div class="card-title" style="color:var(--accent);">Carbohydrates</div>
          <div class="chart-wrap"><canvas id="carb-struct-canvas" height="120"></canvas></div>
          <div style="font-size:12px;margin-top:8px;">
            <p><strong>Monomer:</strong> Monosaccharides (glucose, fructose)</p>
            <p><strong>Polymer:</strong> Polysaccharides (starch, glycogen, cellulose)</p>
            <p><strong>Elements:</strong> C, H, O (1:2:1 ratio)</p>
          </div>
          <div class="flip-hint">Click to see functions &rarr;</div>
        </div>
        <div class="flip-card-back" style="border-top:4px solid var(--accent);">
          <div class="card-title" style="color:var(--accent);">Carbohydrates &mdash; Function</div>
          <div style="font-size:12px;">
            <p><strong>Primary Role:</strong> Quick energy source</p>
            <p><strong>Functions:</strong> Cellular respiration fuel, structural support (cellulose), energy storage (glycogen)</p>
            <p><strong>Food Sources:</strong> Bread, pasta, rice, fruits, potatoes</p>
            <p><strong>Daily Need:</strong> 225&ndash;325 g (45&ndash;65% of calories)</p>
            <p><strong>Calories:</strong> 4 kcal/g</p>
            <p><strong>Test:</strong> Benedict's (sugars), Iodine (starch)</p>
          </div>
          <div class="flip-hint">&larr; Click to see structure</div>
        </div>
      </div>
    </div>
    <!-- Lipids -->
    <div class="flip-card" onclick="this.classList.toggle('flipped')">
      <div class="flip-card-inner">
        <div class="flip-card-front" style="border-top:4px solid var(--amber);">
          <div class="card-title" style="color:var(--amber);">Lipids</div>
          <div class="chart-wrap"><canvas id="lipid-struct-canvas" height="120"></canvas></div>
          <div style="font-size:12px;margin-top:8px;">
            <p><strong>Monomer:</strong> Glycerol + Fatty acids</p>
            <p><strong>Polymer:</strong> Triglycerides, phospholipids</p>
            <p><strong>Elements:</strong> C, H, O (high H:O ratio)</p>
          </div>
          <div class="flip-hint">Click to see functions &rarr;</div>
        </div>
        <div class="flip-card-back" style="border-top:4px solid var(--amber);">
          <div class="card-title" style="color:var(--amber);">Lipids &mdash; Function</div>
          <div style="font-size:12px;">
            <p><strong>Primary Role:</strong> Long-term energy storage</p>
            <p><strong>Functions:</strong> Insulation, cell membrane structure, hormone production, organ protection</p>
            <p><strong>Food Sources:</strong> Butter, oils, nuts, avocado, fatty fish</p>
            <p><strong>Daily Need:</strong> 44&ndash;78 g (20&ndash;35% of calories)</p>
            <p><strong>Calories:</strong> 9 kcal/g</p>
            <p><strong>Test:</strong> Sudan IV (red-orange layer)</p>
          </div>
          <div class="flip-hint">&larr; Click to see structure</div>
        </div>
      </div>
    </div>
    <!-- Proteins -->
    <div class="flip-card" onclick="this.classList.toggle('flipped')">
      <div class="flip-card-inner">
        <div class="flip-card-front" style="border-top:4px solid var(--blue);">
          <div class="card-title" style="color:var(--blue);">Proteins</div>
          <div class="chart-wrap"><canvas id="protein-struct-canvas" height="120"></canvas></div>
          <div style="font-size:12px;margin-top:8px;">
            <p><strong>Monomer:</strong> Amino acids (20 types)</p>
            <p><strong>Polymer:</strong> Polypeptides</p>
            <p><strong>Elements:</strong> C, H, O, N (and sometimes S)</p>
          </div>
          <div class="flip-hint">Click to see functions &rarr;</div>
        </div>
        <div class="flip-card-back" style="border-top:4px solid var(--blue);">
          <div class="card-title" style="color:var(--blue);">Proteins &mdash; Function</div>
          <div style="font-size:12px;">
            <p><strong>Primary Role:</strong> Structure and catalysis</p>
            <p><strong>Functions:</strong> Enzymes, antibodies, structural support (keratin, collagen), transport (hemoglobin), signaling</p>
            <p><strong>Food Sources:</strong> Meat, eggs, beans, dairy, tofu</p>
            <p><strong>Daily Need:</strong> 46&ndash;56 g (10&ndash;35% of calories)</p>
            <p><strong>Calories:</strong> 4 kcal/g</p>
            <p><strong>Test:</strong> Biuret (purple/violet)</p>
          </div>
          <div class="flip-hint">&larr; Click to see structure</div>
        </div>
      </div>
    </div>
    <!-- Nucleic Acids -->
    <div class="flip-card" onclick="this.classList.toggle('flipped')">
      <div class="flip-card-inner">
        <div class="flip-card-front" style="border-top:4px solid var(--purple);">
          <div class="card-title" style="color:var(--purple);">Nucleic Acids</div>
          <div class="chart-wrap"><canvas id="na-struct-canvas" height="120"></canvas></div>
          <div style="font-size:12px;margin-top:8px;">
            <p><strong>Monomer:</strong> Nucleotides</p>
            <p><strong>Polymer:</strong> DNA, RNA</p>
            <p><strong>Elements:</strong> C, H, O, N, P</p>
          </div>
          <div class="flip-hint">Click to see functions &rarr;</div>
        </div>
        <div class="flip-card-back" style="border-top:4px solid var(--purple);">
          <div class="card-title" style="color:var(--purple);">Nucleic Acids &mdash; Function</div>
          <div style="font-size:12px;">
            <p><strong>Primary Role:</strong> Genetic information storage</p>
            <p><strong>Functions:</strong> DNA stores hereditary info, RNA assists in protein synthesis, ATP provides energy currency</p>
            <p><strong>Food Sources:</strong> All foods with cells (meat, fish, beans, grains)</p>
            <p><strong>Daily Need:</strong> Not an essential dietary macronutrient</p>
            <p><strong>Calories:</strong> Not counted (recycled)</p>
            <p><strong>Test:</strong> Dische (DNA) / Orcinol (RNA)</p>
          </div>
          <div class="flip-hint">&larr; Click to see structure</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 3: FOOD ANALYSIS LAB ════════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Food Analysis Lab</div>
    <div class="section-subtitle">Run all four indicator tests on common foods and compare macromolecule content</div></div>
  </div>
  <div class="card">
    <div class="card-title">Select Food &amp; Analyze</div>
    <div class="btn-group" id="food-buttons"></div>
    <div class="stat-grid" id="food-stats">
      <div class="stat-box stat-accent"><div class="stat-val" id="food-tested">0</div><div class="stat-label">Foods Tested</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="food-sugar-count">0</div><div class="stat-label">Contain Sugar</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="food-starch-count">0</div><div class="stat-label">Contain Starch</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="food-protein-count">0</div><div class="stat-label">Contain Protein</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="food-lipid-count">0</div><div class="stat-label">Contain Lipids</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Results Matrix</div>
    <table class="results-table" id="food-matrix">
      <thead>
        <tr><th>Food</th><th>Benedict's<br>(Sugar)</th><th>Iodine<br>(Starch)</th><th>Biuret<br>(Protein)</th><th>Sudan IV<br>(Lipids)</th><th>Primary Type</th></tr>
      </thead>
      <tbody id="food-matrix-body"></tbody>
    </table>
  </div>
  <div class="card">
    <div class="card-title">Macromolecule Composition Comparison</div>
    <div class="chart-wrap"><canvas id="food-comparison-chart" height="300"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Nutritional Breakdown</div>
    <div class="chart-wrap"><canvas id="food-nutrition-chart" height="260"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════ PART 4: ENZYME DIGESTION PATHWAY ════════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Enzyme Digestion Pathway</div>
    <div class="section-subtitle">Click organs in the digestive tract to see enzyme activity and nutrient absorption</div></div>
  </div>
  <div class="card">
    <div class="card-title">Human Digestive System</div>
    <div class="card-row">
      <div>
        <div class="chart-wrap"><canvas id="digestive-canvas" height="480"></canvas></div>
      </div>
      <div>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline" onclick="selectOrgan('mouth')">Mouth</button>
          <button class="btn btn-sm btn-outline" onclick="selectOrgan('stomach')">Stomach</button>
          <button class="btn btn-sm btn-outline" onclick="selectOrgan('small_intestine')">Small Intestine</button>
          <button class="btn btn-sm btn-outline" onclick="selectOrgan('large_intestine')">Large Intestine</button>
        </div>
        <div id="organ-info" class="organ-panel">
          <div class="op-title">Select an Organ</div>
          <p style="color:var(--text-muted);">Click an organ in the diagram or use the buttons above to learn about enzyme activity at each stage.</p>
        </div>
        <div class="card-title" style="margin-top:16px;">Digestion Progress</div>
        <div class="chart-wrap"><canvas id="digestion-progress-canvas" height="140"></canvas></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Nutrient Absorption Map</div>
    <div class="chart-wrap"><canvas id="absorption-canvas" height="200"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════ PART 5: NUTRITION CALCULATOR ════════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Nutrition Calculator</div>
    <div class="section-subtitle">Build a meal and analyze its macronutrient profile</div></div>
  </div>
  <div class="card">
    <div class="card-title">Meal Builder</div>
    <div class="card-row">
      <div>
        <label style="font-size:13px;font-weight:600;display:block;margin-bottom:6px;">Add Food to Meal</label>
        <select class="form-select" id="meal-food-select"></select>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="addToMeal()">Add to Meal</button>
          <button class="btn btn-outline" onclick="clearMeal()">Clear Meal</button>
        </div>
        <div id="meal-items-list" style="margin-top:8px;"></div>
      </div>
      <div>
        <div class="stat-grid">
          <div class="stat-box stat-accent"><div class="stat-val" id="meal-calories">0</div><div class="stat-label">Total Calories</div></div>
          <div class="stat-box stat-blue"><div class="stat-val" id="meal-carbs">0g</div><div class="stat-label">Carbs</div></div>
          <div class="stat-box stat-amber"><div class="stat-val" id="meal-protein">0g</div><div class="stat-label">Protein</div></div>
          <div class="stat-box stat-purple"><div class="stat-val" id="meal-fat">0g</div><div class="stat-label">Fat</div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Macronutrient Ratio</div>
      <div class="chart-wrap"><canvas id="meal-pie-chart" height="260"></canvas></div>
      <div class="convergence-info" style="justify-content:center;">
        <span><span class="ci-dot" style="background:var(--blue);"></span> Carbs</span>
        <span><span class="ci-dot" style="background:var(--amber);"></span> Protein</span>
        <span><span class="ci-dot" style="background:var(--purple);"></span> Fat</span>
      </div>
    </div>
    <div class="card">
      <div class="card-title">% Daily Value</div>
      <div class="chart-wrap"><canvas id="meal-dv-chart" height="260"></canvas></div>
      <p style="font-size:11px;color:var(--text-muted);margin-top:4px;">Based on 2,000 calorie diet. Recommended ratio: 50% carbs / 30% protein / 20% fat.</p>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Calorie Density by Food</div>
    <div class="chart-wrap"><canvas id="meal-density-chart" height="220"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════ PART 6: UNKNOWN SAMPLE CHALLENGE ════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Unknown Sample Challenge</div>
    <div class="section-subtitle">Test unknown samples, identify macromolecules, and score points</div></div>
  </div>
  <div class="card">
    <div class="card-title">Challenge Settings</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-outline btn-active" id="diff-easy" onclick="setDifficulty('easy')">Easy (Single)</button>
      <button class="btn btn-sm btn-outline" id="diff-medium" onclick="setDifficulty('medium')">Medium (Mixtures)</button>
      <button class="btn btn-sm btn-outline" id="diff-hard" onclick="setDifficulty('hard')">Hard (Complex)</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="generateUnknown()">New Sample</button>
    </div>
  </div>
  <div class="card" id="challenge-card" style="display:none;">
    <div class="card-title">Unknown Sample #<span id="challenge-num">1</span></div>
    <div class="card-row">
      <div>
        <div class="chart-wrap"><canvas id="challenge-tube-canvas" height="240"></canvas></div>
        <div class="btn-group" style="justify-content:center;">
          <button class="btn btn-sm btn-outline" onclick="runChallengeTest('benedicts')">Benedict's</button>
          <button class="btn btn-sm btn-outline" onclick="runChallengeTest('iodine')">Iodine</button>
          <button class="btn btn-sm btn-outline" onclick="runChallengeTest('biuret')">Biuret</button>
          <button class="btn btn-sm btn-outline" onclick="runChallengeTest('sudan')">Sudan IV</button>
        </div>
        <div id="challenge-test-results" style="margin-top:12px;"></div>
      </div>
      <div>
        <div class="card-title" style="font-size:13px;">Your Answer</div>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline" id="ans-sugar" onclick="toggleAnswer('sugar')">Simple Sugar</button>
          <button class="btn btn-sm btn-outline" id="ans-starch" onclick="toggleAnswer('starch')">Starch</button>
          <button class="btn btn-sm btn-outline" id="ans-protein" onclick="toggleAnswer('protein')">Protein</button>
          <button class="btn btn-sm btn-outline" id="ans-lipid" onclick="toggleAnswer('lipid')">Lipid</button>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
        </div>
        <div id="challenge-feedback" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="score-display">
        <div class="score-val" id="challenge-score">0</div>
        <div class="score-label">TOTAL SCORE</div>
      </div>
      <div class="stat-grid">
        <div class="stat-box stat-green"><div class="stat-val" id="challenge-correct">0</div><div class="stat-label">Correct</div></div>
        <div class="stat-box stat-accent"><div class="stat-val" id="challenge-wrong">0</div><div class="stat-label">Wrong</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="challenge-streak">0</div><div class="stat-label">Streak</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Score History</div>
      <div class="chart-wrap"><canvas id="challenge-history-chart" height="200"></canvas></div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// ── Utility ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

// ── Chart helper ─────────────────────────────────────────────────────────
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i % colors.length] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    // label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    // value on top
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 1 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  // expected line
  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  // ref line
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    // dots
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════
// DATA: Sample properties & food database
// ══════════════════════════════════════════════════════════════════════════
const SAMPLES = {
  egg_white: { name: 'Egg White', sugar: false, starch: false, protein: true, lipid: false },
  potato: { name: 'Potato Extract', sugar: false, starch: true, protein: false, lipid: false },
  oil: { name: 'Vegetable Oil', sugar: false, starch: false, protein: false, lipid: true },
  apple_juice: { name: 'Apple Juice', sugar: true, starch: false, protein: false, lipid: false },
  milk: { name: 'Milk', sugar: true, starch: false, protein: true, lipid: true },
  unknown: { name: 'Unknown', sugar: true, starch: true, protein: false, lipid: false }
};

const REAGENT_INFO = {
  benedicts: { name: "Benedict's", target: 'sugar', posColor: '#e85d04', negColor: '#2196f3',
    posText: 'Orange/red precipitate (positive for simple sugars)',
    negText: 'Remains blue (negative for simple sugars)' },
  iodine: { name: 'Iodine', target: 'starch', posColor: '#1a0533', negColor: '#d4a017',
    posText: 'Blue-black color (positive for starch)',
    negText: 'Remains amber/yellow (negative for starch)' },
  biuret: { name: 'Biuret', target: 'protein', posColor: '#7b2d8e', negColor: '#5bbcd6',
    posText: 'Purple/violet color (positive for protein)',
    negText: 'Remains light blue (negative for protein)' },
  sudan: { name: 'Sudan IV', target: 'lipid', posColor: '#ff4500', negColor: '#ffb347',
    posText: 'Red-orange layer at top (positive for lipids)',
    negText: 'No colored layer (negative for lipids)' }
};

const FOODS = {
  bread: { name: 'Bread', sugar: true, starch: true, protein: true, lipid: false, carbs: 49, protein_g: 9, fat: 3, cal: 265, serving: '100g' },
  steak: { name: 'Steak', sugar: false, starch: false, protein: true, lipid: true, carbs: 0, protein_g: 26, fat: 15, cal: 271, serving: '100g' },
  butter: { name: 'Butter', sugar: false, starch: false, protein: false, lipid: true, carbs: 0, protein_g: 1, fat: 81, cal: 717, serving: '100g' },
  apple: { name: 'Apple', sugar: true, starch: false, protein: false, lipid: false, carbs: 14, protein_g: 0, fat: 0, cal: 52, serving: '100g' },
  rice: { name: 'Rice (cooked)', sugar: false, starch: true, protein: false, lipid: false, carbs: 28, protein_g: 3, fat: 0, cal: 130, serving: '100g' },
  chicken: { name: 'Chicken Breast', sugar: false, starch: false, protein: true, lipid: false, carbs: 0, protein_g: 31, fat: 4, cal: 165, serving: '100g' },
  cheese: { name: 'Cheese', sugar: false, starch: false, protein: true, lipid: true, carbs: 1, protein_g: 25, fat: 33, cal: 402, serving: '100g' },
  banana: { name: 'Banana', sugar: true, starch: true, protein: false, lipid: false, carbs: 23, protein_g: 1, fat: 0, cal: 89, serving: '100g' },
  salmon: { name: 'Salmon', sugar: false, starch: false, protein: true, lipid: true, carbs: 0, protein_g: 20, fat: 13, cal: 208, serving: '100g' },
  pasta: { name: 'Pasta (cooked)', sugar: false, starch: true, protein: true, lipid: false, carbs: 31, protein_g: 5, fat: 1, cal: 131, serving: '100g' },
  avocado: { name: 'Avocado', sugar: false, starch: false, protein: false, lipid: true, carbs: 9, protein_g: 2, fat: 15, cal: 160, serving: '100g' },
  egg: { name: 'Whole Egg', sugar: false, starch: false, protein: true, lipid: true, carbs: 1, protein_g: 13, fat: 11, cal: 155, serving: '100g' },
  milk_food: { name: 'Whole Milk', sugar: true, starch: false, protein: true, lipid: true, carbs: 5, protein_g: 3, fat: 3, cal: 61, serving: '100ml' },
  orange_juice: { name: 'Orange Juice', sugar: true, starch: false, protein: false, lipid: false, carbs: 10, protein_g: 1, fat: 0, cal: 45, serving: '100ml' },
  nuts: { name: 'Mixed Nuts', sugar: false, starch: false, protein: true, lipid: true, carbs: 21, protein_g: 20, fat: 52, cal: 607, serving: '100g' },
  yogurt: { name: 'Yogurt', sugar: true, starch: false, protein: true, lipid: true, carbs: 7, protein_g: 10, fat: 5, cal: 100, serving: '100g' }
};

// ══════════════════════════════════════════════════════════════════════════
// PART 1: INDICATOR TEST VIRTUAL LAB
// ══════════════════════════════════════════════════════════════════════════
let indicatorLog = {};
let testAnimFrame = 0;
let testAnimating = false;
let currentTestResult = null;

function drawTestTube(ctx, fillColor, liquidLevel, label, animProgress) {
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W / 2, tubeW = 60, tubeH = 200;
  const tubeTop = 40, tubeBot = tubeTop + tubeH;

  // Tube outline
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx - tubeW/2, tubeTop);
  ctx.lineTo(cx - tubeW/2, tubeBot - 20);
  ctx.quadraticCurveTo(cx - tubeW/2, tubeBot, cx, tubeBot);
  ctx.quadraticCurveTo(cx + tubeW/2, tubeBot, cx + tubeW/2, tubeBot - 20);
  ctx.lineTo(cx + tubeW/2, tubeTop);
  ctx.stroke();

  // Rim
  ctx.fillStyle = '#e2e8f0';
  ctx.fillRect(cx - tubeW/2 - 4, tubeTop - 4, tubeW + 8, 8);
  ctx.strokeRect(cx - tubeW/2 - 4, tubeTop - 4, tubeW + 8, 8);

  // Liquid
  const liquidH = tubeH * liquidLevel * Math.min(animProgress, 1);
  const liquidTop = tubeBot - liquidH;
  if (liquidH > 0) {
    ctx.fillStyle = fillColor;
    ctx.beginPath();
    ctx.moveTo(cx - tubeW/2 + 2, liquidTop);
    ctx.lineTo(cx - tubeW/2 + 2, tubeBot - 20);
    ctx.quadraticCurveTo(cx - tubeW/2 + 2, tubeBot - 2, cx, tubeBot - 2);
    ctx.quadraticCurveTo(cx + tubeW/2 - 2, tubeBot - 2, cx + tubeW/2 - 2, tubeBot - 20);
    ctx.lineTo(cx + tubeW/2 - 2, liquidTop);
    ctx.closePath();
    ctx.fill();

    // Liquid surface highlight
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.beginPath();
    ctx.ellipse(cx, liquidTop, tubeW/2 - 4, 4, 0, 0, Math.PI * 2);
    ctx.fill();

    // Bubbles during animation
    if (animProgress < 1 && animProgress > 0.1) {
      for (let i = 0; i < 5; i++) {
        const bx = cx + (Math.random() - 0.5) * (tubeW - 20);
        const by = liquidTop + Math.random() * (liquidH - 10);
        const br = 2 + Math.random() * 3;
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.beginPath(); ctx.arc(bx, by, br, 0, Math.PI * 2); ctx.fill();
      }
    }
  }

  // Label below tube
  if (label) {
    ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(label, cx, tubeBot + 30);
  }
}

function runIndicatorTest() {
  const reagentKey = $('reagent-select').value;
  const sampleKey = $('sample-select').value;
  const reagent = REAGENT_INFO[reagentKey];
  const sample = SAMPLES[sampleKey];
  const isPositive = sample[reagent.target];
  const resultColor = isPositive ? reagent.posColor : reagent.negColor;

  currentTestResult = { reagent: reagentKey, sample: sampleKey, positive: isPositive, color: resultColor };

  // Log result
  if (!indicatorLog[sampleKey]) indicatorLog[sampleKey] = {};
  indicatorLog[sampleKey][reagentKey] = isPositive;

  // Animate
  testAnimating = true;
  testAnimFrame = 0;
  animateTest();

  // Update result panel
  const panel = $('test-result-panel');
  panel.className = 'analysis-result ' + (isPositive ? 'ar-pass' : 'ar-fail');
  panel.innerHTML = `
    <div class="ar-title">${reagent.name} Test on ${sample.name}</div>
    <p><strong>Result:</strong> ${isPositive ? 'POSITIVE' : 'NEGATIVE'}</p>
    <p>${isPositive ? reagent.posText : reagent.negText}</p>
    <p style="margin-top:8px;"><strong>Interpretation:</strong> ${isPositive ? sample.name + ' contains ' + reagent.target + '.' : sample.name + ' does not contain detectable ' + reagent.target + '.'}</p>
  `;

  // Update log table
  updateIndicatorLog();

  // Update reference
  updateReferenceChart();
}

function animateTest() {
  if (!testAnimating) return;
  testAnimFrame += 0.03;
  const ctx = getCtx('test-tube-canvas');
  const progress = Math.min(testAnimFrame, 1);
  const reagent = REAGENT_INFO[currentTestResult.reagent];
  const sample = SAMPLES[currentTestResult.sample];

  // Interpolate color from initial to final
  const startColor = '#dbeafe'; // light blue starting
  const endColor = currentTestResult.color;
  const fillColor = progress < 0.5 ? startColor : endColor;

  drawTestTube(ctx, fillColor, 0.6, sample.name + ' + ' + reagent.name, progress);

  if (progress < 1) {
    requestAnimationFrame(animateTest);
  } else {
    testAnimating = false;
  }
}

function resetIndicatorTest() {
  currentTestResult = null;
  testAnimating = false;
  const ctx = getCtx('test-tube-canvas');
  drawTestTube(ctx, '#dbeafe', 0.3, 'Ready', 1);
  $('test-result-panel').className = 'analysis-result';
  $('test-result-panel').innerHTML = '<div class="ar-title">Test Result</div><p style="color:var(--text-muted);">Select a reagent and sample, then click "Run Test".</p>';
}

function updateIndicatorLog() {
  const body = $('indicator-log-body');
  let html = '';
  for (const [sampleKey, results] of Object.entries(indicatorLog)) {
    const sample = SAMPLES[sampleKey];
    html += '<tr>';
    html += `<td class="sample-name">${sample.name}</td>`;
    ['benedicts', 'iodine', 'biuret', 'sudan'].forEach(r => {
      if (results[r] !== undefined) {
        html += `<td class="${results[r] ? 'pos' : 'neg'}">${results[r] ? '+' : '-'}</td>`;
      } else {
        html += '<td>--</td>';
      }
    });
    html += '</tr>';
  }
  body.innerHTML = html;
}

function updateReferenceChart() {
  const container = $('reference-chart');
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">';
  for (const [key, r] of Object.entries(REAGENT_INFO)) {
    html += `<div style="padding:6px;border-radius:4px;border:1px solid var(--border);">
      <strong>${r.name}</strong><br>
      <span style="display:inline-block;width:12px;height:12px;border-radius:2px;background:${r.posColor};vertical-align:middle;"></span> Positive<br>
      <span style="display:inline-block;width:12px;height:12px;border-radius:2px;background:${r.negColor};vertical-align:middle;"></span> Negative
    </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: MACROMOLECULE STRUCTURE CANVASES
// ══════════════════════════════════════════════════════════════════════════
function drawMoleculeStructures() {
  // Carbohydrate - hexagonal glucose ring
  const ctx1 = getCtx('carb-struct-canvas');
  const W1 = ctx1.W, H1 = ctx1.H;
  ctx1.clearRect(0, 0, W1, H1);
  ctx1.fillStyle = '#fff5f5'; ctx1.fillRect(0, 0, W1, H1);
  const cx1 = W1/2, cy1 = H1/2;
  // Draw glucose ring
  ctx1.strokeStyle = '#c41e3a'; ctx1.lineWidth = 2;
  const r1 = 30;
  for (let ring = -1; ring <= 1; ring++) {
    const ox = cx1 + ring * 55;
    ctx1.beginPath();
    for (let i = 0; i < 6; i++) {
      const angle = (Math.PI / 3) * i - Math.PI / 6;
      const x = ox + r1 * Math.cos(angle);
      const y = cy1 + r1 * Math.sin(angle);
      i === 0 ? ctx1.moveTo(x, y) : ctx1.lineTo(x, y);
    }
    ctx1.closePath(); ctx1.stroke();
    // O in ring
    ctx1.fillStyle = '#c41e3a'; ctx1.font = 'bold 10px system-ui'; ctx1.textAlign = 'center';
    ctx1.fillText('O', ox + r1 * Math.cos(Math.PI/2), cy1 + r1 * Math.sin(Math.PI/2) - 4);
    // OH groups
    for (let i = 0; i < 4; i++) {
      const angle = (Math.PI / 3) * i - Math.PI / 6;
      const x = ox + (r1 + 12) * Math.cos(angle);
      const y = cy1 + (r1 + 12) * Math.sin(angle);
      ctx1.fillStyle = '#9ca3af'; ctx1.font = '8px system-ui';
      ctx1.fillText('OH', x, y);
    }
    // Connect rings
    if (ring < 1) {
      ctx1.strokeStyle = '#c41e3a'; ctx1.lineWidth = 2;
      ctx1.beginPath();
      ctx1.moveTo(ox + r1 * Math.cos(-Math.PI/6), cy1 + r1 * Math.sin(-Math.PI/6));
      ctx1.lineTo(ox + 55 + r1 * Math.cos(5*Math.PI/6), cy1 + r1 * Math.sin(5*Math.PI/6));
      ctx1.stroke();
    }
  }
  ctx1.fillStyle = '#c41e3a'; ctx1.font = 'bold 10px system-ui'; ctx1.textAlign = 'center';
  ctx1.fillText('Polysaccharide Chain', cx1, H1 - 8);

  // Lipid - glycerol + fatty acid tails
  const ctx2 = getCtx('lipid-struct-canvas');
  const W2 = ctx2.W, H2 = ctx2.H;
  ctx2.clearRect(0, 0, W2, H2);
  ctx2.fillStyle = '#fffbeb'; ctx2.fillRect(0, 0, W2, H2);
  // Glycerol backbone
  ctx2.fillStyle = '#d97706'; ctx2.font = 'bold 10px system-ui'; ctx2.textAlign = 'center';
  const gx = 40;
  for (let i = 0; i < 3; i++) {
    const gy = 25 + i * 35;
    ctx2.fillStyle = '#d97706';
    ctx2.beginPath(); ctx2.arc(gx, gy, 8, 0, Math.PI * 2); ctx2.fill();
    ctx2.fillStyle = '#fff'; ctx2.font = 'bold 8px system-ui';
    ctx2.fillText('C', gx, gy + 3);
    // Fatty acid chain (zigzag)
    ctx2.strokeStyle = '#ea580c'; ctx2.lineWidth = 2;
    ctx2.beginPath();
    ctx2.moveTo(gx + 8, gy);
    for (let j = 0; j < 8; j++) {
      const fx = gx + 20 + j * 18;
      const fy = gy + (j % 2 === 0 ? -8 : 8);
      ctx2.lineTo(fx, fy);
    }
    ctx2.stroke();
  }
  ctx2.fillStyle = '#d97706'; ctx2.font = 'bold 10px system-ui'; ctx2.textAlign = 'left';
  ctx2.fillText('Glycerol', 6, H2 - 6);
  ctx2.fillStyle = '#ea580c'; ctx2.textAlign = 'right';
  ctx2.fillText('Fatty acid tails', W2 - 6, H2 - 6);

  // Protein - amino acid chain
  const ctx3 = getCtx('protein-struct-canvas');
  const W3 = ctx3.W, H3 = ctx3.H;
  ctx3.clearRect(0, 0, W3, H3);
  ctx3.fillStyle = '#eff6ff'; ctx3.fillRect(0, 0, W3, H3);
  const aaColors = ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#2563eb', '#3b82f6'];
  // Draw alpha helix
  const helixCx = W3/2, helixCy = H3/2 - 5;
  for (let i = 0; i < 12; i++) {
    const t = i / 12 * Math.PI * 3;
    const x = helixCx - 50 + i * (W3 - 40) / 12;
    const y = helixCy + Math.sin(t) * 25;
    const sz = 8 + Math.cos(t) * 3;
    ctx3.fillStyle = aaColors[i % aaColors.length];
    ctx3.globalAlpha = 0.6 + Math.cos(t) * 0.4;
    ctx3.beginPath(); ctx3.arc(x, y, sz, 0, Math.PI * 2); ctx3.fill();
    ctx3.globalAlpha = 1;
    if (i < 11) {
      const nx = helixCx - 50 + (i + 1) * (W3 - 40) / 12;
      const ny = helixCy + Math.sin((i + 1) / 12 * Math.PI * 3) * 25;
      ctx3.strokeStyle = '#93c5fd'; ctx3.lineWidth = 1.5;
      ctx3.beginPath(); ctx3.moveTo(x, y); ctx3.lineTo(nx, ny); ctx3.stroke();
    }
  }
  ctx3.fillStyle = '#2563eb'; ctx3.font = 'bold 10px system-ui'; ctx3.textAlign = 'center';
  ctx3.fillText('Polypeptide (alpha helix)', W3/2, H3 - 6);

  // Nucleic Acid - double helix
  const ctx4 = getCtx('na-struct-canvas');
  const W4 = ctx4.W, H4 = ctx4.H;
  ctx4.clearRect(0, 0, W4, H4);
  ctx4.fillStyle = '#f5f3ff'; ctx4.fillRect(0, 0, W4, H4);
  const helixW = W4 - 40;
  // Draw two intertwining strands
  for (let strand = 0; strand < 2; strand++) {
    const phase = strand * Math.PI;
    ctx4.strokeStyle = strand === 0 ? '#7c3aed' : '#a78bfa';
    ctx4.lineWidth = 2.5;
    ctx4.beginPath();
    for (let i = 0; i <= 60; i++) {
      const t = i / 60 * Math.PI * 3;
      const x = 20 + (i / 60) * helixW;
      const y = H4/2 - 5 + Math.sin(t + phase) * 25;
      i === 0 ? ctx4.moveTo(x, y) : ctx4.lineTo(x, y);
    }
    ctx4.stroke();
  }
  // Base pair rungs
  for (let i = 0; i < 8; i++) {
    const t = (i + 0.5) / 8 * Math.PI * 3;
    const x = 20 + ((i + 0.5) / 8) * helixW;
    const y1 = H4/2 - 5 + Math.sin(t) * 25;
    const y2 = H4/2 - 5 + Math.sin(t + Math.PI) * 25;
    if (Math.cos(t) > -0.3) {
      ctx4.strokeStyle = '#c4b5fd'; ctx4.lineWidth = 1.5;
      ctx4.beginPath(); ctx4.moveTo(x, y1); ctx4.lineTo(x, y2); ctx4.stroke();
      // Base pair dots
      const pairs = ['A-T', 'G-C', 'T-A', 'C-G'];
      ctx4.fillStyle = '#7c3aed'; ctx4.font = '7px system-ui'; ctx4.textAlign = 'center';
      ctx4.fillText(pairs[i % 4], x, (y1 + y2) / 2 + 3);
    }
  }
  ctx4.fillStyle = '#7c3aed'; ctx4.font = 'bold 10px system-ui'; ctx4.textAlign = 'center';
  ctx4.fillText('DNA Double Helix', W4/2, H4 - 6);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 3: FOOD ANALYSIS LAB
// ══════════════════════════════════════════════════════════════════════════
let foodTestedList = [];

function buildFoodButtons() {
  const container = $('food-buttons');
  let html = '';
  for (const [key, food] of Object.entries(FOODS)) {
    html += `<button class="btn btn-sm btn-outline" onclick="testFood('${key}')">${food.name}</button>`;
  }
  container.innerHTML = html;
}

function testFood(key) {
  if (foodTestedList.find(f => f.key === key)) return;
  const food = FOODS[key];
  foodTestedList.push({ key, ...food });
  updateFoodMatrix();
  updateFoodStats();
  drawFoodComparisonChart();
  drawFoodNutritionChart();
}

function updateFoodMatrix() {
  const body = $('food-matrix-body');
  let html = '';
  foodTestedList.forEach(f => {
    const primary = [];
    if (f.carbs > 15) primary.push('Carbohydrate');
    if (f.protein_g > 10) primary.push('Protein');
    if (f.fat > 10) primary.push('Lipid');
    if (primary.length === 0) primary.push(f.carbs >= f.protein_g && f.carbs >= f.fat ? 'Carbohydrate' : f.protein_g >= f.fat ? 'Protein' : 'Lipid');
    html += '<tr>';
    html += `<td class="sample-name">${f.name}</td>`;
    html += `<td class="${f.sugar ? 'pos' : 'neg'}">${f.sugar ? '+' : '-'}</td>`;
    html += `<td class="${f.starch ? 'pos' : 'neg'}">${f.starch ? '+' : '-'}</td>`;
    html += `<td class="${f.protein ? 'pos' : 'neg'}">${f.protein ? '+' : '-'}</td>`;
    html += `<td class="${f.lipid ? 'pos' : 'neg'}">${f.lipid ? '+' : '-'}</td>`;
    html += `<td>${primary.join(', ')}</td>`;
    html += '</tr>';
  });
  body.innerHTML = html;
}

function updateFoodStats() {
  $('food-tested').textContent = foodTestedList.length;
  $('food-sugar-count').textContent = foodTestedList.filter(f => f.sugar).length;
  $('food-starch-count').textContent = foodTestedList.filter(f => f.starch).length;
  $('food-protein-count').textContent = foodTestedList.filter(f => f.protein).length;
  $('food-lipid-count').textContent = foodTestedList.filter(f => f.lipid).length;
}

function drawFoodComparisonChart() {
  if (!foodTestedList.length) return;
  const ctx = getCtx('food-comparison-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 20, bottom: 60, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const n = foodTestedList.length;
  const groupW = plotW / n;
  const barW = groupW * 0.2;
  const maxVal = Math.max(...foodTestedList.map(f => Math.max(f.carbs, f.protein_g, f.fat))) * 1.3 || 10;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxVal * i / 4).toFixed(0) + 'g', pad.left - 6, y + 4);
  }

  const barColors = ['#2563eb', '#d97706', '#7c3aed'];
  foodTestedList.forEach((f, i) => {
    const gx = pad.left + groupW * i;
    [f.carbs, f.protein_g, f.fat].forEach((v, j) => {
      const x = gx + groupW * 0.1 + j * (barW + 2);
      const h = (v / maxVal) * plotH;
      ctx.fillStyle = barColors[j];
      ctx.fillRect(x, pad.top + plotH - h, barW, h);
      if (v > 0 && barW > 10) {
        ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
        ctx.fillText(v, x + barW/2, pad.top + plotH - h - 4);
      }
    });
    // Food label
    ctx.save();
    ctx.translate(gx + groupW/2, H - pad.bottom + 12);
    ctx.rotate(-0.4);
    ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText(f.name, 0, 0);
    ctx.restore();
  });

  // Legend
  ctx.fillStyle = '#2563eb'; ctx.fillRect(pad.left, 6, 12, 12);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Carbs', pad.left + 16, 16);
  ctx.fillStyle = '#d97706'; ctx.fillRect(pad.left + 60, 6, 12, 12);
  ctx.fillText('Protein', pad.left + 76, 16);
  ctx.fillStyle = '#7c3aed'; ctx.fillRect(pad.left + 130, 6, 12, 12);
  ctx.fillText('Fat', pad.left + 146, 16);
}

function drawFoodNutritionChart() {
  if (!foodTestedList.length) return;
  const ctx = getCtx('food-nutrition-chart');
  const labels = foodTestedList.map(f => f.name);
  const values = foodTestedList.map(f => f.cal);
  const colors = foodTestedList.map(f => {
    if (f.fat > f.carbs && f.fat > f.protein_g) return '#7c3aed';
    if (f.protein_g > f.carbs) return '#d97706';
    return '#2563eb';
  });
  drawBarChart(ctx, {
    labels, values, colors,
    maxVal: Math.max(...values) * 1.3 || 100
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 4: ENZYME DIGESTION PATHWAY
// ══════════════════════════════════════════════════════════════════════════
let selectedOrgan = null;
let digestAnimFrame = 0;
let digestAnimating = false;

const ORGANS = {
  mouth: {
    name: 'Mouth (Oral Cavity)',
    enzymes: [{ name: 'Salivary Amylase', substrate: 'Starch', product: 'Maltose (disaccharide)', color: '#c41e3a' }],
    desc: 'Mechanical digestion (chewing) and chemical digestion begin here. Salivary amylase breaks starch into smaller sugar fragments.',
    y: 0.08, h: 0.08
  },
  stomach: {
    name: 'Stomach',
    enzymes: [
      { name: 'Pepsin', substrate: 'Proteins', product: 'Peptide fragments', color: '#2563eb' },
      { name: 'HCl (pH ~2)', substrate: 'Denatures proteins', product: 'Unfolded polypeptides', color: '#7c3aed' }
    ],
    desc: 'Highly acidic environment (pH 1.5-3.5). Pepsin begins protein digestion. Gastric lipase starts minor fat digestion.',
    y: 0.22, h: 0.14
  },
  small_intestine: {
    name: 'Small Intestine',
    enzymes: [
      { name: 'Pancreatic Amylase', substrate: 'Remaining starch', product: 'Maltose, glucose', color: '#c41e3a' },
      { name: 'Trypsin & Chymotrypsin', substrate: 'Peptide fragments', product: 'Amino acids', color: '#2563eb' },
      { name: 'Pancreatic Lipase', substrate: 'Triglycerides', product: 'Fatty acids + glycerol', color: '#d97706' },
      { name: 'Maltase, Sucrase, Lactase', substrate: 'Disaccharides', product: 'Monosaccharides', color: '#16a34a' }
    ],
    desc: 'Primary site of chemical digestion and nutrient absorption. Bile from the liver emulsifies fats. The vast surface area (villi/microvilli) maximizes absorption.',
    y: 0.42, h: 0.25
  },
  large_intestine: {
    name: 'Large Intestine (Colon)',
    enzymes: [
      { name: 'Bacterial enzymes', substrate: 'Fiber, remaining nutrients', product: 'Short-chain fatty acids, vitamins (K, B)', color: '#16a34a' }
    ],
    desc: 'Water absorption and electrolyte balance. Gut bacteria ferment remaining fiber. Vitamins K and some B vitamins are produced. Waste is compacted.',
    y: 0.72, h: 0.15
  }
};

function drawDigestiveSystem() {
  const ctx = getCtx('digestive-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const cx = W / 2;

  // Draw simplified digestive tract
  const organDefs = [
    { key: 'mouth', label: 'Mouth', y: H * 0.08, w: 50, h: H * 0.06, color: '#fecaca', border: '#dc2626' },
    { key: 'esophagus', label: '', y: H * 0.14, w: 14, h: H * 0.08, color: '#e5e7eb', border: '#9ca3af' },
    { key: 'stomach', label: 'Stomach', y: H * 0.22, w: 70, h: H * 0.14, color: '#dbeafe', border: '#2563eb' },
    { key: 'si_connect', label: '', y: H * 0.36, w: 14, h: H * 0.06, color: '#e5e7eb', border: '#9ca3af' },
    { key: 'small_intestine', label: 'Small Intestine', y: H * 0.42, w: 90, h: H * 0.25, color: '#fef3c7', border: '#d97706' },
    { key: 'li_connect', label: '', y: H * 0.67, w: 14, h: H * 0.05, color: '#e5e7eb', border: '#9ca3af' },
    { key: 'large_intestine', label: 'Large Intestine', y: H * 0.72, w: 80, h: H * 0.15, color: '#f0fdf4', border: '#16a34a' }
  ];

  organDefs.forEach(o => {
    const isSelected = selectedOrgan === o.key;
    ctx.fillStyle = isSelected ? o.border + '30' : o.color;
    ctx.strokeStyle = o.border;
    ctx.lineWidth = isSelected ? 3 : 1.5;

    if (o.key === 'stomach') {
      // Curved stomach shape
      ctx.beginPath();
      ctx.moveTo(cx - 10, o.y);
      ctx.quadraticCurveTo(cx - o.w/2, o.y + o.h * 0.3, cx - o.w/2 + 10, o.y + o.h);
      ctx.quadraticCurveTo(cx, o.y + o.h + 15, cx + o.w/2 - 20, o.y + o.h - 10);
      ctx.quadraticCurveTo(cx + o.w/2, o.y + o.h * 0.5, cx + 10, o.y);
      ctx.closePath();
      ctx.fill(); ctx.stroke();
    } else if (o.key === 'small_intestine') {
      // Winding intestine
      ctx.beginPath();
      const startY = o.y;
      for (let i = 0; i < 6; i++) {
        const segY = startY + (o.h / 6) * i;
        const dir = i % 2 === 0 ? 1 : -1;
        if (i === 0) ctx.moveTo(cx, segY);
        ctx.quadraticCurveTo(cx + dir * o.w/2, segY + o.h/12, cx, segY + o.h/6);
      }
      ctx.strokeStyle = o.border; ctx.lineWidth = isSelected ? 16 : 12;
      ctx.lineCap = 'round'; ctx.stroke();
      ctx.strokeStyle = isSelected ? '#fef3c780' : o.color; ctx.lineWidth = isSelected ? 12 : 8;
      ctx.stroke();
      ctx.lineCap = 'butt';
    } else if (o.key === 'large_intestine') {
      // U-shape colon
      ctx.beginPath();
      ctx.moveTo(cx, o.y);
      ctx.lineTo(cx + o.w/2, o.y);
      ctx.quadraticCurveTo(cx + o.w/2 + 10, o.y + o.h/2, cx + o.w/2, o.y + o.h);
      ctx.lineTo(cx - o.w/2, o.y + o.h);
      ctx.quadraticCurveTo(cx - o.w/2 - 10, o.y + o.h/2, cx - o.w/2, o.y);
      ctx.lineTo(cx, o.y);
      ctx.strokeStyle = o.border; ctx.lineWidth = isSelected ? 14 : 10;
      ctx.lineCap = 'round'; ctx.stroke();
      ctx.strokeStyle = isSelected ? '#f0fdf480' : o.color; ctx.lineWidth = isSelected ? 10 : 6;
      ctx.stroke();
      ctx.lineCap = 'butt';
    } else if (o.key === 'mouth') {
      ctx.beginPath();
      ctx.ellipse(cx, o.y + o.h/2, o.w/2, o.h/2, 0, 0, Math.PI * 2);
      ctx.fill(); ctx.stroke();
    } else {
      // Connecting tubes
      ctx.beginPath();
      ctx.moveTo(cx - o.w/2, o.y);
      ctx.lineTo(cx + o.w/2, o.y);
      ctx.lineTo(cx + o.w/2, o.y + o.h);
      ctx.lineTo(cx - o.w/2, o.y + o.h);
      ctx.closePath();
      ctx.fill(); ctx.stroke();
    }

    // Label
    if (o.label) {
      ctx.fillStyle = isSelected ? o.border : '#374151';
      ctx.font = (isSelected ? 'bold ' : '') + '12px system-ui';
      ctx.textAlign = 'left';
      const labelX = cx + (o.key === 'mouth' ? 35 : o.key === 'stomach' ? 50 : o.key === 'large_intestine' ? 55 : 60);
      ctx.fillText(o.label, labelX, o.y + o.h/2 + 4);
    }

    // Highlight selected with glow
    if (isSelected && ORGANS[o.key]) {
      ctx.shadowColor = o.border; ctx.shadowBlur = 15;
      ctx.strokeStyle = o.border; ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx - o.w/2 - 15, o.y + o.h/2, 6, 0, Math.PI * 2);
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
  });

  // Food particle animation
  if (digestAnimating && selectedOrgan) {
    const organ = ORGANS[selectedOrgan];
    const orgY = organ.y * H;
    const orgH = organ.h * H;
    for (let i = 0; i < 6; i++) {
      const px = cx + (Math.random() - 0.5) * 40;
      const py = orgY + Math.random() * orgH;
      const colors = ['#c41e3a', '#2563eb', '#d97706', '#16a34a'];
      ctx.fillStyle = colors[i % 4];
      ctx.globalAlpha = 0.6;
      ctx.beginPath();
      ctx.arc(px, py, 3 + Math.random() * 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // Make clickable
  ctx.canvas.onclick = function(e) {
    const rect = ctx.canvas.getBoundingClientRect();
    const scaleY = H / rect.height;
    const clickY = (e.clientY - rect.top) * scaleY;
    const normalizedY = clickY / H;

    if (normalizedY < 0.14) selectOrgan('mouth');
    else if (normalizedY < 0.36) selectOrgan('stomach');
    else if (normalizedY < 0.67) selectOrgan('small_intestine');
    else selectOrgan('large_intestine');
  };
  ctx.canvas.style.cursor = 'pointer';
}

function selectOrgan(key) {
  selectedOrgan = key;
  const organ = ORGANS[key];
  drawDigestiveSystem();

  const panel = $('organ-info');
  let enzymeHtml = '';
  organ.enzymes.forEach(e => {
    enzymeHtml += `<div style="margin:8px 0;padding:8px;background:#fff;border-radius:6px;border-left:3px solid ${e.color};">
      <span class="op-enzyme">${e.name}</span><br>
      <span class="op-substrate">${e.substrate}</span> &rarr; <span class="op-product">${e.product}</span>
    </div>`;
  });
  panel.innerHTML = `
    <div class="op-title">${organ.name}</div>
    <p style="margin:8px 0;color:var(--text-muted);font-size:13px;">${organ.desc}</p>
    ${enzymeHtml}
  `;

  drawDigestionProgress();

  // Start animation
  digestAnimating = true;
  digestAnimFrame = 0;
  animateDigestion();
}

function animateDigestion() {
  if (!digestAnimating) return;
  digestAnimFrame++;
  if (digestAnimFrame > 30) {
    digestAnimating = false;
    drawDigestiveSystem();
    return;
  }
  drawDigestiveSystem();
  requestAnimationFrame(animateDigestion);
}

function drawDigestionProgress() {
  const ctx = getCtx('digestion-progress-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const stages = ['mouth', 'stomach', 'small_intestine', 'large_intestine'];
  const labels = ['Mouth', 'Stomach', 'Sm. Intestine', 'Lg. Intestine'];
  const progress = { mouth: [0.9, 1.0, 1.0], stomach: [0.9, 0.5, 0.95], small_intestine: [0.1, 0.05, 0.1], large_intestine: [0.05, 0.02, 0.05] };
  const macroColors = ['#c41e3a', '#2563eb', '#d97706']; // carbs, proteins, lipids
  const macroLabels = ['Carbs', 'Protein', 'Lipids'];

  const pad = { top: 25, right: 20, bottom: 25, left: 90 };
  const plotW = W - pad.left - pad.right;
  const barH = 10;
  const groupH = (H - pad.top - pad.bottom) / stages.length;

  // Legend
  macroLabels.forEach((ml, mi) => {
    ctx.fillStyle = macroColors[mi];
    ctx.fillRect(pad.left + mi * 70, 6, 10, 10);
    ctx.fillStyle = '#374151'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
    ctx.fillText(ml, pad.left + mi * 70 + 14, 15);
  });

  const selectedIdx = stages.indexOf(selectedOrgan);

  stages.forEach((stage, si) => {
    const gy = pad.top + si * groupH;
    const isActive = si <= selectedIdx;

    ctx.fillStyle = isActive ? '#374151' : '#9ca3af';
    ctx.font = (si === selectedIdx ? 'bold ' : '') + '11px system-ui';
    ctx.textAlign = 'right';
    ctx.fillText(labels[si], pad.left - 8, gy + groupH / 2 + 4);

    // Draw remaining amount bars
    macroColors.forEach((color, mi) => {
      const by = gy + 8 + mi * (barH + 3);
      const remaining = isActive ? progress[stage][mi] : 1.0;
      const w = remaining * plotW;
      ctx.fillStyle = '#e5e7eb';
      ctx.fillRect(pad.left, by, plotW, barH);
      ctx.fillStyle = color;
      ctx.globalAlpha = isActive ? 0.8 : 0.2;
      ctx.fillRect(pad.left, by, w, barH);
      ctx.globalAlpha = 1;
    });
  });
}

function drawAbsorptionCanvas() {
  const ctx = getCtx('absorption-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const pad = { top: 30, right: 20, bottom: 40, left: 110 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;

  const nutrients = [
    { name: 'Glucose', site: 'Small Intestine (duodenum)', pct: 95, color: '#c41e3a' },
    { name: 'Amino Acids', site: 'Small Intestine (jejunum)', pct: 90, color: '#2563eb' },
    { name: 'Fatty Acids', site: 'Small Intestine (jejunum)', pct: 85, color: '#d97706' },
    { name: 'Vitamins (A,D,E,K)', site: 'Small Intestine (ileum)', pct: 80, color: '#7c3aed' },
    { name: 'Water', site: 'Large Intestine', pct: 70, color: '#16a34a' },
    { name: 'Vitamin B12', site: 'Small Intestine (ileum)', pct: 60, color: '#0891b2' }
  ];

  const barH = plotH / nutrients.length * 0.65;
  const gap = plotH / nutrients.length * 0.35;

  // Title
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Nutrient', pad.left - 105, 18);
  ctx.textAlign = 'center';
  ctx.fillText('Absorption Efficiency', pad.left + plotW / 2, 18);

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const x = pad.left + (plotW * i / 4);
    ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, H - pad.bottom); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText((i * 25) + '%', x, H - pad.bottom + 14);
  }

  nutrients.forEach((n, i) => {
    const y = pad.top + i * (barH + gap);
    const w = (n.pct / 100) * plotW;

    // Label
    ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(n.name, pad.left - 8, y + barH / 2 + 4);

    // Bar background
    ctx.fillStyle = '#e5e7eb';
    ctx.fillRect(pad.left, y, plotW, barH);

    // Bar fill
    ctx.fillStyle = n.color;
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(pad.left, y);
    ctx.lineTo(pad.left + w - r, y);
    ctx.quadraticCurveTo(pad.left + w, y, pad.left + w, y + r);
    ctx.lineTo(pad.left + w, y + barH - r);
    ctx.quadraticCurveTo(pad.left + w, y + barH, pad.left + w - r, y + barH);
    ctx.lineTo(pad.left, y + barH);
    ctx.closePath();
    ctx.fill();

    // Percentage
    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'right';
    if (w > 30) ctx.fillText(n.pct + '%', pad.left + w - 6, y + barH / 2 + 4);
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 5: NUTRITION CALCULATOR
// ══════════════════════════════════════════════════════════════════════════
let mealItems = [];

function buildMealSelect() {
  const sel = $('meal-food-select');
  let html = '';
  for (const [key, food] of Object.entries(FOODS)) {
    html += `<option value="${key}">${food.name} (${food.cal} cal/${food.serving})</option>`;
  }
  sel.innerHTML = html;
}

function addToMeal() {
  const key = $('meal-food-select').value;
  const food = FOODS[key];
  mealItems.push({ key, ...food });
  updateMealUI();
}

function removeFromMeal(idx) {
  mealItems.splice(idx, 1);
  updateMealUI();
}

function clearMeal() {
  mealItems = [];
  updateMealUI();
}

function updateMealUI() {
  // Items list
  const list = $('meal-items-list');
  let html = '';
  mealItems.forEach((item, i) => {
    html += `<div class="meal-item">
      <span class="mi-name">${item.name}</span>
      <span class="mi-cal">${item.cal} cal</span>
      <span class="mi-remove" onclick="removeFromMeal(${i})">x</span>
    </div>`;
  });
  list.innerHTML = html || '<p style="font-size:13px;color:var(--text-muted);">No foods added yet.</p>';

  // Totals
  const totalCal = mealItems.reduce((s, f) => s + f.cal, 0);
  const totalCarbs = mealItems.reduce((s, f) => s + f.carbs, 0);
  const totalProtein = mealItems.reduce((s, f) => s + f.protein_g, 0);
  const totalFat = mealItems.reduce((s, f) => s + f.fat, 0);

  $('meal-calories').textContent = totalCal;
  $('meal-carbs').textContent = totalCarbs + 'g';
  $('meal-protein').textContent = totalProtein + 'g';
  $('meal-fat').textContent = totalFat + 'g';

  drawMealPieChart(totalCarbs, totalProtein, totalFat);
  drawMealDVChart(totalCal, totalCarbs, totalProtein, totalFat);
  drawMealDensityChart();
}

function drawMealPieChart(carbs, protein, fat) {
  const ctx = getCtx('meal-pie-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const total = carbs * 4 + protein * 4 + fat * 9;
  if (total === 0) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Add foods to see macronutrient ratio', W / 2, H / 2);
    return;
  }

  const cx = W / 2, cy = H / 2 - 15, radius = Math.min(W, H) / 2 - 40;
  const slices = [
    { label: 'Carbs', val: carbs * 4, color: '#2563eb' },
    { label: 'Protein', val: protein * 4, color: '#d97706' },
    { label: 'Fat', val: fat * 9, color: '#7c3aed' }
  ];

  let startAngle = -Math.PI / 2;
  slices.forEach(s => {
    const sliceAngle = (s.val / total) * Math.PI * 2;
    if (s.val === 0) return;
    ctx.fillStyle = s.color;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fill();

    // Label
    const midAngle = startAngle + sliceAngle / 2;
    const pct = (s.val / total * 100).toFixed(0);
    if (parseInt(pct) > 3) {
      const lx = cx + (radius * 0.65) * Math.cos(midAngle);
      const ly = cy + (radius * 0.65) * Math.sin(midAngle);
      ctx.fillStyle = '#fff'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(pct + '%', lx, ly + 5);
    }

    startAngle += sliceAngle;
  });

  // Center hole (donut)
  ctx.fillStyle = '#f8fafc';
  ctx.beginPath(); ctx.arc(cx, cy, radius * 0.4, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#374151'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(total + ' cal', cx, cy + 5);

  // Recommended ratio text
  ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Recommended: 50/30/20', cx, H - 10);
}

function drawMealDVChart(cal, carbs, protein, fat) {
  const ctx = getCtx('meal-dv-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (cal === 0) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Add foods to see daily values', W / 2, H / 2);
    return;
  }

  // Daily values (2000 cal diet)
  const dvCal = 2000, dvCarbs = 275, dvProtein = 50, dvFat = 78;
  const items = [
    { label: 'Calories', pct: (cal / dvCal) * 100, color: '#c41e3a' },
    { label: 'Carbs', pct: (carbs / dvCarbs) * 100, color: '#2563eb' },
    { label: 'Protein', pct: (protein / dvProtein) * 100, color: '#d97706' },
    { label: 'Fat', pct: (fat / dvFat) * 100, color: '#7c3aed' }
  ];

  const pad = { top: 20, right: 30, bottom: 20, left: 70 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const barH = plotH / items.length * 0.6;
  const gap = plotH / items.length * 0.4;
  const maxPct = Math.max(100, ...items.map(i => i.pct)) * 1.1;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  [25, 50, 75, 100].forEach(pct => {
    const x = pad.left + (pct / maxPct) * plotW;
    ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, H - pad.bottom); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(pct + '%', x, H - pad.bottom + 14);
  });

  // 100% reference
  const ref100 = pad.left + (100 / maxPct) * plotW;
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2; ctx.setLineDash([4, 3]);
  ctx.beginPath(); ctx.moveTo(ref100, pad.top); ctx.lineTo(ref100, H - pad.bottom); ctx.stroke();
  ctx.setLineDash([]);

  items.forEach((item, i) => {
    const y = pad.top + i * (barH + gap);
    const w = Math.min((item.pct / maxPct) * plotW, plotW);

    ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(item.label, pad.left - 8, y + barH / 2 + 4);

    ctx.fillStyle = '#e5e7eb'; ctx.fillRect(pad.left, y, plotW, barH);
    ctx.fillStyle = item.color; ctx.globalAlpha = item.pct > 100 ? 0.9 : 0.7;
    ctx.fillRect(pad.left, y, w, barH);
    ctx.globalAlpha = 1;

    ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText(item.pct.toFixed(0) + '%', pad.left + w + 4, y + barH / 2 + 4);
  });
}

function drawMealDensityChart() {
  if (!mealItems.length) {
    const ctx = getCtx('meal-density-chart');
    ctx.clearRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, ctx.W, ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Add foods to see calorie density', ctx.W / 2, ctx.H / 2);
    return;
  }
  const ctx = getCtx('meal-density-chart');
  const labels = mealItems.map(f => f.name);
  const values = mealItems.map(f => f.cal);
  const colors = mealItems.map(() => '#c41e3a');
  drawBarChart(ctx, { labels, values, colors, maxVal: Math.max(...values) * 1.3 });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 6: UNKNOWN SAMPLE CHALLENGE
// ══════════════════════════════════════════════════════════════════════════
let challengeState = {
  difficulty: 'easy',
  currentSample: null,
  testsRun: {},
  answers: [],
  score: 0,
  correct: 0,
  wrong: 0,
  streak: 0,
  maxStreak: 0,
  sampleNum: 0,
  history: []
};

function setDifficulty(d) {
  challengeState.difficulty = d;
  ['easy', 'medium', 'hard'].forEach(lvl => {
    $('diff-' + lvl).className = 'btn btn-sm btn-outline' + (lvl === d ? ' btn-active' : '');
  });
}

function generateUnknown() {
  challengeState.sampleNum++;
  challengeState.testsRun = {};
  challengeState.answers = [];
  $('challenge-card').style.display = 'block';
  $('challenge-num').textContent = challengeState.sampleNum;
  $('challenge-feedback').innerHTML = '';
  $('challenge-test-results').innerHTML = '<p style="font-size:13px;color:var(--text-muted);">Run tests to gather clues.</p>';

  // Reset answer buttons
  ['sugar', 'starch', 'protein', 'lipid'].forEach(a => {
    $('ans-' + a).className = 'btn btn-sm btn-outline';
  });

  // Generate random sample based on difficulty
  const sample = { sugar: false, starch: false, protein: false, lipid: false };
  if (challengeState.difficulty === 'easy') {
    // Single macromolecule
    const types = ['sugar', 'starch', 'protein', 'lipid'];
    sample[types[rand(0, 3)]] = true;
  } else if (challengeState.difficulty === 'medium') {
    // 1-2 macromolecules
    const count = rand(1, 2);
    const types = ['sugar', 'starch', 'protein', 'lipid'];
    const chosen = [];
    while (chosen.length < count) {
      const t = types[rand(0, 3)];
      if (!chosen.includes(t)) { chosen.push(t); sample[t] = true; }
    }
  } else {
    // 1-3 macromolecules
    const count = rand(1, 3);
    const types = ['sugar', 'starch', 'protein', 'lipid'];
    const chosen = [];
    while (chosen.length < count) {
      const t = types[rand(0, 3)];
      if (!chosen.includes(t)) { chosen.push(t); sample[t] = true; }
    }
  }
  challengeState.currentSample = sample;

  // Draw initial tube
  const ctx = getCtx('challenge-tube-canvas');
  drawTestTube(ctx, '#e2e8f0', 0.5, 'Unknown #' + challengeState.sampleNum, 1);
}

function runChallengeTest(reagentKey) {
  if (!challengeState.currentSample) return;
  const reagent = REAGENT_INFO[reagentKey];
  const isPositive = challengeState.currentSample[reagent.target];
  challengeState.testsRun[reagentKey] = isPositive;

  // Animate tube
  const ctx = getCtx('challenge-tube-canvas');
  const color = isPositive ? reagent.posColor : reagent.negColor;
  drawTestTube(ctx, color, 0.5, reagent.name + ' Test', 1);

  // Update results display
  let html = '';
  for (const [key, result] of Object.entries(challengeState.testsRun)) {
    const r = REAGENT_INFO[key];
    html += `<div class="analysis-result ${result ? 'ar-pass' : 'ar-fail'}" style="padding:8px;margin:4px 0;">
      <strong>${r.name}:</strong> ${result ? 'POSITIVE (+)' : 'NEGATIVE (-)'}
    </div>`;
  }
  $('challenge-test-results').innerHTML = html;
}

function toggleAnswer(type) {
  const idx = challengeState.answers.indexOf(type);
  if (idx >= 0) {
    challengeState.answers.splice(idx, 1);
    $('ans-' + type).className = 'btn btn-sm btn-outline';
  } else {
    challengeState.answers.push(type);
    $('ans-' + type).className = 'btn btn-sm btn-outline btn-active';
  }
}

function submitAnswer() {
  if (!challengeState.currentSample) return;
  if (challengeState.answers.length === 0) {
    $('challenge-feedback').innerHTML = '<div class="analysis-result ar-fail"><div class="ar-title">Select at least one macromolecule!</div></div>';
    return;
  }

  const sample = challengeState.currentSample;
  const correct = [];
  ['sugar', 'starch', 'protein', 'lipid'].forEach(t => {
    if (sample[t]) correct.push(t);
  });

  const userSet = new Set(challengeState.answers);
  const correctSet = new Set(correct);
  const isCorrect = userSet.size === correctSet.size && [...userSet].every(x => correctSet.has(x));

  // Scoring
  const testsUsed = Object.keys(challengeState.testsRun).length;
  let points = 0;
  if (isCorrect) {
    const diffMultiplier = challengeState.difficulty === 'easy' ? 1 : challengeState.difficulty === 'medium' ? 2 : 3;
    const efficiencyBonus = Math.max(0, 5 - testsUsed);
    points = (10 + efficiencyBonus) * diffMultiplier;
    challengeState.correct++;
    challengeState.streak++;
    if (challengeState.streak > challengeState.maxStreak) challengeState.maxStreak = challengeState.streak;
    // Streak bonus
    if (challengeState.streak >= 3) points += challengeState.streak * 2;
  } else {
    challengeState.wrong++;
    challengeState.streak = 0;
  }
  challengeState.score += points;
  challengeState.history.push(points);

  // Feedback
  const correctNames = correct.map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(', ');
  $('challenge-feedback').innerHTML = `<div class="analysis-result ${isCorrect ? 'ar-pass' : 'ar-fail'}">
    <div class="ar-title">${isCorrect ? 'Correct!' : 'Incorrect'} ${isCorrect ? '(+' + points + ' points)' : ''}</div>
    <p><strong>The sample contained:</strong> ${correctNames}</p>
    ${isCorrect && challengeState.streak >= 3 ? '<p>Streak bonus! x' + challengeState.streak + '</p>' : ''}
    ${!isCorrect ? '<p>Your answer: ' + challengeState.answers.map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(', ') + '</p>' : ''}
    <p style="margin-top:8px;"><strong>Tests used:</strong> ${testsUsed}/4</p>
  </div>`;

  // Update scores
  $('challenge-score').textContent = challengeState.score;
  $('challenge-correct').textContent = challengeState.correct;
  $('challenge-wrong').textContent = challengeState.wrong;
  $('challenge-streak').textContent = challengeState.streak;

  drawChallengeHistory();

  // Disable further interaction
  challengeState.currentSample = null;
}

function drawChallengeHistory() {
  if (!challengeState.history.length) return;
  const ctx = getCtx('challenge-history-chart');
  const labels = challengeState.history.map((_, i) => '#' + (i + 1));
  const values = challengeState.history;
  const colors = values.map(v => v > 0 ? '#16a34a' : '#c41e3a');
  drawBarChart(ctx, {
    labels, values, colors,
    maxVal: Math.max(...values, 10) * 1.3
  });
}

// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR NAV HIGHLIGHTING
// ══════════════════════════════════════════════════════════════════════════
function updateNav() {
  const sections = document.querySelectorAll('.section, .hero');
  const links = document.querySelectorAll('.sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    const top = s.getBoundingClientRect().top;
    if (top < 200) current = s.id;
  });
  links.forEach(a => {
    a.classList.remove('active');
    if (a.getAttribute('href') === '#' + current) a.classList.add('active');
  });
}
window.addEventListener('scroll', updateNav);

// ══════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ══════════════════════════════════════════════════════════════════════════
function init() {
  // Part 1: Initial test tube
  resetIndicatorTest();
  updateReferenceChart();

  // Part 2: Draw molecule structures
  drawMoleculeStructures();

  // Part 3: Build food buttons
  buildFoodButtons();

  // Part 4: Draw digestive system
  drawDigestiveSystem();
  drawDigestionProgress();
  drawAbsorptionCanvas();

  // Part 5: Build meal select
  buildMealSelect();
  updateMealUI();
}

// Wait for DOM then initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// Redraw on resize
window.addEventListener('resize', () => {
  if (currentTestResult) {
    const ctx = getCtx('test-tube-canvas');
    const reagent = REAGENT_INFO[currentTestResult.reagent];
    const sample = SAMPLES[currentTestResult.sample];
    drawTestTube(ctx, currentTestResult.color, 0.6, sample.name + ' + ' + reagent.name, 1);
  } else {
    resetIndicatorTest();
  }
  drawMoleculeStructures();
  drawDigestiveSystem();
  drawDigestionProgress();
  drawAbsorptionCanvas();
  if (foodTestedList.length) { drawFoodComparisonChart(); drawFoodNutritionChart(); }
  updateMealUI();
  if (challengeState.history.length) drawChallengeHistory();
});
</script>
</body>
</html>
