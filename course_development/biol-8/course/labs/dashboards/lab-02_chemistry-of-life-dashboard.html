<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 2 Dashboard: Chemistry of Life | BIOL-8</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

select.chem-select {
  padding: 8px 14px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: 2px solid var(--border); font-family: var(--font); background: #fff;
  cursor: pointer; transition: border-color 0.15s;
}
select.chem-select:focus { outline: none; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   PERIODIC TABLE MINI REFERENCE
   ═══════════════════════════════════════════════════════════════════════ */
.ptable-mini { display: flex; gap: 6px; flex-wrap: wrap; margin: 12px 0; }
.ptable-el {
  width: 52px; height: 52px; border-radius: 8px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s;
  border: 2px solid var(--border); background: #f8fafc; font-size: 18px; font-weight: 800;
}
.ptable-el:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.ptable-el.selected { border-color: var(--accent); background: #fef2f2; }
.ptable-el .el-num { font-size: 9px; font-weight: 600; color: var(--text-muted); }

/* ═══════════════════════════════════════════════════════════════════════
   BOND CARDS
   ═══════════════════════════════════════════════════════════════════════ */
.bond-type-btn {
  padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;
  border: 2px solid var(--border); background: #fff; transition: all 0.15s; font-size: 13px;
}
.bond-type-btn:hover { border-color: var(--blue); }
.bond-type-btn.active { border-color: var(--accent); background: #fef2f2; color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   PH SCALE COLORS
   ═══════════════════════════════════════════════════════════════════════ */
.ph-substance {
  display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px;
  border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;
  border: 2px solid var(--border); background: #fff; transition: all 0.15s; margin: 3px;
}
.ph-substance:hover { border-color: var(--accent); }
.ph-substance.placed { opacity: 0.5; border-style: dashed; }

/* ═══════════════════════════════════════════════════════════════════════
   WATER DEMO TABS
   ═══════════════════════════════════════════════════════════════════════ */
.demo-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.demo-tab {
  padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;
  font-size: 13px; border: 2px solid var(--border); border-bottom: none;
  background: #f8fafc; transition: all 0.15s;
}
.demo-tab:hover { background: #fff; }
.demo-tab.active { background: #fff; border-color: var(--accent); color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   BODY MAP REGIONS
   ═══════════════════════════════════════════════════════════════════════ */
.body-region {
  padding: 12px 16px; border-radius: 8px; cursor: pointer; border: 2px solid var(--border);
  background: #f8fafc; transition: all 0.15s; margin-bottom: 8px;
}
.body-region:hover { border-color: var(--blue); background: #eff6ff; }
.body-region.active { border-color: var(--accent); background: #fef2f2; }
.body-region .br-title { font-weight: 700; font-size: 14px; }
.body-region .br-sub { font-size: 12px; color: var(--text-muted); }

/* ═══════════════════════════════════════════════════════════════════════
   EXPLANATION PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.explain-panel {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px; line-height: 1.7;
}
.explain-panel strong { color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-8: Human Biology</h1>
    <p>Lab 2 &mdash; Chemistry of Life</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Atomic Structure</a>
    <a href="#part2"><span class="nav-num">2</span> Chemical Bonds</a>
    <a href="#part3"><span class="nav-num">3</span> pH Scale</a>
    <a href="#part4"><span class="nav-num">4</span> Water Properties</a>
    <a href="#part5"><span class="nav-num">5</span> Reactions</a>
    <a href="#part6"><span class="nav-num">6</span> Body Chemistry</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-8</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Chemistry of Life</h2>
  <p>Explore atoms, bonds, pH, water properties, chemical reactions, and body chemistry through interactive simulations. Every biological process depends on chemistry.</p>
  <div class="bio-tags">
    <span class="bio-tag">Chemical Bonds</span>
    <span class="bio-tag">pH</span>
    <span class="bio-tag">Water Properties</span>
  </div>
</div>

<!-- ═══════════════════════ PART 1: ATOMIC STRUCTURE ════════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Atomic Structure Builder</div>
    <div class="section-subtitle">Select an element and explore its electron configuration</div></div>
  </div>
  <div class="card">
    <div class="card-title">Select Element</div>
    <div class="ptable-mini" id="ptable-mini"></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Atom Visualization</div>
      <div class="chart-wrap"><canvas id="atom-canvas" height="340"></canvas></div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="atomAddElectron()">Add Electron</button>
        <button class="btn btn-secondary" onclick="atomFillAll()">Fill All Shells</button>
        <button class="btn btn-outline" onclick="atomReset()">Reset</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Element Properties</div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="atom-symbol">-</div><div class="stat-label">Symbol</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="atom-number">-</div><div class="stat-label">Atomic #</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="atom-mass">-</div><div class="stat-label">Mass</div></div>
        <div class="stat-box stat-amber"><div class="stat-val" id="atom-valence">-</div><div class="stat-label">Valence e-</div></div>
      </div>
      <div class="stat-grid">
        <div class="stat-box stat-purple"><div class="stat-val" id="atom-bonds">-</div><div class="stat-label">Bonding Cap.</div></div>
        <div class="stat-box"><div class="stat-val" id="atom-filled">0</div><div class="stat-label">e- Filled</div></div>
      </div>
      <div id="atom-config" class="explain-panel" style="margin-top:12px;">
        Select an element above to see its electron configuration.
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 2: CHEMICAL BONDS ═════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Chemical Bond Explorer</div>
    <div class="section-subtitle">Build ionic, covalent, and hydrogen bonds between atoms</div></div>
  </div>
  <div class="card">
    <div class="card-title">Bond Type</div>
    <div class="btn-group">
      <button class="bond-type-btn active" onclick="selectBondType('ionic')">Ionic Bond</button>
      <button class="bond-type-btn" onclick="selectBondType('covalent')">Covalent Bond</button>
      <button class="bond-type-btn" onclick="selectBondType('hydrogen')">Hydrogen Bond</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Bond Visualization</div>
    <div class="chart-wrap"><canvas id="bond-canvas" height="340"></canvas></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="bondAnimate()">Animate Bond Formation</button>
      <button class="btn btn-outline" onclick="bondReset()">Reset</button>
    </div>
    <div id="bond-explain" class="explain-panel">
      <strong>Ionic Bond:</strong> Na donates its outer electron to Cl. The resulting Na+ and Cl- ions attract via electrostatic force, forming NaCl (table salt).
    </div>
  </div>
  <div class="card">
    <div class="card-title">Bond Energy Comparison</div>
    <div class="chart-wrap"><canvas id="bond-energy-chart" height="240"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Electronegativity &amp; Partial Charges</div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="bond-atom1">-</div><div class="stat-label">Atom 1</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="bond-atom2">-</div><div class="stat-label">Atom 2</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="bond-en-diff">-</div><div class="stat-label">EN Diff</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="bond-polarity">-</div><div class="stat-label">Polarity</div></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 3: pH SCALE ═══════════════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">pH Scale Interactive</div>
    <div class="section-subtitle">Explore acids, bases, and indicators across the pH spectrum</div></div>
  </div>
  <div class="card">
    <div class="card-title">pH Scale &amp; Indicator Colors</div>
    <div class="chart-wrap"><canvas id="ph-scale-canvas" height="280"></canvas></div>
    <div class="slider-group">
      <label>pH Value</label>
      <input type="range" id="ph-slider" min="0" max="14" step="0.1" value="7" oninput="phUpdate()">
      <span class="slider-val" id="ph-val">7.0</span>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ph-type">Neutral</div><div class="stat-label">Type</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ph-h">10<sup>-7</sup></div><div class="stat-label">[H+] mol/L</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ph-litmus">-</div><div class="stat-label">Litmus</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="ph-phenol">-</div><div class="stat-label">Phenolphth.</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Place Substances on the pH Scale</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Click a substance, then click on the pH scale to place it. Green = correct placement.</p>
    <div id="ph-substances"></div>
    <div class="chart-wrap"><canvas id="ph-placement-canvas" height="160"></canvas></div>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="phResetPlacement()">Reset Placement</button>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Buffer Zone Demonstration</div>
      <div class="chart-wrap"><canvas id="ph-buffer-chart" height="240"></canvas></div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="bufferAddAcid()">Add Acid Drop</button>
        <button class="btn btn-secondary" onclick="bufferAddBase()">Add Base Drop</button>
        <button class="btn btn-outline" onclick="bufferReset()">Reset</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Human Body pH Requirements</div>
      <div class="chart-wrap"><canvas id="ph-body-chart" height="240"></canvas></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 4: WATER PROPERTIES ══════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Water Properties Lab</div>
    <div class="section-subtitle">Explore cohesion, adhesion, specific heat, and solvent properties</div></div>
  </div>
  <div class="card">
    <div class="demo-tabs">
      <div class="demo-tab active" onclick="waterTab('cohesion')">Cohesion</div>
      <div class="demo-tab" onclick="waterTab('adhesion')">Adhesion</div>
      <div class="demo-tab" onclick="waterTab('heat')">Specific Heat</div>
      <div class="demo-tab" onclick="waterTab('solvent')">Universal Solvent</div>
    </div>
    <div class="chart-wrap"><canvas id="water-canvas" height="360"></canvas></div>
    <div id="water-controls"></div>
    <div id="water-explain" class="explain-panel">
      <strong>Cohesion:</strong> Water molecules attract each other through hydrogen bonds. This allows water to form droplets and creates surface tension. Click the penny to add water drops!
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 5: CHEMICAL REACTIONS ═════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Chemical Reactions Simulator</div>
    <div class="section-subtitle">Explore synthesis, decomposition, and exchange reactions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Reaction Type</div>
    <div class="btn-group">
      <button class="bond-type-btn active" onclick="selectReaction('synthesis')">Synthesis (A+B &rarr; AB)</button>
      <button class="bond-type-btn" onclick="selectReaction('decomposition')">Decomposition (AB &rarr; A+B)</button>
      <button class="bond-type-btn" onclick="selectReaction('exchange')">Exchange (AB+CD &rarr; AD+CB)</button>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Reaction Animation</div>
      <div class="chart-wrap"><canvas id="reaction-canvas" height="280"></canvas></div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="reactionAnimate()">Run Reaction</button>
        <button class="btn btn-outline" onclick="reactionReset()">Reset</button>
      </div>
      <div style="margin-top:8px;">
        <label style="font-size:13px;font-weight:600;cursor:pointer;">
          <input type="checkbox" id="enzyme-toggle" onchange="toggleEnzyme()"> Add Enzyme (Catalyst)
        </label>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Energy Diagram</div>
      <div class="chart-wrap"><canvas id="energy-diagram" height="280"></canvas></div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="rxn-type-label">Syn</div><div class="stat-label">Type</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="rxn-energy">-</div><div class="stat-label">Energy Change</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="rxn-enzyme">Off</div><div class="stat-label">Enzyme</div></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Biological Examples</div>
    <div id="rxn-bio-example" class="explain-panel">
      <strong>Synthesis in Biology:</strong> Dehydration synthesis joins amino acids to form proteins. Two amino acids combine, releasing a water molecule: Amino Acid + Amino Acid &rarr; Dipeptide + H<sub>2</sub>O
    </div>
  </div>
</div>

<!-- ═══════════════════════ PART 6: BODY CHEMISTRY ═════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Body Chemistry Dashboard</div>
    <div class="section-subtitle">Click body regions to explore the chemistry of human systems</div></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Human Body</div>
      <div class="chart-wrap"><canvas id="body-canvas" height="480"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Body Regions</div>
      <div class="body-region active" onclick="selectBodyRegion('stomach')">
        <div class="br-title">Stomach</div>
        <div class="br-sub">HCl, pH 2, pepsin digestion</div>
      </div>
      <div class="body-region" onclick="selectBodyRegion('blood')">
        <div class="br-title">Blood</div>
        <div class="br-sub">pH 7.4, bicarbonate buffer</div>
      </div>
      <div class="body-region" onclick="selectBodyRegion('bones')">
        <div class="br-title">Bones</div>
        <div class="br-sub">Ca2+, hydroxyapatite crystals</div>
      </div>
      <div class="body-region" onclick="selectBodyRegion('muscles')">
        <div class="br-title">Muscles</div>
        <div class="br-sub">ATP, lactic acid fermentation</div>
      </div>
      <div class="stat-grid" id="body-stats">
        <div class="stat-box stat-accent"><div class="stat-val" id="body-ph">2.0</div><div class="stat-label">pH</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="body-key-ion">HCl</div><div class="stat-label">Key Chemical</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="body-function">Digest</div><div class="stat-label">Function</div></div>
      </div>
      <div id="body-equation" class="explain-panel">
        <strong>Stomach Chemistry:</strong><br>
        HCl &rarr; H<sup>+</sup> + Cl<sup>-</sup><br><br>
        Hydrochloric acid dissociates to create an extremely acidic environment (pH 1.5-3.5). This activates pepsinogen into pepsin, which breaks down proteins. The stomach lining is protected by a thick mucus layer.
      </div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// == Utility ==
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const lerp = (a, b, t) => a + (b - a) * t;

// == Chart helper ==
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);
  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }
  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 2 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });
  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);
  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }
  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════
// ELEMENT DATA
// ══════════════════════════════════════════════════════════════════════════
const ELEMENTS = {
  H:  { num: 1,  mass: 1.008,  name: 'Hydrogen',  shells: [1],       valence: 1, bondCap: 1, en: 2.20, color: '#e0e0e0' },
  C:  { num: 6,  mass: 12.011, name: 'Carbon',     shells: [2,4],     valence: 4, bondCap: 4, en: 2.55, color: '#555555' },
  N:  { num: 7,  mass: 14.007, name: 'Nitrogen',   shells: [2,5],     valence: 5, bondCap: 3, en: 3.04, color: '#3050f8' },
  O:  { num: 8,  mass: 15.999, name: 'Oxygen',     shells: [2,6],     valence: 6, bondCap: 2, en: 3.44, color: '#dc2626' },
  Na: { num: 11, mass: 22.990, name: 'Sodium',     shells: [2,8,1],   valence: 1, bondCap: 1, en: 0.93, color: '#d97706' },
  Cl: { num: 17, mass: 35.453, name: 'Chlorine',   shells: [2,8,7],   valence: 7, bondCap: 1, en: 3.16, color: '#16a34a' },
  Ca: { num: 20, mass: 40.078, name: 'Calcium',    shells: [2,8,8,2], valence: 2, bondCap: 2, en: 1.00, color: '#7c3aed' }
};
const SHELL_MAX = [2, 8, 8, 8];

let currentElement = 'H';
let filledElectrons = 0;

function buildPeriodicMini() {
  const el = $('ptable-mini');
  Object.keys(ELEMENTS).forEach(sym => {
    const e = ELEMENTS[sym];
    const div = document.createElement('div');
    div.className = 'ptable-el' + (sym === currentElement ? ' selected' : '');
    div.id = 'ptable-' + sym;
    div.innerHTML = `<span class="el-num">${e.num}</span>${sym}`;
    div.onclick = () => selectElement(sym);
    el.appendChild(div);
  });
}

function selectElement(sym) {
  currentElement = sym;
  filledElectrons = 0;
  document.querySelectorAll('.ptable-el').forEach(e => e.classList.remove('selected'));
  $('ptable-' + sym).classList.add('selected');
  updateAtomUI();
  drawAtom();
}

function atomAddElectron() {
  const e = ELEMENTS[currentElement];
  const total = e.shells.reduce((a,b) => a+b, 0);
  if (filledElectrons < total) { filledElectrons++; updateAtomUI(); drawAtom(); }
}

function atomFillAll() {
  const e = ELEMENTS[currentElement];
  filledElectrons = e.shells.reduce((a,b) => a+b, 0);
  updateAtomUI(); drawAtom();
}

function atomReset() { filledElectrons = 0; updateAtomUI(); drawAtom(); }

function updateAtomUI() {
  const e = ELEMENTS[currentElement];
  $('atom-symbol').textContent = currentElement;
  $('atom-number').textContent = e.num;
  $('atom-mass').textContent = e.mass.toFixed(1);
  $('atom-valence').textContent = e.shells[e.shells.length - 1];
  $('atom-bonds').textContent = e.bondCap;
  $('atom-filled').textContent = filledElectrons;

  // config string
  const shellNames = ['1s','2s 2p','3s 3p','4s'];
  const shellNotation = [];
  let rem = e.shells.reduce((a,b)=>a+b,0);
  e.shells.forEach((s,i) => {
    if (i === 0) shellNotation.push(`1s${s > 1 ? '\u00B2' : '\u00B9'}`);
    else if (i === 1) {
      const sEl = Math.min(s, 2);
      const pEl = s - sEl;
      shellNotation.push(`2s\u00B2`);
      if (pEl > 0) shellNotation.push(`2p${pEl > 1 ? String.fromCharCode(0x2070 + pEl) : '\u00B9'}`);
    }
    else if (i === 2) {
      const sEl = Math.min(s, 2);
      const pEl = s - sEl;
      shellNotation.push(`3s\u00B2`);
      if (pEl > 0) shellNotation.push(`3p${pEl > 1 ? String.fromCharCode(0x2070 + pEl) : '\u00B9'}`);
    }
    else {
      shellNotation.push(`4s\u00B2`);
    }
  });

  const superscripts = {1:'\u00B9',2:'\u00B2',3:'\u00B3',4:'\u2074',5:'\u2075',6:'\u2076',7:'\u2077',8:'\u2078'};
  let configParts = [];
  let remaining = e.num;
  const orbitals = [
    {name:'1s',max:2},{name:'2s',max:2},{name:'2p',max:6},
    {name:'3s',max:2},{name:'3p',max:6},{name:'4s',max:2}
  ];
  orbitals.forEach(o => {
    if (remaining <= 0) return;
    const fill = Math.min(remaining, o.max);
    configParts.push(o.name + (superscripts[fill]||fill));
    remaining -= fill;
  });

  $('atom-config').innerHTML =
    `<strong>${e.name} (${currentElement})</strong><br>` +
    `Electron Configuration: ${configParts.join(' ')}<br>` +
    `Valence Electrons: <strong>${e.shells[e.shells.length-1]}</strong><br>` +
    `Bonding Capacity: <strong>${e.bondCap}</strong> (needs ${e.bondCap === 0 ? 0 : 8 - e.shells[e.shells.length-1]} more e- to fill octet)` +
    (e.num <= 2 ? ' (duet rule)' : '') + '<br>' +
    `Electronegativity: <strong>${e.en.toFixed(2)}</strong>`;
}

function drawAtom() {
  const ctx = getCtx('atom-canvas');
  const W = ctx.W, H = ctx.H;
  const cx = W/2, cy = H/2;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);

  const e = ELEMENTS[currentElement];
  const nShells = e.shells.length;
  const maxR = Math.min(W,H)/2 - 30;
  const shellR = [];
  for (let i = 0; i < nShells; i++) shellR.push(40 + (maxR-40) * (i/(Math.max(nShells-1,1))));
  if (nShells === 1) shellR[0] = 70;

  // Draw shells (orbit rings)
  shellR.forEach((r, i) => {
    ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke();
    ctx.setLineDash([]);
    // shell label
    ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
    ctx.fillText('n='+(i+1), cx + r + 4, cy - 4);
  });

  // Draw nucleus
  const nucleusR = 18;
  const gradient = ctx.createRadialGradient(cx-3, cy-3, 2, cx, cy, nucleusR);
  gradient.addColorStop(0, '#fbbf24');
  gradient.addColorStop(1, '#d97706');
  ctx.fillStyle = gradient;
  ctx.beginPath(); ctx.arc(cx, cy, nucleusR, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(e.num+'p', cx, cy - 2);
  ctx.fillText(Math.round(e.mass - e.num)+'n', cx, cy + 12);

  // Draw electrons
  let eCount = 0;
  e.shells.forEach((shellMax, si) => {
    const r = shellR[si];
    for (let ei = 0; ei < shellMax; ei++) {
      eCount++;
      const angle = (ei / shellMax) * Math.PI * 2 - Math.PI/2;
      const ex = cx + Math.cos(angle) * r;
      const ey = cy + Math.sin(angle) * r;

      if (eCount <= filledElectrons) {
        // filled electron
        const isValence = si === nShells - 1;
        ctx.fillStyle = isValence ? '#c41e3a' : '#2563eb';
        ctx.beginPath(); ctx.arc(ex, ey, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.font = 'bold 8px system-ui'; ctx.textAlign = 'center';
        ctx.fillText('e-', ex, ey + 3);
      } else {
        // empty slot
        ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(ex, ey, 5, 0, Math.PI*2); ctx.stroke();
      }
    }
  });

  // Legend
  ctx.fillStyle = '#2563eb'; ctx.beginPath(); ctx.arc(20, H-30, 5, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Core e-', 30, H-27);
  ctx.fillStyle = '#c41e3a'; ctx.beginPath(); ctx.arc(100, H-30, 5, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#374151'; ctx.fillText('Valence e-', 110, H-27);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: CHEMICAL BONDS
// ══════════════════════════════════════════════════════════════════════════
let bondType = 'ionic';
let bondAnimProgress = 0;
let bondAnimRunning = false;
let bondAnimFrame = null;

const BOND_DATA = {
  ionic: {
    atoms: ['Na', 'Cl'], product: 'NaCl',
    explain: '<strong>Ionic Bond:</strong> Na donates its outer electron to Cl. The resulting Na<sup>+</sup> and Cl<sup>-</sup> ions attract via electrostatic force, forming NaCl (table salt). Ionic bonds form between atoms with large electronegativity differences (>1.7).',
    en1: 0.93, en2: 3.16, diff: 2.23, polarity: 'Ionic', energy: 787
  },
  covalent: {
    atoms: ['H', 'H'], product: 'H2',
    explain: '<strong>Covalent Bond:</strong> Two hydrogen atoms share their electrons equally, forming H<sub>2</sub>. Each atom contributes one electron to the shared pair. Nonpolar covalent bonds form between identical atoms (EN difference = 0).',
    en1: 2.20, en2: 2.20, diff: 0, polarity: 'Nonpolar', energy: 436
  },
  hydrogen: {
    atoms: ['H2O', 'H2O'], product: 'H2O---H2O',
    explain: '<strong>Hydrogen Bond:</strong> The partial positive charge on hydrogen of one water molecule is attracted to the partial negative charge on oxygen of another. These bonds are weaker than ionic/covalent but crucial for water\'s unique properties and DNA structure.',
    en1: '-', en2: '-', diff: '-', polarity: 'Polar', energy: 23
  }
};

function selectBondType(type) {
  bondType = type;
  bondAnimProgress = 0;
  bondAnimRunning = false;
  if (bondAnimFrame) cancelAnimationFrame(bondAnimFrame);
  document.querySelectorAll('.bond-type-btn').forEach((b,i) => {
    b.classList.toggle('active', ['ionic','covalent','hydrogen'][i] === type);
  });
  const d = BOND_DATA[type];
  $('bond-explain').innerHTML = d.explain;
  $('bond-atom1').textContent = d.atoms[0];
  $('bond-atom2').textContent = d.atoms[1];
  $('bond-en-diff').textContent = typeof d.diff === 'number' ? d.diff.toFixed(2) : d.diff;
  $('bond-polarity').textContent = d.polarity;
  drawBond();
  drawBondEnergyChart();
}

function bondAnimate() {
  if (bondAnimRunning) return;
  bondAnimProgress = 0;
  bondAnimRunning = true;
  function step() {
    bondAnimProgress += 0.015;
    if (bondAnimProgress >= 1) { bondAnimProgress = 1; bondAnimRunning = false; }
    drawBond();
    if (bondAnimRunning) bondAnimFrame = requestAnimationFrame(step);
  }
  step();
}

function bondReset() {
  bondAnimProgress = 0; bondAnimRunning = false;
  if (bondAnimFrame) cancelAnimationFrame(bondAnimFrame);
  drawBond();
}

function drawBond() {
  const ctx = getCtx('bond-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);
  const cx = W/2, cy = H/2;
  const t = bondAnimProgress;

  if (bondType === 'ionic') {
    // Na and Cl approach, electron transfers
    const sep = lerp(180, 70, t);
    const naX = cx - sep, clX = cx + sep;

    // Na nucleus
    const naGrad = ctx.createRadialGradient(naX-2,cy-2,2,naX,cy,24);
    naGrad.addColorStop(0,'#fbbf24'); naGrad.addColorStop(1,'#d97706');
    ctx.fillStyle = naGrad; ctx.beginPath(); ctx.arc(naX,cy,24,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#fff'; ctx.font='bold 14px system-ui'; ctx.textAlign='center';
    ctx.fillText('Na',naX,cy+5);

    // Cl nucleus
    const clGrad = ctx.createRadialGradient(clX-2,cy-2,2,clX,cy,28);
    clGrad.addColorStop(0,'#4ade80'); clGrad.addColorStop(1,'#16a34a');
    ctx.fillStyle = clGrad; ctx.beginPath(); ctx.arc(clX,cy,28,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#fff'; ctx.font='bold 14px system-ui';
    ctx.fillText('Cl',clX,cy+5);

    // Transferring electron
    if (t < 1) {
      const eX = lerp(naX + 30, clX - 34, t);
      const eY = cy - 20 * Math.sin(t * Math.PI);
      ctx.fillStyle = '#2563eb'; ctx.beginPath(); ctx.arc(eX,eY,6,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#fff'; ctx.font='bold 7px system-ui'; ctx.fillText('e-',eX,eY+3);
    }

    // Show charges when complete
    if (t >= 1) {
      ctx.fillStyle='#c41e3a'; ctx.font='bold 18px system-ui';
      ctx.fillText('+',naX,cy-30);
      ctx.fillStyle='#2563eb'; ctx.fillText('-',clX,cy-34);

      // Electrostatic attraction lines
      ctx.strokeStyle = 'rgba(196,30,58,0.3)'; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
      ctx.beginPath(); ctx.moveTo(naX+24,cy); ctx.lineTo(clX-28,cy); ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui';
      ctx.fillText('NaCl',cx,cy+60);
    }
  } else if (bondType === 'covalent') {
    const sep = lerp(140, 50, t);
    const h1X = cx - sep, h2X = cx + sep;

    // H atoms
    [h1X,h2X].forEach((hx,i) => {
      const g = ctx.createRadialGradient(hx-2,cy-2,2,hx,cy,20);
      g.addColorStop(0,'#e0e0e0'); g.addColorStop(1,'#999');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(hx,cy,20,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#fff'; ctx.font='bold 14px system-ui'; ctx.textAlign='center';
      ctx.fillText('H',hx,cy+5);
    });

    // Shared electron pair
    if (t > 0.3) {
      const et = (t - 0.3) / 0.7;
      const eAlpha = Math.min(et * 2, 1);

      // electron cloud between atoms
      ctx.fillStyle = `rgba(37,99,235,${eAlpha * 0.2})`;
      ctx.beginPath(); ctx.ellipse(cx, cy, Math.abs(h2X-h1X)/2 + 10, 18, 0, 0, Math.PI*2); ctx.fill();

      // two electrons
      const e1X = cx - 6, e2X = cx + 6;
      ctx.fillStyle = `rgba(37,99,235,${eAlpha})`; ctx.beginPath(); ctx.arc(e1X,cy-4,5,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = `rgba(196,30,58,${eAlpha})`; ctx.beginPath(); ctx.arc(e2X,cy+4,5,0,Math.PI*2); ctx.fill();
    }

    if (t >= 1) {
      ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui';
      ctx.fillText('H\u2082 (shared electron pair)',cx,cy+50);
    }
  } else {
    // Hydrogen bond between water molecules
    const sep = lerp(180, 90, t);
    const w1X = cx - sep, w2X = cx + sep;

    // Water molecule 1 - oxygen with 2 hydrogens
    drawWaterMolecule(ctx, w1X, cy, 22, t >= 0.5);
    drawWaterMolecule(ctx, w2X, cy, 22, t >= 0.5);

    // Hydrogen bond (dashed)
    if (t > 0.5) {
      const bAlpha = (t - 0.5) / 0.5;
      ctx.strokeStyle = `rgba(196,30,58,${bAlpha})`; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
      ctx.beginPath(); ctx.moveTo(w1X+36,cy-12); ctx.lineTo(w2X-36,cy-12); ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = `rgba(196,30,58,${bAlpha})`; ctx.font = 'bold 11px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('H-bond', cx, cy - 24);
    }

    if (t >= 1) {
      ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui';
      ctx.fillText('Hydrogen bond between H\u2082O molecules',cx,cy+70);
    }
  }

  // Title
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  const titles = {ionic:'Ionic Bond: Na + Cl \u2192 NaCl', covalent:'Covalent Bond: H + H \u2192 H\u2082', hydrogen:'Hydrogen Bond: H\u2082O \u00B7\u00B7\u00B7 H\u2082O'};
  ctx.fillText(titles[bondType], cx, 20);
}

function drawWaterMolecule(ctx, x, y, size, showCharges) {
  // Oxygen
  const oGrad = ctx.createRadialGradient(x-2,y-2,2,x,y,size);
  oGrad.addColorStop(0,'#ff6b6b'); oGrad.addColorStop(1,'#dc2626');
  ctx.fillStyle = oGrad; ctx.beginPath(); ctx.arc(x,y,size,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 12px system-ui'; ctx.textAlign='center';
  ctx.fillText('O',x,y+4);

  // H atoms at 104.5 degree angle
  const angle1 = -Math.PI * 0.7, angle2 = -Math.PI * 0.3;
  const hDist = size + 10;
  const hR = 12;
  [[angle1],[angle2]].forEach(([a]) => {
    const hx = x + Math.cos(a) * hDist;
    const hy = y + Math.sin(a) * hDist;
    ctx.fillStyle = '#d1d5db'; ctx.beginPath(); ctx.arc(hx,hy,hR,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#374151'; ctx.font='bold 10px system-ui'; ctx.fillText('H',hx,hy+4);

    if (showCharges) {
      ctx.fillStyle = '#2563eb'; ctx.font = 'bold 10px system-ui';
      ctx.fillText('\u03B4+', hx, hy - hR - 4);
    }
  });

  if (showCharges) {
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 10px system-ui';
    ctx.fillText('\u03B4-', x, y + size + 14);
  }
}

function drawBondEnergyChart() {
  const ctx = getCtx('bond-energy-chart');
  drawBarChart(ctx, {
    labels: ['Ionic (NaCl)', 'Covalent (H-H)', 'Covalent (O-H)', 'Hydrogen Bond'],
    values: [787, 436, 463, 23],
    colors: ['#d97706', '#2563eb', '#c41e3a', '#7c3aed'],
    maxVal: 900
  });

  // Y-axis label
  ctx.save(); ctx.translate(14, ctx.H/2);
  ctx.rotate(-Math.PI/2); ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
  ctx.textAlign = 'center'; ctx.fillText('kJ/mol', 0, 0);
  ctx.restore();
}

// ══════════════════════════════════════════════════════════════════════════
// PART 3: pH SCALE
// ══════════════════════════════════════════════════════════════════════════
const PH_COLORS = [
  '#ff0000','#ff3300','#ff6600','#ff9900','#ffcc00',
  '#ccff00','#66ff00','#00cc00','#009966','#006699',
  '#003399','#3300cc','#6600cc','#9900cc','#cc00cc'
];

const PH_SUBSTANCES = [
  { name: 'Stomach Acid', ph: 2.0, color: '#dc2626' },
  { name: 'Lemon Juice', ph: 2.3, color: '#ea580c' },
  { name: 'Cola', ph: 3.0, color: '#92400e' },
  { name: 'Coffee', ph: 5.0, color: '#78350f' },
  { name: 'Pure Water', ph: 7.0, color: '#2563eb' },
  { name: 'Blood', ph: 7.4, color: '#dc2626' },
  { name: 'Baking Soda', ph: 9.0, color: '#f59e0b' },
  { name: 'Ammonia', ph: 11.5, color: '#06b6d4' },
  { name: 'Bleach', ph: 12.5, color: '#d1d5db' }
];

let phSelected = null;
let phPlacements = {};

function phUpdate() {
  const ph = parseFloat($('ph-slider').value);
  $('ph-val').textContent = ph.toFixed(1);

  // type
  if (ph < 6.8) $('ph-type').textContent = 'Acidic';
  else if (ph > 7.2) $('ph-type').textContent = 'Basic';
  else $('ph-type').textContent = 'Neutral';

  // H+ concentration
  const hConc = Math.pow(10, -ph);
  $('ph-h').innerHTML = hConc < 0.001 ? `10<sup>-${ph.toFixed(1)}</sup>` : hConc.toFixed(4);

  // Litmus
  if (ph < 4.5) $('ph-litmus').textContent = 'Red';
  else if (ph > 8.3) $('ph-litmus').textContent = 'Blue';
  else $('ph-litmus').textContent = 'Purple';

  // Phenolphthalein
  if (ph < 8.2) $('ph-phenol').textContent = 'Clear';
  else $('ph-phenol').textContent = 'Pink';

  drawPHScale();
}

function drawPHScale() {
  const ctx = getCtx('ph-scale-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);
  const pad = {top:30, right:30, bottom:80, left:30};
  const scaleW = W - pad.left - pad.right;
  const scaleH = 50;
  const scaleY = pad.top + 30;

  // Title
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('pH Scale', W/2, 20);

  // Draw gradient scale
  for (let i = 0; i <= 14; i++) {
    const x = pad.left + (i/14) * scaleW;
    const w = scaleW / 14;
    ctx.fillStyle = PH_COLORS[i];
    ctx.fillRect(x, scaleY, w + 1, scaleH);

    // Number labels
    ctx.fillStyle = i < 5 || i > 11 ? '#fff' : '#000';
    ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(i, x + w/2, scaleY + scaleH/2 + 5);
  }

  // Scale border
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
  ctx.strokeRect(pad.left, scaleY, scaleW, scaleH);

  // Labels
  ctx.fillStyle = '#dc2626'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('ACIDIC', pad.left, scaleY + scaleH + 20);
  ctx.fillStyle = '#16a34a'; ctx.textAlign = 'center';
  ctx.fillText('NEUTRAL', W/2, scaleY + scaleH + 20);
  ctx.fillStyle = '#2563eb'; ctx.textAlign = 'right';
  ctx.fillText('BASIC', W - pad.right, scaleY + scaleH + 20);

  // Current pH indicator
  const ph = parseFloat($('ph-slider').value);
  const indX = pad.left + (ph/14) * scaleW;
  ctx.fillStyle = '#1a1a1a';
  ctx.beginPath();
  ctx.moveTo(indX, scaleY - 5);
  ctx.lineTo(indX - 8, scaleY - 18);
  ctx.lineTo(indX + 8, scaleY - 18);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(ph.toFixed(1), indX, scaleY - 10);

  // Indicator bars
  const indY = scaleY + scaleH + 35;
  const indH = 16;

  // Litmus
  ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'right';
  ctx.fillText('Litmus', pad.left - 4, indY + 12);
  for (let i = 0; i <= 14; i++) {
    const x = pad.left + (i/14) * scaleW;
    const w = scaleW / 14;
    ctx.fillStyle = i < 4.5 ? '#dc2626' : i > 8.3 ? '#2563eb' : '#9333ea';
    ctx.fillRect(x, indY, w+1, indH);
  }

  // Phenolphthalein
  ctx.fillStyle = '#9ca3af'; ctx.textAlign = 'right';
  ctx.fillText('Phenolph.', pad.left - 4, indY + indH + 18);
  for (let i = 0; i <= 14; i++) {
    const x = pad.left + (i/14) * scaleW;
    const w = scaleW / 14;
    ctx.fillStyle = i < 8 ? '#f1f5f9' : '#ec4899';
    ctx.fillRect(x, indY + indH + 6, w+1, indH);
  }
  ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 1;
  ctx.strokeRect(pad.left, indY + indH + 6, scaleW, indH);

  // Universal indicator
  ctx.fillStyle = '#9ca3af'; ctx.textAlign = 'right';
  ctx.fillText('Universal', pad.left - 4, indY + 2*(indH+6) + 12);
  for (let i = 0; i <= 14; i++) {
    const x = pad.left + (i/14) * scaleW;
    const w = scaleW / 14;
    ctx.fillStyle = PH_COLORS[i];
    ctx.fillRect(x, indY + 2*(indH+6), w+1, indH);
  }
}

function buildPHSubstances() {
  const container = $('ph-substances');
  PH_SUBSTANCES.forEach((s,i) => {
    const div = document.createElement('span');
    div.className = 'ph-substance';
    div.id = 'ph-sub-' + i;
    div.innerHTML = `<span style="width:8px;height:8px;border-radius:50%;background:${s.color};display:inline-block;"></span> ${s.name} (pH ${s.ph})`;
    div.onclick = () => { phSelected = i; document.querySelectorAll('.ph-substance').forEach(e => e.style.borderColor = ''); div.style.borderColor = 'var(--accent)'; };
    container.appendChild(div);
  });
}

function drawPHPlacement() {
  const ctx = getCtx('ph-placement-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);
  const pad = {left:30, right:30};
  const scaleW = W - pad.left - pad.right;
  const scaleY = 30, scaleH = 30;

  // Scale
  for (let i = 0; i <= 14; i++) {
    const x = pad.left + (i/14) * scaleW;
    const w = scaleW / 14;
    ctx.fillStyle = PH_COLORS[i]; ctx.globalAlpha = 0.4;
    ctx.fillRect(x, scaleY, w+1, scaleH);
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#374151'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(i, x + w/2, scaleY + scaleH + 14);
  }

  // Placed substances
  Object.entries(phPlacements).forEach(([idx, placedPh]) => {
    const s = PH_SUBSTANCES[idx];
    const x = pad.left + (placedPh / 14) * scaleW;
    const correct = Math.abs(placedPh - s.ph) < 0.8;
    ctx.fillStyle = correct ? '#16a34a' : '#c41e3a';
    ctx.beginPath(); ctx.arc(x, scaleY - 8, 6, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(s.name, x, scaleY - 18);
  });

  // Click target
  const canvas = $('ph-placement-canvas');
  canvas.onclick = function(ev) {
    if (phSelected === null) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (ev.clientX - rect.left) / rect.width * W;
    const placedPh = ((mx - pad.left) / scaleW) * 14;
    if (placedPh < 0 || placedPh > 14) return;
    phPlacements[phSelected] = Math.round(placedPh * 2) / 2;
    $('ph-sub-' + phSelected).classList.add('placed');
    phSelected = null;
    document.querySelectorAll('.ph-substance').forEach(e => e.style.borderColor = '');
    drawPHPlacement();
  };
}

function phResetPlacement() {
  phPlacements = {};
  phSelected = null;
  document.querySelectorAll('.ph-substance').forEach(e => { e.classList.remove('placed'); e.style.borderColor = ''; });
  drawPHPlacement();
}

// Buffer demonstration
let bufferData = { unbuffered: 7.0, buffered: 7.4, drops: [] };

function bufferAddAcid() {
  bufferData.unbuffered = Math.max(0, bufferData.unbuffered - 0.5);
  bufferData.buffered = Math.max(6.8, bufferData.buffered - 0.05);
  bufferData.drops.push({ type: 'acid', ub: bufferData.unbuffered, buf: bufferData.buffered });
  drawBufferChart();
}

function bufferAddBase() {
  bufferData.unbuffered = Math.min(14, bufferData.unbuffered + 0.5);
  bufferData.buffered = Math.min(7.8, bufferData.buffered + 0.05);
  bufferData.drops.push({ type: 'base', ub: bufferData.unbuffered, buf: bufferData.buffered });
  drawBufferChart();
}

function bufferReset() {
  bufferData = { unbuffered: 7.0, buffered: 7.4, drops: [] };
  drawBufferChart();
}

function drawBufferChart() {
  const ctx = getCtx('ph-buffer-chart');
  if (!bufferData.drops.length) {
    ctx.clearRect(0,0,ctx.W,ctx.H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,ctx.W,ctx.H);
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Add acid or base drops to compare', ctx.W/2, ctx.H/2);

    // initial marker
    const pad = {top:20,right:20,bottom:30,left:50};
    ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'left';
    ctx.fillText('Unbuffered water: pH 7.0', pad.left, ctx.H/2 + 24);
    ctx.fillText('Buffered blood: pH 7.4', pad.left, ctx.H/2 + 42);
    return;
  }
  const ubData = [7.0, ...bufferData.drops.map(d => d.ub)];
  const bufData = [7.4, ...bufferData.drops.map(d => d.buf)];
  drawLineChart(ctx, [
    { data: ubData, color: '#c41e3a', width: 2.5, dots: true },
    { data: bufData, color: '#2563eb', width: 2.5, dots: true }
  ], { yMin: 0, yMax: 14, refLine: 7 });

  // Legend overlay
  ctx.fillStyle = '#c41e3a'; ctx.fillRect(60, 8, 12, 3);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Unbuffered', 78, 12);
  ctx.fillStyle = '#2563eb'; ctx.fillRect(160, 8, 12, 3);
  ctx.fillStyle = '#374151'; ctx.fillText('Buffered (blood)', 178, 12);
}

function drawPHBodyChart() {
  const ctx = getCtx('ph-body-chart');
  const bodyPH = [
    { label: 'Stomach', ph: 2.0, color: '#dc2626' },
    { label: 'Skin', ph: 5.5, color: '#ea580c' },
    { label: 'Saliva', ph: 6.8, color: '#ca8a04' },
    { label: 'Blood', ph: 7.4, color: '#16a34a' },
    { label: 'Pancreas', ph: 8.1, color: '#2563eb' },
    { label: 'Sm. Intest.', ph: 8.5, color: '#7c3aed' }
  ];
  drawBarChart(ctx, {
    labels: bodyPH.map(b => b.label),
    values: bodyPH.map(b => b.ph),
    colors: bodyPH.map(b => b.color),
    maxVal: 14
  });

  // 7.0 reference line
  const pad = {top:20, right:20, bottom:40, left:50};
  const plotH = ctx.H - pad.top - pad.bottom;
  const refY = pad.top + plotH * (1 - 7.0/14);
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
  ctx.beginPath(); ctx.moveTo(pad.left, refY); ctx.lineTo(ctx.W - pad.right, refY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#374151'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Neutral (7.0)', pad.left + 4, refY - 4);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 4: WATER PROPERTIES
// ══════════════════════════════════════════════════════════════════════════
let waterDemo = 'cohesion';
let waterDrops = 0;
let waterHeatTime = 0;
let waterHeatRunning = false;
let waterHeatFrame = null;
let waterDissolveProgress = 0;
let waterDissolveRunning = false;

function waterTab(tab) {
  waterDemo = tab;
  document.querySelectorAll('.demo-tab').forEach((t,i) => {
    t.classList.toggle('active', ['cohesion','adhesion','heat','solvent'][i] === tab);
  });
  updateWaterControls();
  drawWater();
  updateWaterExplain();
}

function updateWaterControls() {
  const c = $('water-controls');
  if (waterDemo === 'cohesion') {
    c.innerHTML = '<div class="btn-group"><button class="btn btn-primary" onclick="addWaterDrop()">Add Drop to Penny</button><button class="btn btn-outline" onclick="resetWaterDrops()">Reset</button></div>' +
      `<div class="stat-grid"><div class="stat-box stat-accent"><div class="stat-val" id="drop-count">${waterDrops}</div><div class="stat-label">Drops</div></div><div class="stat-box stat-blue"><div class="stat-val" id="drop-tension">${waterDrops > 0 ? (1 - waterDrops/35).toFixed(2) : '-'}</div><div class="stat-label">Surface Tension</div></div></div>`;
  } else if (waterDemo === 'adhesion') {
    c.innerHTML = '<p style="font-size:13px;color:var(--text-muted);">Observe how water rises higher in narrower tubes due to adhesion (attraction between water and glass) and cohesion working together.</p>';
  } else if (waterDemo === 'heat') {
    c.innerHTML = '<div class="btn-group"><button class="btn btn-primary" onclick="startHeating()">Start Heating</button><button class="btn btn-outline" onclick="resetHeating()">Reset</button></div>' +
      '<div class="convergence-info"><span><span class="ci-dot" style="background:#2563eb;"></span> Water (c = 4.18 J/g\u00B7\u00B0C)</span><span><span class="ci-dot" style="background:#d97706;"></span> Oil (c = 2.0 J/g\u00B7\u00B0C)</span><span><span class="ci-dot" style="background:#9ca3af;"></span> Metal (c = 0.45 J/g\u00B7\u00B0C)</span></div>';
  } else {
    c.innerHTML = '<div class="btn-group"><button class="btn btn-primary" onclick="startDissolving()">Dissolve Salt</button><button class="btn btn-outline" onclick="resetDissolving()">Reset</button></div>';
  }
}

function updateWaterExplain() {
  const explains = {
    cohesion: '<strong>Cohesion:</strong> Water molecules attract each other through hydrogen bonds. This allows water to form droplets and creates surface tension. Click the penny to add water drops and see how many it can hold before spilling!',
    adhesion: '<strong>Adhesion:</strong> Water molecules are also attracted to other surfaces (like glass). Combined with cohesion, this creates capillary action, allowing water to climb narrow tubes against gravity. Narrower tubes = higher rise.',
    heat: '<strong>High Specific Heat:</strong> Water requires more energy to change temperature than most substances. This is because hydrogen bonds must be broken before kinetic energy increases. This property moderates Earth\'s climate and body temperature.',
    solvent: '<strong>Universal Solvent:</strong> Water\'s polarity allows it to dissolve ionic compounds (like NaCl) and many polar molecules. The partial charges on water molecules surround and separate ions in a process called hydration.'
  };
  $('water-explain').innerHTML = explains[waterDemo];
}

function addWaterDrop() {
  if (waterDrops < 30) { waterDrops++; drawWater(); }
  if ($('drop-count')) { $('drop-count').textContent = waterDrops; $('drop-tension').textContent = (1 - waterDrops/35).toFixed(2); }
}
function resetWaterDrops() { waterDrops = 0; drawWater(); updateWaterControls(); }

function startHeating() {
  if (waterHeatRunning) return;
  waterHeatTime = 0; waterHeatRunning = true;
  function step() {
    waterHeatTime += 0.5;
    if (waterHeatTime >= 100) { waterHeatTime = 100; waterHeatRunning = false; }
    drawWater();
    if (waterHeatRunning) waterHeatFrame = requestAnimationFrame(step);
  }
  step();
}
function resetHeating() { waterHeatTime = 0; waterHeatRunning = false; if (waterHeatFrame) cancelAnimationFrame(waterHeatFrame); drawWater(); }

function startDissolving() {
  if (waterDissolveRunning) return;
  waterDissolveProgress = 0; waterDissolveRunning = true;
  function step() {
    waterDissolveProgress += 0.01;
    if (waterDissolveProgress >= 1) { waterDissolveProgress = 1; waterDissolveRunning = false; }
    drawWater();
    if (waterDissolveRunning) requestAnimationFrame(step);
  }
  step();
}
function resetDissolving() { waterDissolveProgress = 0; waterDissolveRunning = false; drawWater(); }

function drawWater() {
  const ctx = getCtx('water-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);

  if (waterDemo === 'cohesion') {
    drawCohesionDemo(ctx, W, H);
  } else if (waterDemo === 'adhesion') {
    drawAdhesionDemo(ctx, W, H);
  } else if (waterDemo === 'heat') {
    drawHeatDemo(ctx, W, H);
  } else {
    drawSolventDemo(ctx, W, H);
  }
}

function drawCohesionDemo(ctx, W, H) {
  const cx = W/2, pennyY = H * 0.65;

  // Title
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Surface Tension: Water Drops on a Penny', cx, 24);

  // Penny
  const pennyW = 140, pennyH = 16;
  const pennyGrad = ctx.createLinearGradient(cx - pennyW/2, pennyY, cx + pennyW/2, pennyY);
  pennyGrad.addColorStop(0, '#cd7f32'); pennyGrad.addColorStop(0.5, '#daa520'); pennyGrad.addColorStop(1, '#cd7f32');
  ctx.fillStyle = pennyGrad;
  ctx.beginPath();
  ctx.ellipse(cx, pennyY, pennyW/2, pennyH/2, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#8B6914'; ctx.lineWidth = 2; ctx.stroke();

  // Water dome
  if (waterDrops > 0) {
    const domeH = Math.min(waterDrops * 4, 100);
    const domeW = Math.min(60 + waterDrops * 2.5, pennyW - 10);
    const waterGrad = ctx.createRadialGradient(cx, pennyY - domeH/2, 5, cx, pennyY, domeW/2);
    waterGrad.addColorStop(0, 'rgba(59,130,246,0.6)');
    waterGrad.addColorStop(1, 'rgba(37,99,235,0.3)');
    ctx.fillStyle = waterGrad;
    ctx.beginPath();
    ctx.ellipse(cx, pennyY - 2, domeW/2, domeH, 0, Math.PI, 0);
    ctx.closePath();
    ctx.fill();

    // Reflection highlight
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.beginPath();
    ctx.ellipse(cx - 10, pennyY - domeH * 0.6, domeW * 0.2, domeH * 0.3, -0.3, 0, Math.PI * 2);
    ctx.fill();

    // Hydrogen bond diagram below
    if (waterDrops >= 5) {
      const diagramY = pennyY + 50;
      ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
      ctx.fillText('Hydrogen bonds hold the dome together', cx, diagramY);

      // Mini water molecules
      for (let i = 0; i < 5; i++) {
        const mx = cx - 80 + i * 40;
        const my = diagramY + 30;
        ctx.fillStyle = '#dc2626'; ctx.beginPath(); ctx.arc(mx, my, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#d1d5db'; ctx.beginPath(); ctx.arc(mx-7, my-6, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(mx+7, my-6, 4, 0, Math.PI*2); ctx.fill();
        if (i < 4) {
          ctx.strokeStyle = 'rgba(196,30,58,0.4)'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
          ctx.beginPath(); ctx.moveTo(mx+10, my); ctx.lineTo(mx+30, my); ctx.stroke();
          ctx.setLineDash([]);
        }
      }
    }
  }

  // Drop count
  ctx.fillStyle = '#374151'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(waterDrops + ' drops', cx, pennyY + pennyH + 24);

  if (waterDrops >= 28) {
    ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 12px system-ui';
    ctx.fillText('Surface tension near breaking point!', cx, 50);
  }
}

function drawAdhesionDemo(ctx, W, H) {
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Capillary Action: Water Rising in Glass Tubes', W/2, 24);

  const tubes = [
    { diameter: 60, rise: 30, label: '10mm' },
    { diameter: 40, rise: 60, label: '5mm' },
    { diameter: 24, rise: 100, label: '2mm' },
    { diameter: 14, rise: 160, label: '1mm' }
  ];

  const waterLevel = H * 0.65;
  const baseY = H * 0.85;
  const spacing = W / (tubes.length + 1);

  // Water basin
  ctx.fillStyle = 'rgba(59,130,246,0.15)';
  ctx.fillRect(30, waterLevel, W - 60, baseY - waterLevel);
  ctx.strokeStyle = '#93c5fd'; ctx.lineWidth = 2;
  ctx.strokeRect(30, waterLevel, W - 60, baseY - waterLevel);

  tubes.forEach((t, i) => {
    const cx = spacing * (i + 1);
    const tubeTop = waterLevel - t.rise - 40;

    // Glass tube
    ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx - t.diameter/2, tubeTop);
    ctx.lineTo(cx - t.diameter/2, baseY - 10);
    ctx.moveTo(cx + t.diameter/2, tubeTop);
    ctx.lineTo(cx + t.diameter/2, baseY - 10);
    ctx.stroke();

    // Water inside tube (rising)
    const waterTop = waterLevel - t.rise;
    const waterGrad = ctx.createLinearGradient(cx, waterTop, cx, waterLevel);
    waterGrad.addColorStop(0, 'rgba(37,99,235,0.5)');
    waterGrad.addColorStop(1, 'rgba(37,99,235,0.3)');
    ctx.fillStyle = waterGrad;
    ctx.fillRect(cx - t.diameter/2 + 2, waterTop, t.diameter - 4, waterLevel - waterTop);

    // Meniscus (curved water surface)
    ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx - t.diameter/2 + 2, waterTop + 4);
    ctx.quadraticCurveTo(cx, waterTop - 4, cx + t.diameter/2 - 2, waterTop + 4);
    ctx.stroke();

    // Labels
    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(t.label, cx, tubeTop - 8);
    ctx.fillStyle = '#2563eb'; ctx.font = '10px system-ui';
    ctx.fillText(t.rise + 'mm', cx, waterTop - 8);

    // Rise arrow
    ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(cx + t.diameter/2 + 8, waterLevel);
    ctx.lineTo(cx + t.diameter/2 + 8, waterTop); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx + t.diameter/2 + 4, waterTop + 6);
    ctx.lineTo(cx + t.diameter/2 + 8, waterTop);
    ctx.lineTo(cx + t.diameter/2 + 12, waterTop + 6); ctx.stroke();
  });

  // Label
  ctx.fillStyle = '#374151'; ctx.font = '12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Narrower tube = Higher rise', W/2, baseY + 16);
}

function drawHeatDemo(ctx, W, H) {
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Specific Heat Comparison', W/2, 24);

  const pad = {top:50, right:30, bottom:40, left:60};
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = pad.top + plotH * (1 - i/5);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((i * 20) + '\u00B0C', pad.left - 6, y + 4);
  }

  // X axis
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  for (let i = 0; i <= 10; i++) {
    const x = pad.left + (i/10) * plotW;
    ctx.fillText(i * 10 + 's', x, H - pad.bottom + 18);
  }
  ctx.fillText('Time (seconds of heating)', pad.left + plotW/2, H - 6);

  // Temperature curves
  const substances = [
    { name: 'Metal', c: 0.45, color: '#9ca3af' },
    { name: 'Oil', c: 2.0, color: '#d97706' },
    { name: 'Water', c: 4.18, color: '#2563eb' }
  ];

  const maxTime = 100;
  const points = 100;
  const energyPerSec = 100; // arbitrary energy input

  substances.forEach(sub => {
    ctx.strokeStyle = sub.color; ctx.lineWidth = 2.5;
    ctx.beginPath();
    for (let i = 0; i <= Math.min(waterHeatTime, maxTime); i++) {
      const temp = Math.min((energyPerSec * i) / (sub.c * 100), 100);
      const x = pad.left + (i / maxTime) * plotW;
      const y = pad.top + plotH * (1 - temp / 100);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();

    // End label
    if (waterHeatTime > 5) {
      const t = Math.min(waterHeatTime, maxTime);
      const temp = Math.min((energyPerSec * t) / (sub.c * 100), 100);
      const x = pad.left + (t / maxTime) * plotW;
      const y = pad.top + plotH * (1 - temp / 100);
      ctx.fillStyle = sub.color; ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();
      ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
      ctx.fillText(sub.name + ': ' + temp.toFixed(0) + '\u00B0C', x + 8, y + 4);
    }
  });

  // Y axis label
  ctx.save(); ctx.translate(14, pad.top + plotH/2);
  ctx.rotate(-Math.PI/2); ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
  ctx.textAlign = 'center'; ctx.fillText('Temperature', 0, 0);
  ctx.restore();
}

function drawSolventDemo(ctx, W, H) {
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Universal Solvent: Dissolving NaCl in Water', W/2, 24);

  const cx = W/2, cy = H/2;
  const beakerW = 200, beakerH = 180;
  const beakerX = cx - beakerW/2, beakerY = cy - beakerH/3;

  // Beaker
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(beakerX, beakerY);
  ctx.lineTo(beakerX, beakerY + beakerH);
  ctx.lineTo(beakerX + beakerW, beakerY + beakerH);
  ctx.lineTo(beakerX + beakerW, beakerY);
  ctx.stroke();

  // Water
  const waterTop = beakerY + 20;
  const waterGrad = ctx.createLinearGradient(cx, waterTop, cx, beakerY + beakerH);
  waterGrad.addColorStop(0, 'rgba(59,130,246,0.2)');
  waterGrad.addColorStop(1, 'rgba(37,99,235,0.35)');
  ctx.fillStyle = waterGrad;
  ctx.fillRect(beakerX + 2, waterTop, beakerW - 4, beakerH - 22);

  const t = waterDissolveProgress;

  if (t < 0.3) {
    // Salt crystal falling
    const saltY = lerp(beakerY - 30, waterTop + 20, t / 0.3);
    const saltSize = 14;
    ctx.fillStyle = '#e2e8f0'; ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1;
    ctx.fillRect(cx - saltSize, saltY - saltSize, saltSize * 2, saltSize * 2);
    ctx.strokeRect(cx - saltSize, saltY - saltSize, saltSize * 2, saltSize * 2);
    ctx.fillStyle = '#374151'; ctx.font = 'bold 10px system-ui';
    ctx.fillText('NaCl', cx, saltY + 4);
  } else {
    // Dissolving - ions separating
    const dt = (t - 0.3) / 0.7;
    const numIons = Math.floor(dt * 8);
    const ionPositions = [
      {x:-60,y:-30,type:'Na+'},{x:50,y:-20,type:'Cl-'},
      {x:-30,y:30,type:'Na+'},{x:70,y:40,type:'Cl-'},
      {x:20,y:-50,type:'Na+'},{x:-50,y:50,type:'Cl-'},
      {x:60,y:10,type:'Na+'},{x:-20,y:-10,type:'Cl-'}
    ];

    for (let i = 0; i < numIons; i++) {
      const ion = ionPositions[i];
      const ix = cx + ion.x * dt;
      const iy = waterTop + 60 + ion.y * dt;
      const isNa = ion.type === 'Na+';

      // Hydration shell
      if (dt > 0.5) {
        ctx.strokeStyle = isNa ? 'rgba(59,130,246,0.3)' : 'rgba(196,30,58,0.3)';
        ctx.lineWidth = 1; ctx.setLineDash([3,3]);
        ctx.beginPath(); ctx.arc(ix, iy, 18, 0, Math.PI*2); ctx.stroke();
        ctx.setLineDash([]);

        // Small water molecules around ion
        for (let w = 0; w < 4; w++) {
          const wa = (w / 4) * Math.PI * 2 + dt * 2;
          const wx = ix + Math.cos(wa) * 18;
          const wy = iy + Math.sin(wa) * 18;
          ctx.fillStyle = '#dc2626'; ctx.beginPath(); ctx.arc(wx, wy, 3, 0, Math.PI*2); ctx.fill();
        }
      }

      // Ion
      ctx.fillStyle = isNa ? '#d97706' : '#16a34a';
      ctx.beginPath(); ctx.arc(ix, iy, 12, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
      ctx.fillText(ion.type, ix, iy + 3);
    }
  }

  // Equation
  ctx.fillStyle = '#374151'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('NaCl(s) \u2192 Na\u207A(aq) + Cl\u207B(aq)', cx, beakerY + beakerH + 30);

  if (t >= 1) {
    ctx.fillStyle = '#16a34a'; ctx.font = '12px system-ui';
    ctx.fillText('Water molecules surround each ion (hydration shell)', cx, beakerY + beakerH + 50);
  }
}

// ══════════════════════════════════════════════════════════════════════════
// PART 5: CHEMICAL REACTIONS
// ══════════════════════════════════════════════════════════════════════════
let rxnType = 'synthesis';
let rxnAnimProgress = 0;
let rxnAnimRunning = false;
let rxnAnimFrame = null;
let enzymeActive = false;

const RXN_DATA = {
  synthesis: {
    label: 'Syn', energyChange: 'Exergonic',
    bio: '<strong>Synthesis in Biology:</strong> Dehydration synthesis joins amino acids to form proteins. Two amino acids combine, releasing a water molecule: Amino Acid + Amino Acid &rarr; Dipeptide + H<sub>2</sub>O. This is also how cells build polysaccharides from monosaccharides.'
  },
  decomposition: {
    label: 'Dec', energyChange: 'Endergonic',
    bio: '<strong>Decomposition in Biology:</strong> Hydrolysis breaks down macromolecules by adding water. Sucrose + H<sub>2</sub>O &rarr; Glucose + Fructose. Digestive enzymes catalyze these reactions to break food into absorbable nutrients.'
  },
  exchange: {
    label: 'Exch', energyChange: 'Variable',
    bio: '<strong>Exchange in Biology:</strong> In the blood, carbonic anhydrase catalyzes: CO<sub>2</sub> + H<sub>2</sub>O &harr; H<sub>2</sub>CO<sub>3</sub> &harr; H<sup>+</sup> + HCO<sub>3</sub><sup>-</sup>. This exchange reaction is critical for pH buffering and CO<sub>2</sub> transport.'
  }
};

function selectReaction(type) {
  rxnType = type;
  rxnAnimProgress = 0; rxnAnimRunning = false;
  if (rxnAnimFrame) cancelAnimationFrame(rxnAnimFrame);
  document.querySelectorAll('#part5 .bond-type-btn').forEach((b,i) => {
    b.classList.toggle('active', ['synthesis','decomposition','exchange'][i] === type);
  });
  const d = RXN_DATA[type];
  $('rxn-type-label').textContent = d.label;
  $('rxn-energy').textContent = d.energyChange;
  $('rxn-bio-example').innerHTML = d.bio;
  drawReaction();
  drawEnergyDiagram();
}

function toggleEnzyme() {
  enzymeActive = $('enzyme-toggle').checked;
  $('rxn-enzyme').textContent = enzymeActive ? 'On' : 'Off';
  drawEnergyDiagram();
}

function reactionAnimate() {
  if (rxnAnimRunning) return;
  rxnAnimProgress = 0; rxnAnimRunning = true;
  const speed = enzymeActive ? 0.025 : 0.012;
  function step() {
    rxnAnimProgress += speed;
    if (rxnAnimProgress >= 1) { rxnAnimProgress = 1; rxnAnimRunning = false; }
    drawReaction();
    if (rxnAnimRunning) rxnAnimFrame = requestAnimationFrame(step);
  }
  step();
}

function reactionReset() {
  rxnAnimProgress = 0; rxnAnimRunning = false;
  if (rxnAnimFrame) cancelAnimationFrame(rxnAnimFrame);
  drawReaction();
}

function drawReaction() {
  const ctx = getCtx('reaction-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);
  const cx = W/2, cy = H/2;
  const t = rxnAnimProgress;

  const titles = {
    synthesis: 'Synthesis: A + B \u2192 AB',
    decomposition: 'Decomposition: AB \u2192 A + B',
    exchange: 'Exchange: AB + CD \u2192 AD + CB'
  };
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(titles[rxnType], cx, 22);

  if (rxnType === 'synthesis') {
    const sep = lerp(120, 0, t);
    const aX = cx - sep - 20, bX = cx + sep + 20;
    // Molecule A
    drawMoleculeCircle(ctx, aX, cy, 28, '#c41e3a', 'A');
    // Molecule B
    drawMoleculeCircle(ctx, bX, cy, 28, '#2563eb', 'B');

    if (t >= 0.8) {
      // Combined molecule
      const alpha = (t - 0.8) / 0.2;
      ctx.strokeStyle = `rgba(22,163,74,${alpha})`; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.ellipse(cx, cy, 60, 34, 0, 0, Math.PI*2); ctx.stroke();
      ctx.fillStyle = `rgba(22,163,74,${alpha})`; ctx.font = 'bold 14px system-ui';
      ctx.fillText('AB', cx, cy + 60);
    }

    // Arrow
    ctx.fillStyle = '#374151'; ctx.font = '20px system-ui';
    ctx.fillText('\u2192', cx, cy + 90);

  } else if (rxnType === 'decomposition') {
    const sep = lerp(0, 120, t);

    if (t < 0.3) {
      // Combined molecule
      ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.ellipse(cx, cy, 60, 34, 0, 0, Math.PI*2); ctx.stroke();
    }

    // Separating molecules
    drawMoleculeCircle(ctx, cx - sep - 20, cy, 28, '#c41e3a', 'A');
    drawMoleculeCircle(ctx, cx + sep + 20, cy, 28, '#2563eb', 'B');

    if (t > 0.5) {
      // Energy input indicator
      const alpha = Math.sin((t - 0.5) * Math.PI * 2) * 0.5 + 0.5;
      ctx.fillStyle = `rgba(217,119,6,${alpha})`; ctx.font = 'bold 12px system-ui';
      ctx.fillText('\u26A1 Energy Input', cx, cy - 60);
    }

  } else {
    // Exchange: AB + CD -> AD + CB
    const phase1 = Math.min(t / 0.5, 1); // approach
    const phase2 = Math.max(0, (t - 0.5) / 0.5); // rearrange

    const sep1 = lerp(130, 40, phase1);
    const sep2 = lerp(0, 100, phase2);

    // Before exchange
    if (t < 0.5) {
      drawMoleculeCircle(ctx, cx - sep1, cy - 20, 20, '#c41e3a', 'A');
      drawMoleculeCircle(ctx, cx - sep1 + 30, cy - 20, 20, '#2563eb', 'B');
      drawMoleculeCircle(ctx, cx + sep1 - 30, cy + 20, 20, '#16a34a', 'C');
      drawMoleculeCircle(ctx, cx + sep1, cy + 20, 20, '#d97706', 'D');
    } else {
      // After exchange - new pairs
      drawMoleculeCircle(ctx, cx - sep2, cy - 20, 20, '#c41e3a', 'A');
      drawMoleculeCircle(ctx, cx - sep2 + 30, cy - 20, 20, '#d97706', 'D');
      drawMoleculeCircle(ctx, cx + sep2 - 30, cy + 20, 20, '#16a34a', 'C');
      drawMoleculeCircle(ctx, cx + sep2, cy + 20, 20, '#2563eb', 'B');
    }
  }

  // Enzyme badge
  if (enzymeActive) {
    ctx.fillStyle = '#f0fdf4'; ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2;
    const bx = W - 90, by = 10;
    ctx.beginPath(); ctx.roundRect(bx, by, 80, 28, 6); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#16a34a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Enzyme ON', bx + 40, by + 18);
  }
}

function drawMoleculeCircle(ctx, x, y, r, color, label) {
  const grad = ctx.createRadialGradient(x-3, y-3, 2, x, y, r);
  grad.addColorStop(0, color + '99'); grad.addColorStop(1, color);
  ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText(label, x, y + 5);
}

function drawEnergyDiagram() {
  const ctx = getCtx('energy-diagram');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);
  const pad = {top:40, right:30, bottom:30, left:60};
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;

  // Title
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 13px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Energy Diagram', W/2, 18);

  // Axes
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, pad.top + plotH); ctx.lineTo(pad.left + plotW, pad.top + plotH); ctx.stroke();

  // Y label
  ctx.save(); ctx.translate(16, pad.top + plotH/2);
  ctx.rotate(-Math.PI/2); ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui';
  ctx.textAlign = 'center'; ctx.fillText('Free Energy', 0, 0);
  ctx.restore();

  // X label
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Reaction Progress', pad.left + plotW/2, H - 6);

  // Energy levels
  const isExergonic = rxnType === 'synthesis';
  const reactantE = isExergonic ? 0.65 : 0.35;
  const productE = isExergonic ? 0.35 : 0.65;
  const peakE = enzymeActive ? Math.max(reactantE, productE) + 0.1 : Math.max(reactantE, productE) + 0.3;

  const rY = pad.top + plotH * (1 - reactantE);
  const pY = pad.top + plotH * (1 - productE);
  const peakY = pad.top + plotH * (1 - peakE);

  // Reactant level
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(pad.left, rY); ctx.lineTo(pad.left + plotW * 0.25, rY); ctx.stroke();

  // Curve to peak
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(pad.left + plotW * 0.25, rY);
  ctx.quadraticCurveTo(pad.left + plotW * 0.5, peakY - 20, pad.left + plotW * 0.5, peakY);
  ctx.quadraticCurveTo(pad.left + plotW * 0.5, peakY - 20 + (pY - peakY + 20)*2, pad.left + plotW * 0.75, pY);
  ctx.stroke();

  // Product level
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(pad.left + plotW * 0.75, pY); ctx.lineTo(pad.left + plotW, pY); ctx.stroke();

  // Enzyme curve (lower activation energy)
  if (enzymeActive) {
    const enzPeakY = pad.top + plotH * (1 - (Math.max(reactantE, productE) + 0.1));
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
    ctx.beginPath();
    ctx.moveTo(pad.left + plotW * 0.25, rY);
    ctx.quadraticCurveTo(pad.left + plotW * 0.5, enzPeakY - 10, pad.left + plotW * 0.5, enzPeakY);
    ctx.quadraticCurveTo(pad.left + plotW * 0.5, enzPeakY - 10 + (pY - enzPeakY + 10)*2, pad.left + plotW * 0.75, pY);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Labels
  ctx.fillStyle = '#2563eb'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'right';
  ctx.fillText('Reactants', pad.left + plotW * 0.23, rY - 8);
  ctx.fillStyle = '#16a34a'; ctx.textAlign = 'left';
  ctx.fillText('Products', pad.left + plotW * 0.77, pY - 8);
  ctx.fillStyle = '#c41e3a'; ctx.textAlign = 'center';
  ctx.fillText('Ea' + (enzymeActive ? ' (no enzyme)' : ''), pad.left + plotW * 0.5, peakY - 8);

  // Delta G arrow
  const midX = pad.left + plotW * 0.88;
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(midX, rY); ctx.lineTo(midX, pY); ctx.stroke();
  ctx.beginPath();
  if (isExergonic) {
    ctx.moveTo(midX - 4, pY - 6); ctx.lineTo(midX, pY); ctx.lineTo(midX + 4, pY - 6);
  } else {
    ctx.moveTo(midX - 4, rY + 6); ctx.lineTo(midX, rY); ctx.lineTo(midX + 4, rY + 6);
  }
  ctx.stroke();
  ctx.fillStyle = '#d97706'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText(isExergonic ? '-\u0394G' : '+\u0394G', midX + 6, (rY + pY) / 2 + 4);
}

// ══════════════════════════════════════════════════════════════════════════
// PART 6: BODY CHEMISTRY
// ══════════════════════════════════════════════════════════════════════════
let bodyRegion = 'stomach';

const BODY_DATA = {
  stomach: {
    ph: '2.0', chemical: 'HCl', function: 'Digest',
    color: '#dc2626',
    equation: '<strong>Stomach Chemistry:</strong><br>HCl &rarr; H<sup>+</sup> + Cl<sup>-</sup><br><br>Hydrochloric acid dissociates to create an extremely acidic environment (pH 1.5-3.5). This activates pepsinogen into pepsin, which breaks down proteins. The stomach lining is protected by a thick mucus layer.',
    highlight: {x: 0.5, y: 0.45, r: 0.06}
  },
  blood: {
    ph: '7.4', chemical: 'HCO\u2083\u207B', function: 'Buffer',
    color: '#c41e3a',
    equation: '<strong>Blood Chemistry:</strong><br>CO<sub>2</sub> + H<sub>2</sub>O &harr; H<sub>2</sub>CO<sub>3</sub> &harr; H<sup>+</sup> + HCO<sub>3</sub><sup>-</sup><br><br>The bicarbonate buffer system maintains blood pH at exactly 7.35-7.45. Even small deviations (acidosis or alkalosis) can be life-threatening. Hemoglobin also acts as a buffer.',
    highlight: {x: 0.5, y: 0.32, r: 0.05}
  },
  bones: {
    ph: '7.4', chemical: 'Ca\u00B2\u207A', function: 'Structure',
    color: '#d97706',
    equation: '<strong>Bone Chemistry:</strong><br>Ca<sub>10</sub>(PO<sub>4</sub>)<sub>6</sub>(OH)<sub>2</sub> (Hydroxyapatite)<br><br>Bones are composed of calcium phosphate crystals (hydroxyapatite) embedded in collagen fibers. Osteoblasts deposit calcium; osteoclasts resorb it. Blood calcium levels are regulated by parathyroid hormone and calcitonin.',
    highlight: {x: 0.5, y: 0.62, r: 0.04}
  },
  muscles: {
    ph: '7.0', chemical: 'ATP', function: 'Energy',
    color: '#7c3aed',
    equation: '<strong>Muscle Chemistry:</strong><br>ATP &rarr; ADP + P<sub>i</sub> + Energy<br>Glucose &rarr; 2 Lactic Acid (anaerobic)<br><br>Muscle contraction requires ATP hydrolysis. During intense exercise, anaerobic glycolysis produces lactic acid, lowering pH from 7.0 to ~6.5, causing fatigue and the burning sensation.',
    highlight: {x: 0.5, y: 0.52, r: 0.07}
  }
};

function selectBodyRegion(region) {
  bodyRegion = region;
  const d = BODY_DATA[region];
  document.querySelectorAll('.body-region').forEach(r => r.classList.remove('active'));
  document.querySelector(`.body-region[onclick="selectBodyRegion('${region}')"]`).classList.add('active');
  $('body-ph').textContent = d.ph;
  $('body-key-ion').textContent = d.chemical;
  $('body-function').textContent = d.function;
  $('body-equation').innerHTML = d.equation;
  drawBody();
}

function drawBody() {
  const ctx = getCtx('body-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0,0,W,H); ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,W,H);
  const cx = W/2, cy = H/2;

  // Title
  ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Human Body Chemistry Map', cx, 24);

  // Body outline (simplified)
  ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2;

  // Head
  ctx.beginPath(); ctx.arc(cx, 70, 28, 0, Math.PI*2); ctx.stroke();

  // Neck
  ctx.beginPath(); ctx.moveTo(cx-8, 98); ctx.lineTo(cx-8, 115);
  ctx.moveTo(cx+8, 98); ctx.lineTo(cx+8, 115); ctx.stroke();

  // Torso
  ctx.beginPath();
  ctx.moveTo(cx-50, 115); ctx.lineTo(cx-60, 140); ctx.lineTo(cx-55, 260);
  ctx.lineTo(cx-40, 280); ctx.lineTo(cx-20, 285);
  ctx.lineTo(cx, 290); ctx.lineTo(cx+20, 285);
  ctx.lineTo(cx+40, 280); ctx.lineTo(cx+55, 260);
  ctx.lineTo(cx+60, 140); ctx.lineTo(cx+50, 115);
  ctx.closePath(); ctx.stroke();

  // Arms
  ctx.beginPath();
  ctx.moveTo(cx-60, 130); ctx.lineTo(cx-85, 180); ctx.lineTo(cx-90, 240);
  ctx.moveTo(cx+60, 130); ctx.lineTo(cx+85, 180); ctx.lineTo(cx+90, 240);
  ctx.stroke();

  // Legs
  ctx.beginPath();
  ctx.moveTo(cx-25, 285); ctx.lineTo(cx-30, 380); ctx.lineTo(cx-35, 440);
  ctx.moveTo(cx+25, 285); ctx.lineTo(cx+30, 380); ctx.lineTo(cx+35, 440);
  ctx.stroke();

  // Organ highlights
  const regions = {
    stomach: { x: cx+10, y: 200, w: 35, h: 30, label: 'Stomach' },
    blood: { x: cx, y: 160, w: 25, h: 25, label: 'Heart/Blood' },
    bones: { x: cx-30, y: 320, w: 20, h: 60, label: 'Bones' },
    muscles: { x: cx+30, y: 240, w: 25, h: 40, label: 'Muscles' }
  };

  Object.entries(regions).forEach(([key, reg]) => {
    const isActive = key === bodyRegion;
    const d = BODY_DATA[key];

    if (isActive) {
      // Glow effect
      ctx.fillStyle = d.color + '30';
      ctx.beginPath();
      ctx.ellipse(reg.x, reg.y, reg.w + 10, reg.h/2 + 10, 0, 0, Math.PI*2);
      ctx.fill();
    }

    ctx.fillStyle = isActive ? d.color + '60' : '#e2e8f0';
    ctx.strokeStyle = isActive ? d.color : '#94a3b8';
    ctx.lineWidth = isActive ? 2.5 : 1;
    ctx.beginPath();
    ctx.ellipse(reg.x, reg.y, reg.w, reg.h/2, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Label
    ctx.fillStyle = isActive ? d.color : '#9ca3af';
    ctx.font = (isActive ? 'bold ' : '') + '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(reg.label, reg.x, reg.y + reg.h/2 + 14);

    if (isActive) {
      // pH badge
      ctx.fillStyle = d.color;
      ctx.beginPath(); ctx.roundRect(reg.x - 18, reg.y - 10, 36, 20, 4); ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font = 'bold 11px system-ui';
      ctx.fillText('pH ' + d.ph, reg.x, reg.y + 4);
    }
  });

  // Click handler for body canvas
  const canvas = $('body-canvas');
  canvas.onclick = function(ev) {
    const rect = canvas.getBoundingClientRect();
    const mx = (ev.clientX - rect.left) / rect.width * W;
    const my = (ev.clientY - rect.top) / rect.height * H;

    Object.entries(regions).forEach(([key, reg]) => {
      const dx = mx - reg.x, dy = my - reg.y;
      if (Math.abs(dx) < reg.w + 15 && Math.abs(dy) < reg.h/2 + 15) {
        selectBodyRegion(key);
      }
    });
  };
}

// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR SCROLL HIGHLIGHT
// ══════════════════════════════════════════════════════════════════════════
function updateSidebar() {
  const sections = document.querySelectorAll('.section, .hero');
  const links = document.querySelectorAll('.sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    if (window.scrollY >= s.offsetTop - 100) current = s.id;
  });
  links.forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateSidebar);

// ══════════════════════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  buildPeriodicMini();
  selectElement('H');
  selectBondType('ionic');
  phUpdate();
  drawPHScale();
  buildPHSubstances();
  drawPHPlacement();
  drawBufferChart();
  drawPHBodyChart();
  waterTab('cohesion');
  selectReaction('synthesis');
  drawBody();
});

window.addEventListener('resize', () => {
  drawAtom();
  drawBond();
  drawBondEnergyChart();
  drawPHScale();
  drawPHPlacement();
  drawBufferChart();
  drawPHBodyChart();
  drawWater();
  drawReaction();
  drawEnergyDiagram();
  drawBody();
});
</script>
</body>
</html>
