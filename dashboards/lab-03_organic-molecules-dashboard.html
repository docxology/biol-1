<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 3 Dashboard: Organic Molecules | BIOL-1</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.card-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3, .card-row-4 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
.btn-active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   MACROMOLECULE CARDS
   ═══════════════════════════════════════════════════════════════════════ */
.macro-card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 20px; border: 2px solid var(--border); cursor: pointer;
  transition: all 0.2s;
}
.macro-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.macro-card.selected { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(196,30,58,0.15), var(--shadow-lg); }
.macro-card .macro-icon { font-size: 28px; margin-bottom: 8px; }
.macro-card .macro-name { font-size: 16px; font-weight: 800; margin-bottom: 4px; }
.macro-card .macro-detail { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
.macro-card .macro-detail strong { color: var(--text); }
.element-tags { display: flex; gap: 4px; flex-wrap: wrap; margin: 8px 0; }
.element-tag {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 6px; font-size: 12px; font-weight: 800;
  background: #f1f5f9; border: 1px solid var(--border); color: var(--text);
}
.element-tag.present { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   TEST TUBE STYLES
   ═══════════════════════════════════════════════════════════════════════ */
.lab-bench { display: flex; gap: 24px; flex-wrap: wrap; align-items: flex-start; }
.lab-controls { flex: 1; min-width: 250px; }
.lab-visual { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.results-table {
  width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 16px;
}
.results-table th, .results-table td {
  padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border);
}
.results-table th { background: #f8fafc; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
.results-table td.positive { color: var(--green); font-weight: 700; }
.results-table td.negative { color: var(--text-muted); }

/* ═══════════════════════════════════════════════════════════════════════
   MATCHING GAME
   ═══════════════════════════════════════════════════════════════════════ */
.match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
.match-col-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
.match-item {
  padding: 10px 14px; border-radius: 8px; margin-bottom: 6px; font-size: 13px; font-weight: 600;
  border: 2px solid var(--border); cursor: pointer; transition: all 0.15s; background: #fff;
}
.match-item:hover { border-color: var(--blue); background: #eff6ff; }
.match-item.selected { border-color: var(--accent); background: #fef2f2; color: var(--accent); }
.match-item.correct { border-color: var(--green); background: #f0fdf4; color: var(--green); cursor: default; }
.match-item.wrong { border-color: var(--accent); background: #fef2f2; animation: shake 0.4s ease; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
@keyframes cellPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
  .card-row-4 { grid-template-columns: 1fr 1fr; }
  .match-grid { grid-template-columns: 1fr; }
}
@media (max-width: 500px) {
  .card-row-4 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-1: Biology</h1>
    <p>Lab 3 &mdash; Organic Molecules</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Macromolecule Explorer</a>
    <a href="#part2"><span class="nav-num">2</span> Indicator Tests</a>
    <a href="#part3"><span class="nav-num">3</span> Synthesis &amp; Hydrolysis</a>
    <a href="#part4"><span class="nav-num">4</span> Polymer Builder</a>
    <a href="#part5"><span class="nav-num">5</span> Structure-Function</a>
    <a href="#part6"><span class="nav-num">6</span> Element Composition</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-1</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Organic Molecules</h2>
  <p>Explore the four major classes of biological macromolecules through interactive simulations. Perform virtual indicator tests, build polymers, and discover the connection between molecular structure and biological function.</p>
  <div class="bio-tags">
    <span class="bio-tag">Organic Chemistry</span>
    <span class="bio-tag">Macromolecules</span>
    <span class="bio-tag">Structure &amp; Function</span>
  </div>
</div>

<!-- ═══════════════════════════════════ PART 1: MACROMOLECULE EXPLORER ════════════════════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Macromolecule Explorer</div>
    <div class="section-subtitle">Click each card to explore the four classes of biological macromolecules</div></div>
  </div>
  <div class="stat-grid" style="margin-bottom:16px;">
    <div class="stat-box stat-accent"><div class="stat-val" id="macro-explored">0</div><div class="stat-label">Explored</div></div>
    <div class="stat-box stat-blue"><div class="stat-val" id="macro-total">4</div><div class="stat-label">Total Types</div></div>
    <div class="stat-box stat-green"><div class="stat-val" id="macro-progress">0%</div><div class="stat-label">Progress</div></div>
    <div class="stat-box stat-amber"><div class="stat-val" id="macro-elements">0</div><div class="stat-label">Elements Seen</div></div>
  </div>
  <div class="card-row-4" id="macro-grid">
    <!-- Cards inserted by JS -->
  </div>
  <div class="card" id="macro-detail-panel" style="display:none; margin-top:16px;">
    <div class="card-title" id="macro-detail-title"></div>
    <div id="macro-detail-content"></div>
  </div>
</div>

<!-- ═══════════════════════════════════ PART 2: INDICATOR TEST SIMULATOR ═══════════════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Indicator Test Simulator</div>
    <div class="section-subtitle">Virtual lab bench &mdash; test biological samples with chemical indicators</div></div>
  </div>
  <div class="card">
    <div class="card-title">Lab Bench</div>
    <div class="lab-bench">
      <div class="lab-controls">
        <p style="font-size:13px;font-weight:700;margin-bottom:6px;">Select an Indicator Test:</p>
        <div class="btn-group" id="test-btns">
          <button class="btn btn-outline btn-sm" onclick="selectTest('benedict')">Benedict's</button>
          <button class="btn btn-outline btn-sm" onclick="selectTest('iodine')">Iodine</button>
          <button class="btn btn-outline btn-sm" onclick="selectTest('biuret')">Biuret</button>
          <button class="btn btn-outline btn-sm" onclick="selectTest('sudan')">Sudan IV</button>
        </div>
        <p style="font-size:13px;font-weight:700;margin:12px 0 6px;">Select a Sample:</p>
        <div class="btn-group" id="sample-btns">
          <button class="btn btn-outline btn-sm" onclick="selectSample('glucose')">Glucose</button>
          <button class="btn btn-outline btn-sm" onclick="selectSample('starch')">Starch</button>
          <button class="btn btn-outline btn-sm" onclick="selectSample('albumin')">Albumin</button>
          <button class="btn btn-outline btn-sm" onclick="selectSample('oil')">Vegetable Oil</button>
          <button class="btn btn-outline btn-sm" onclick="selectSample('water')">Water (Control)</button>
          <button class="btn btn-outline btn-sm" onclick="selectSample('unknown')">Unknown</button>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="runTest()">Run Test</button>
          <button class="btn btn-outline" onclick="resetTests()">Reset All</button>
        </div>
        <div class="stat-grid">
          <div class="stat-box stat-accent"><div class="stat-val" id="test-run-count">0</div><div class="stat-label">Tests Run</div></div>
          <div class="stat-box stat-green"><div class="stat-val" id="test-positive-count">0</div><div class="stat-label">Positive</div></div>
          <div class="stat-box stat-blue"><div class="stat-val" id="test-negative-count">0</div><div class="stat-label">Negative</div></div>
          <div class="stat-box stat-purple"><div class="stat-val" id="test-unknown-score">-</div><div class="stat-label">Unknown ID</div></div>
        </div>
      </div>
      <div class="lab-visual">
        <canvas id="test-tube-canvas" width="180" height="320" style="border-radius:8px;"></canvas>
        <div id="test-label" style="font-size:13px;color:var(--text-muted);text-align:center;"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Results Table</div>
    <div style="overflow-x:auto;">
      <table class="results-table" id="results-table">
        <thead>
          <tr><th>Test</th><th>Sample</th><th>Expected Color</th><th>Result</th></tr>
        </thead>
        <tbody id="results-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ PART 3: DEHYDRATION SYNTHESIS & HYDROLYSIS ═══════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">Dehydration Synthesis &amp; Hydrolysis</div>
    <div class="section-subtitle">Watch monomers join together and polymers break apart</div></div>
  </div>
  <div class="card">
    <div class="card-title">Reaction Animation</div>
    <div class="btn-group">
      <button class="btn btn-primary" id="rxn-toggle-btn" onclick="toggleReactionMode()">Mode: Dehydration Synthesis</button>
      <button class="btn btn-secondary" id="rxn-play-btn" onclick="toggleReactionPlay()">Play</button>
      <button class="btn btn-outline" onclick="resetReaction()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="reaction-canvas" height="280"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="rxn-monomers">2</div><div class="stat-label">Monomers</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="rxn-polymers">0</div><div class="stat-label">Bonds Formed</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="rxn-water">0</div><div class="stat-label">H&#8322;O Released</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="rxn-step">0</div><div class="stat-label">Step</div></div>
    </div>
    <div class="analysis-result" id="rxn-explanation">
      <div class="ar-title">How It Works</div>
      <p><strong>Dehydration Synthesis:</strong> Two monomers are joined by removing a water molecule (H&#8322;O). An &ndash;OH from one monomer and an &ndash;H from the other combine to form water, creating a covalent bond between the monomers.</p>
      <p style="margin-top:8px;"><strong>Hydrolysis:</strong> A water molecule is added across a bond, breaking the polymer back into monomers. The &ndash;OH and &ndash;H from water are added to the separated monomers.</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ PART 4: POLYMER BUILDER ══════════════════════════════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Polymer Builder</div>
    <div class="section-subtitle">Add monomers one at a time and watch your polymer chain grow</div></div>
  </div>
  <div class="card">
    <div class="card-title">Select Macromolecule Type</div>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="setPolymerType('carb')">Carbohydrate</button>
      <button class="btn btn-outline" onclick="setPolymerType('protein')">Protein</button>
      <button class="btn btn-outline" onclick="setPolymerType('nucleic')">Nucleic Acid</button>
      <button class="btn btn-outline" onclick="setPolymerType('lipid')">Lipid (Triglyceride)</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="addMonomer()">Add Monomer</button>
      <button class="btn btn-secondary" onclick="addMonomerBatch(5)">Add 5</button>
      <button class="btn btn-outline" onclick="resetPolymer()">Reset</button>
    </div>
    <div class="chart-wrap"><canvas id="polymer-canvas" height="200"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="poly-count">0</div><div class="stat-label">Monomers</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="poly-bonds">0</div><div class="stat-label">Bonds</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="poly-water">0</div><div class="stat-label">H&#8322;O Produced</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="poly-type">-</div><div class="stat-label">Type</div></div>
    </div>
    <div id="poly-info" class="analysis-result" style="display:none;"></div>
  </div>
</div>

<!-- ═══════════════════════════════════ PART 5: STRUCTURE-FUNCTION MATCHING ══════════════════════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Structure&ndash;Function Matching</div>
    <div class="section-subtitle">Match molecular structures to their biological functions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Matching Game</div>
    <div class="stat-grid" style="margin-bottom:16px;">
      <div class="stat-box stat-accent"><div class="stat-val" id="match-score">0</div><div class="stat-label">Score</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="match-attempts">0</div><div class="stat-label">Attempts</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="match-correct">0</div><div class="stat-label">Correct</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="match-timer">0:00</div><div class="stat-label">Time</div></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="startMatchGame()">New Game</button>
    </div>
    <div class="match-grid" id="match-grid">
      <div>
        <div class="match-col-title">Molecule / Structure</div>
        <div id="match-left"></div>
      </div>
      <div>
        <div class="match-col-title">Biological Function</div>
        <div id="match-right"></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ PART 6: ELEMENT COMPOSITION ══════════════════════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Element Composition Comparison</div>
    <div class="section-subtitle">Compare elemental ratios across macromolecule types &mdash; click to highlight</div></div>
  </div>
  <div class="card">
    <div class="card-title">Elemental Composition (Approximate %)</div>
    <div class="btn-group">
      <button class="btn btn-outline btn-sm" onclick="highlightElement('all')">Show All</button>
      <button class="btn btn-outline btn-sm" onclick="highlightElement('carb')">Carbohydrates</button>
      <button class="btn btn-outline btn-sm" onclick="highlightElement('lipid')">Lipids</button>
      <button class="btn btn-outline btn-sm" onclick="highlightElement('protein')">Proteins</button>
      <button class="btn btn-outline btn-sm" onclick="highlightElement('nucleic')">Nucleic Acids</button>
    </div>
    <div class="chart-wrap"><canvas id="element-chart" height="320"></canvas></div>
    <div class="analysis-result ar-pass" style="margin-top:12px;">
      <div class="ar-title">Why Lipids Store More Energy</div>
      <p>Lipids have a much higher proportion of C&ndash;H bonds relative to C&ndash;O bonds compared to carbohydrates. Since C&ndash;H bonds release more energy when oxidized than C&ndash;O bonds, lipids yield approximately <code>9 kcal/g</code> versus <code>4 kcal/g</code> for carbohydrates. This is why fats are the most energy-dense macromolecule.</p>
    </div>
  </div>
  <div class="card">
    <div class="card-title">C:H Ratio Comparison &mdash; Energy Density Proxy</div>
    <div class="chart-wrap"><canvas id="ch-ratio-chart" height="220"></canvas></div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// ── Utility ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

// ── Sidebar active link ──────────────────────────────────────────────────
(function() {
  const links = document.querySelectorAll('.sidebar-nav a');
  const sections = Array.from(links).map(a => document.querySelector(a.getAttribute('href'))).filter(Boolean);
  window.addEventListener('scroll', () => {
    let current = '';
    sections.forEach(s => { if (s.getBoundingClientRect().top <= 120) current = s.id; });
    links.forEach(a => {
      a.classList.remove('active');
      if (a.getAttribute('href') === '#' + current) a.classList.add('active');
    });
  });
})();

// ── Chart helper ─────────────────────────────────────────────────────────
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    // label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    // value on top
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 1 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  // expected line
  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  // ref line
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    // dots
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}

// ══════════════════════════════════════════════════════════════════════════
// PART 1: MACROMOLECULE EXPLORER
// ══════════════════════════════════════════════════════════════════════════
const macroData = [
  {
    id: 'carb', name: 'Carbohydrates', icon: '\u{1F35E}',
    monomer: 'Monosaccharide', polymer: 'Polysaccharide',
    elements: { C: true, H: true, O: true, N: false, P: false, S: false },
    functions: ['Quick energy source (glucose)', 'Energy storage (starch, glycogen)', 'Structural support (cellulose, chitin)'],
    examples: ['Glucose', 'Sucrose', 'Starch', 'Glycogen', 'Cellulose', 'Chitin'],
    ratio: 'C:H:O in approx. 1:2:1 ratio',
    color: '#c41e3a'
  },
  {
    id: 'lipid', name: 'Lipids', icon: '\u{1F9C8}',
    monomer: 'Glycerol + Fatty Acids', polymer: 'Triglycerides / Phospholipids',
    elements: { C: true, H: true, O: true, N: false, P: false, S: false },
    functions: ['Long-term energy storage', 'Cell membrane structure (phospholipids)', 'Insulation & protection', 'Hormone signaling (steroids)'],
    examples: ['Triglycerides (fats/oils)', 'Phospholipids', 'Cholesterol', 'Waxes', 'Steroids'],
    ratio: 'High C:H ratio, very few O atoms',
    color: '#d97706'
  },
  {
    id: 'protein', name: 'Proteins', icon: '\u{1F969}',
    monomer: 'Amino Acid', polymer: 'Polypeptide',
    elements: { C: true, H: true, O: true, N: true, P: false, S: true },
    functions: ['Enzymes (catalyze reactions)', 'Structural support (keratin, collagen)', 'Transport (hemoglobin)', 'Immune defense (antibodies)', 'Movement (actin, myosin)'],
    examples: ['Hemoglobin', 'Insulin', 'Keratin', 'Collagen', 'Antibodies', 'Enzymes'],
    ratio: 'Contains N in every amino acid; some contain S',
    color: '#2563eb'
  },
  {
    id: 'nucleic', name: 'Nucleic Acids', icon: '\u{1F9EC}',
    monomer: 'Nucleotide', polymer: 'Polynucleotide',
    elements: { C: true, H: true, O: true, N: true, P: true, S: false },
    functions: ['Store genetic information (DNA)', 'Carry genetic instructions (mRNA)', 'Energy currency (ATP)', 'Regulate gene expression'],
    examples: ['DNA', 'mRNA', 'tRNA', 'rRNA', 'ATP', 'GTP'],
    ratio: 'Only macromolecule always containing P',
    color: '#7c3aed'
  }
];

let exploredSet = new Set();

function buildMacroCards() {
  const grid = $('macro-grid');
  grid.innerHTML = '';
  macroData.forEach(m => {
    const card = document.createElement('div');
    card.className = 'macro-card';
    card.id = 'macro-card-' + m.id;
    card.onclick = () => selectMacro(m.id);
    const elTags = ['C','H','O','N','P','S'].map(e =>
      `<span class="element-tag ${m.elements[e] ? 'present' : ''}">${e}</span>`
    ).join('');
    card.innerHTML = `
      <div class="macro-icon">${m.icon}</div>
      <div class="macro-name" style="color:${m.color}">${m.name}</div>
      <div class="macro-detail"><strong>Monomer:</strong> ${m.monomer}</div>
      <div class="macro-detail"><strong>Polymer:</strong> ${m.polymer}</div>
      <div class="element-tags">${elTags}</div>
    `;
    grid.appendChild(card);
  });
}

function selectMacro(id) {
  exploredSet.add(id);
  // highlight card
  document.querySelectorAll('.macro-card').forEach(c => c.classList.remove('selected'));
  $('macro-card-' + id).classList.add('selected');
  // update stats
  $('macro-explored').textContent = exploredSet.size;
  $('macro-progress').textContent = Math.round(exploredSet.size / 4 * 100) + '%';
  // count unique elements seen
  const elSeen = new Set();
  exploredSet.forEach(eid => {
    const m = macroData.find(x => x.id === eid);
    Object.entries(m.elements).forEach(([e, v]) => { if (v) elSeen.add(e); });
  });
  $('macro-elements').textContent = elSeen.size;

  // show detail panel
  const m = macroData.find(x => x.id === id);
  const panel = $('macro-detail-panel');
  panel.style.display = 'block';
  $('macro-detail-title').innerHTML = `<span style="color:${m.color}">${m.icon} ${m.name}</span>`;
  $('macro-detail-content').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px;">
      <div>
        <p style="font-size:13px;"><strong>Monomer:</strong> ${m.monomer}</p>
        <p style="font-size:13px;"><strong>Polymer:</strong> ${m.polymer}</p>
        <p style="font-size:13px;margin-top:4px;"><strong>Ratio Note:</strong> ${m.ratio}</p>
        <p style="font-size:13px;margin-top:8px;font-weight:700;">Elements Present:</p>
        <div class="element-tags" style="margin-top:4px;">
          ${['C','H','O','N','P','S'].map(e =>
            `<span class="element-tag ${m.elements[e] ? 'present' : ''}" style="${m.elements[e] ? 'background:'+m.color+';border-color:'+m.color : ''}">${e}</span>`
          ).join('')}
        </div>
      </div>
      <div>
        <p style="font-size:13px;font-weight:700;">Key Functions:</p>
        <ul style="font-size:13px;padding-left:18px;margin-top:4px;">
          ${m.functions.map(f => `<li>${f}</li>`).join('')}
        </ul>
        <p style="font-size:13px;font-weight:700;margin-top:8px;">Examples:</p>
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">
          ${m.examples.map(e => `<span class="badge" style="background:${m.color}20;color:${m.color};">${e}</span>`).join('')}
        </div>
      </div>
    </div>
  `;
}

// ══════════════════════════════════════════════════════════════════════════
// PART 2: INDICATOR TEST SIMULATOR
// ══════════════════════════════════════════════════════════════════════════
let currentTest = null;
let currentSample = null;
let testResults = [];
let testRunCount = 0;
let testPositiveCount = 0;
let testNegativeCount = 0;
// The unknown is randomly one of the known samples
let unknownIdentity = ['glucose','starch','albumin','oil'][rand(0,3)];
let unknownGuesses = [];

const testInfo = {
  benedict: { name: "Benedict's", detects: 'Simple sugars (reducing)', positiveColor: '#e57300', positiveName: 'Orange/Red', negativeColor: '#4a90d9', negativeName: 'Blue' },
  iodine: { name: 'Iodine (IKI)', detects: 'Starch', positiveColor: '#1a0a3e', positiveName: 'Blue-Black', negativeColor: '#c8952a', negativeName: 'Amber/Yellow' },
  biuret: { name: 'Biuret', detects: 'Proteins', positiveColor: '#7b2d8e', positiveName: 'Purple/Violet', negativeColor: '#5ba3d9', negativeName: 'Blue' },
  sudan: { name: 'Sudan IV', detects: 'Lipids', positiveColor: '#d42020', positiveName: 'Red/Pink layer', negativeColor: '#f0d090', negativeName: 'No color change' }
};

const sampleResults = {
  glucose:  { benedict: true, iodine: false, biuret: false, sudan: false },
  starch:   { benedict: false, iodine: true, biuret: false, sudan: false },
  albumin:  { benedict: false, iodine: false, biuret: true, sudan: false },
  oil:      { benedict: false, iodine: false, biuret: false, sudan: true },
  water:    { benedict: false, iodine: false, biuret: false, sudan: false }
};

function selectTest(t) {
  currentTest = t;
  document.querySelectorAll('#test-btns .btn').forEach(b => b.classList.remove('btn-active'));
  event.target.classList.add('btn-active');
  drawTestTube();
}

function selectSample(s) {
  currentSample = s;
  document.querySelectorAll('#sample-btns .btn').forEach(b => b.classList.remove('btn-active'));
  event.target.classList.add('btn-active');
  drawTestTube();
}

function runTest() {
  if (!currentTest || !currentSample) {
    $('test-label').textContent = 'Please select both a test and a sample.';
    return;
  }

  const actualSample = currentSample === 'unknown' ? unknownIdentity : currentSample;
  const result = sampleResults[actualSample][currentTest];
  const info = testInfo[currentTest];

  testRunCount++;
  if (result) testPositiveCount++; else testNegativeCount++;
  $('test-run-count').textContent = testRunCount;
  $('test-positive-count').textContent = testPositiveCount;
  $('test-negative-count').textContent = testNegativeCount;

  // Animate test tube
  animateTestTube(result, info);

  // Add to results table
  const row = {
    test: info.name,
    sample: currentSample === 'unknown' ? 'Unknown' : currentSample.charAt(0).toUpperCase() + currentSample.slice(1),
    expectedColor: result ? info.positiveName : info.negativeName,
    result: result ? 'POSITIVE (+)' : 'NEGATIVE (-)',
    positive: result
  };
  testResults.push(row);
  renderResultsTable();

  // Unknown scoring
  if (currentSample === 'unknown') {
    unknownGuesses.push({ test: currentTest, result: result });
    const identified = identifyUnknown();
    $('test-unknown-score').textContent = identified || '?';
  }

  $('test-label').textContent = `${info.name} + ${row.sample}: ${row.result}`;
}

function identifyUnknown() {
  if (unknownGuesses.length < 2) return null;
  // Check if we have enough data to identify
  const positiveTests = unknownGuesses.filter(g => g.result).map(g => g.test);
  const negativeTests = unknownGuesses.filter(g => !g.result).map(g => g.test);

  if (positiveTests.includes('benedict')) return 'Glucose';
  if (positiveTests.includes('iodine')) return 'Starch';
  if (positiveTests.includes('biuret')) return 'Albumin';
  if (positiveTests.includes('sudan')) return 'Oil';
  if (negativeTests.length >= 3) return 'Water';
  return null;
}

function renderResultsTable() {
  const tbody = $('results-body');
  tbody.innerHTML = '';
  testResults.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.test}</td><td>${r.sample}</td><td>${r.expectedColor}</td><td class="${r.positive ? 'positive' : 'negative'}">${r.result}</td>`;
    tbody.appendChild(tr);
  });
}

function resetTests() {
  currentTest = null;
  currentSample = null;
  testResults = [];
  testRunCount = 0;
  testPositiveCount = 0;
  testNegativeCount = 0;
  unknownIdentity = ['glucose','starch','albumin','oil'][rand(0,3)];
  unknownGuesses = [];
  $('test-run-count').textContent = '0';
  $('test-positive-count').textContent = '0';
  $('test-negative-count').textContent = '0';
  $('test-unknown-score').textContent = '-';
  $('test-label').textContent = '';
  $('results-body').innerHTML = '';
  document.querySelectorAll('#test-btns .btn, #sample-btns .btn').forEach(b => b.classList.remove('btn-active'));
  drawTestTube();
}

function drawTestTube(fillColor, fillLevel) {
  const c = $('test-tube-canvas');
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0, 0, W, H);

  // Test tube shape
  const tubeX = 50, tubeW = 80, tubeTop = 30, tubeBottom = 260;
  const radius = tubeW / 2;

  // Tube outline
  ctx.strokeStyle = '#94a3b8';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(tubeX, tubeTop);
  ctx.lineTo(tubeX, tubeBottom);
  ctx.arc(tubeX + radius, tubeBottom, radius, Math.PI, 0, true);
  ctx.lineTo(tubeX + tubeW, tubeTop);
  ctx.stroke();

  // Rim
  ctx.strokeStyle = '#64748b';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(tubeX - 5, tubeTop);
  ctx.lineTo(tubeX + tubeW + 5, tubeTop);
  ctx.stroke();

  // Fill liquid
  const level = fillLevel || 0.4;
  const liquidTop = tubeBottom - (tubeBottom - tubeTop - 40) * level;
  const color = fillColor || '#dbeafe';

  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(tubeX + 1, liquidTop);
  ctx.lineTo(tubeX + 1, tubeBottom);
  ctx.arc(tubeX + radius, tubeBottom, radius - 1, Math.PI, 0, true);
  ctx.lineTo(tubeX + tubeW - 1, liquidTop);
  ctx.closePath();
  ctx.fill();

  // Meniscus
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(tubeX + 1, liquidTop);
  ctx.quadraticCurveTo(tubeX + radius, liquidTop + 6, tubeX + tubeW - 1, liquidTop);
  ctx.stroke();

  // Label
  ctx.fillStyle = '#374151';
  ctx.font = 'bold 11px system-ui';
  ctx.textAlign = 'center';
  if (currentTest) {
    ctx.fillText(testInfo[currentTest].name, tubeX + radius, H - 40);
  }
  if (currentSample) {
    ctx.fillStyle = '#6b7280';
    ctx.font = '11px system-ui';
    const sName = currentSample === 'unknown' ? 'Unknown' : currentSample.charAt(0).toUpperCase() + currentSample.slice(1);
    ctx.fillText('+ ' + sName, tubeX + radius, H - 24);
  }
}

let tubeAnimFrame = null;
function animateTestTube(positive, info) {
  if (tubeAnimFrame) cancelAnimationFrame(tubeAnimFrame);
  const startColor = positive ? info.negativeColor : info.negativeColor;
  const endColor = positive ? info.positiveColor : info.negativeColor;
  let progress = 0;
  const duration = 60; // frames

  function lerp(a, b, t) { return a + (b - a) * t; }
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? { r: parseInt(result[1],16), g: parseInt(result[2],16), b: parseInt(result[3],16) } : { r: 200, g: 200, b: 200 };
  }
  function rgbToHex(r,g,b) { return '#' + [r,g,b].map(x => Math.round(x).toString(16).padStart(2,'0')).join(''); }

  const cStart = hexToRgb(startColor);
  const cEnd = hexToRgb(endColor);

  function frame() {
    progress++;
    const t = Math.min(progress / duration, 1);
    const eased = t * t * (3 - 2 * t); // smoothstep
    const r = lerp(cStart.r, cEnd.r, eased);
    const g = lerp(cStart.g, cEnd.g, eased);
    const b = lerp(cStart.b, cEnd.b, eased);
    const col = rgbToHex(r, g, b);
    drawTestTube(col, 0.5);

    if (t < 1) tubeAnimFrame = requestAnimationFrame(frame);
  }
  frame();
}

// ══════════════════════════════════════════════════════════════════════════
// PART 3: DEHYDRATION SYNTHESIS & HYDROLYSIS
// ══════════════════════════════════════════════════════════════════════════
let rxnMode = 'synthesis'; // or 'hydrolysis'
let rxnPlaying = false;
let rxnStep = 0;
let rxnMaxSteps = 100;
let rxnAnimId = null;

function toggleReactionMode() {
  rxnMode = rxnMode === 'synthesis' ? 'hydrolysis' : 'synthesis';
  $('rxn-toggle-btn').textContent = 'Mode: ' + (rxnMode === 'synthesis' ? 'Dehydration Synthesis' : 'Hydrolysis');
  resetReaction();
}

function toggleReactionPlay() {
  rxnPlaying = !rxnPlaying;
  $('rxn-play-btn').textContent = rxnPlaying ? 'Pause' : 'Play';
  if (rxnPlaying) runReactionFrame();
  else if (rxnAnimId) cancelAnimationFrame(rxnAnimId);
}

function resetReaction() {
  rxnPlaying = false;
  rxnStep = 0;
  if (rxnAnimId) cancelAnimationFrame(rxnAnimId);
  $('rxn-play-btn').textContent = 'Play';
  updateReactionStats();
  drawReaction();
}

function runReactionFrame() {
  if (!rxnPlaying) return;
  rxnStep++;
  if (rxnStep > rxnMaxSteps) {
    rxnPlaying = false;
    $('rxn-play-btn').textContent = 'Play';
    updateReactionStats();
    drawReaction();
    return;
  }
  updateReactionStats();
  drawReaction();
  rxnAnimId = requestAnimationFrame(runReactionFrame);
}

function updateReactionStats() {
  const progress = rxnStep / rxnMaxSteps;
  if (rxnMode === 'synthesis') {
    $('rxn-monomers').textContent = progress < 0.5 ? 2 : (progress < 1 ? 1 : 0);
    $('rxn-polymers').textContent = progress >= 0.5 ? 1 : 0;
    $('rxn-water').textContent = progress >= 0.7 ? 1 : 0;
  } else {
    $('rxn-monomers').textContent = progress < 0.5 ? 0 : (progress >= 0.8 ? 2 : 1);
    $('rxn-polymers').textContent = progress < 0.5 ? 1 : 0;
    $('rxn-water').textContent = progress < 0.3 ? 1 : 0;
  }
  $('rxn-step').textContent = Math.round(progress * 100) + '%';
}

function drawReaction() {
  const ctx = getCtx('reaction-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc';
  ctx.fillRect(0, 0, W, H);

  const progress = clamp(rxnStep / rxnMaxSteps, 0, 1);
  const midY = H / 2;
  const monRadius = 35;

  if (rxnMode === 'synthesis') {
    drawSynthesis(ctx, W, H, progress, midY, monRadius);
  } else {
    drawHydrolysis(ctx, W, H, progress, midY, monRadius);
  }

  // Step indicator bar
  ctx.fillStyle = '#e5e7eb';
  ctx.fillRect(20, H - 20, W - 40, 6);
  ctx.fillStyle = rxnMode === 'synthesis' ? '#c41e3a' : '#2563eb';
  ctx.fillRect(20, H - 20, (W - 40) * progress, 6);
}

function drawMonomer(ctx, x, y, r, label, color, ohSide, hSide) {
  // Main circle
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.stroke();
  // Label
  ctx.fillStyle = '#fff'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(label, x, y);

  // -OH group
  if (ohSide) {
    const ohX = x + r + 14;
    ctx.fillStyle = '#dc2626'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('-OH', ohX, y);
  }
  // -H group
  if (hSide) {
    const hX = x - r - 10;
    ctx.fillStyle = '#2563eb'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('H-', hX, y);
  }
}

function drawWaterMolecule(ctx, x, y, scale) {
  scale = scale || 1;
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(scale, scale);
  // O
  ctx.fillStyle = '#dc2626';
  ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('O', 0, 0);
  // H atoms
  ctx.fillStyle = '#2563eb';
  ctx.beginPath(); ctx.arc(-14, 10, 7, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font = 'bold 7px system-ui';
  ctx.fillText('H', -14, 10);
  ctx.fillStyle = '#2563eb';
  ctx.beginPath(); ctx.arc(14, 10, 7, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.fillText('H', 14, 10);
  ctx.restore();
}

function drawSynthesis(ctx, W, H, progress, midY, r) {
  const ease = progress * progress * (3 - 2 * progress); // smoothstep

  // Monomer positions - start apart, come together
  const startGap = 180;
  const endGap = r * 2 + 4;
  const gap = startGap - (startGap - endGap) * Math.min(ease * 2, 1);

  const m1x = W / 2 - gap / 2;
  const m2x = W / 2 + gap / 2;

  // Phase 1: monomers approach (0 - 0.5)
  // Phase 2: bond forms, water released (0.5 - 1.0)

  if (progress < 0.5) {
    drawMonomer(ctx, m1x, midY, r, 'A', '#c41e3a', true, false);
    drawMonomer(ctx, m2x, midY, r, 'B', '#2563eb', false, true);
    // Label
    ctx.fillStyle = '#374151'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Monomers approaching...', W / 2, 30);
  } else {
    // Bonded dimer
    const bondPhase = (progress - 0.5) * 2;
    const dimerX = W / 2;

    // Draw bonded pair
    drawMonomer(ctx, dimerX - r - 2, midY, r, 'A', '#c41e3a', false, false);
    drawMonomer(ctx, dimerX + r + 2, midY, r, 'B', '#2563eb', false, false);

    // Bond line
    ctx.strokeStyle = '#374151'; ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(dimerX - r + 30, midY);
    ctx.lineTo(dimerX + r - 30, midY);
    ctx.stroke();

    // Bond label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('bond', dimerX, midY - 10);

    // Water molecule floating away
    const waterY = midY + 20 + bondPhase * 80;
    const waterX = dimerX + bondPhase * 60;
    const waterScale = Math.min(bondPhase * 2, 1);
    if (waterScale > 0) {
      drawWaterMolecule(ctx, waterX, waterY, waterScale);
      // Arrow
      ctx.fillStyle = '#6b7280'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
      ctx.fillText('H\u2082O released', waterX + 25, waterY);
    }

    ctx.fillStyle = '#374151'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Dehydration Synthesis: bond formed, water released', W / 2, 30);
  }
}

function drawHydrolysis(ctx, W, H, progress, midY, r) {
  const ease = progress * progress * (3 - 2 * progress);

  if (progress < 0.4) {
    // Show bonded polymer with water approaching
    const dimerX = W / 2;
    drawMonomer(ctx, dimerX - r - 2, midY, r, 'A', '#c41e3a', false, false);
    drawMonomer(ctx, dimerX + r + 2, midY, r, 'B', '#2563eb', false, false);

    // Bond
    ctx.strokeStyle = '#374151'; ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(dimerX - r + 30, midY);
    ctx.lineTo(dimerX + r - 30, midY);
    ctx.stroke();

    // Water approaching
    const waterApproach = progress / 0.4;
    const waterY = midY + 100 - waterApproach * 60;
    drawWaterMolecule(ctx, W / 2, waterY, 1);

    ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText('H\u2082O', W / 2 + 25, waterY);

    ctx.fillStyle = '#374151'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Water molecule approaching polymer bond...', W / 2, 30);

  } else {
    // Bond breaking, monomers separating
    const breakPhase = (progress - 0.4) / 0.6;
    const gap = 4 + breakPhase * 160;

    const m1x = W / 2 - gap / 2;
    const m2x = W / 2 + gap / 2;

    drawMonomer(ctx, m1x, midY, r, 'A', '#c41e3a', true, false);
    drawMonomer(ctx, m2x, midY, r, 'B', '#2563eb', false, true);

    // Breaking bond effect
    if (breakPhase < 0.3) {
      ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(m1x + r, midY);
      ctx.lineTo(m2x - r, midY);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    ctx.fillStyle = '#374151'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Hydrolysis: water added, bond broken, monomers released', W / 2, 30);
  }
}

// ══════════════════════════════════════════════════════════════════════════
// PART 4: POLYMER BUILDER
// ══════════════════════════════════════════════════════════════════════════
let polyType = null;
let polyMonomers = [];

const polyInfo = {
  carb: { name: 'Carbohydrate', monomer: 'Glucose', color: '#c41e3a', symbol: 'Glc', desc: 'Monosaccharides like glucose link via glycosidic bonds to form polysaccharides such as starch, glycogen, and cellulose.' },
  protein: { name: 'Protein', monomer: 'Amino Acid', color: '#2563eb', symbol: 'AA', desc: 'Amino acids link via peptide bonds to form polypeptides. The sequence determines the protein\'s 3D shape and function.' },
  nucleic: { name: 'Nucleic Acid', monomer: 'Nucleotide', color: '#7c3aed', symbol: 'Nt', desc: 'Nucleotides link via phosphodiester bonds to form polynucleotides like DNA and RNA strands.' },
  lipid: { name: 'Lipid', monomer: 'Fatty Acid', color: '#d97706', symbol: 'FA', desc: 'Fatty acids attach to glycerol via ester bonds. Triglycerides have 3 fatty acids; max monomers is 3.' }
};

function setPolymerType(type) {
  polyType = type;
  polyMonomers = [];
  document.querySelectorAll('#part4 .btn-group:first-of-type .btn').forEach(b => b.classList.remove('btn-active'));
  event.target.classList.add('btn-active');
  $('poly-type').textContent = polyInfo[type].name;
  const infoPanel = $('poly-info');
  infoPanel.style.display = 'block';
  infoPanel.innerHTML = `<div class="ar-title">${polyInfo[type].name}</div><p>${polyInfo[type].desc}</p>`;
  updatePolymerUI();
}

function addMonomer() {
  if (!polyType) { $('poly-type').textContent = 'Pick type!'; return; }
  if (polyType === 'lipid' && polyMonomers.length >= 3) return; // Triglyceride max
  polyMonomers.push(polyInfo[polyType].symbol);
  updatePolymerUI();
}

function addMonomerBatch(n) { for (let i = 0; i < n; i++) addMonomer(); }

function resetPolymer() {
  polyMonomers = [];
  updatePolymerUI();
}

function updatePolymerUI() {
  const count = polyMonomers.length;
  const bonds = Math.max(0, count - 1);
  $('poly-count').textContent = count;
  $('poly-bonds').textContent = bonds;
  $('poly-water').textContent = bonds;
  drawPolymerCanvas();
}

function drawPolymerCanvas() {
  const ctx = getCtx('polymer-canvas');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc';
  ctx.fillRect(0, 0, W, H);

  if (!polyType || polyMonomers.length === 0) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Select a type and add monomers to build a polymer', W / 2, H / 2);
    return;
  }

  const info = polyInfo[polyType];
  const count = polyMonomers.length;
  const r = 18;
  const spacing = Math.min(50, (W - 80) / Math.max(count, 1));
  const startX = Math.max(40, (W - spacing * (count - 1)) / 2);
  const rowH = 60;
  const maxPerRow = Math.floor((W - 80) / spacing);

  polyMonomers.forEach((m, i) => {
    const row = Math.floor(i / maxPerRow);
    const col = i % maxPerRow;
    const x = startX + col * spacing;
    const y = 40 + row * rowH;

    // Bond line to previous
    if (i > 0 && col > 0) {
      ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x - spacing + r, y);
      ctx.lineTo(x - r, y);
      ctx.stroke();
    } else if (i > 0 && col === 0) {
      // Wrap line from previous row
      const prevX = startX + (maxPerRow - 1) * spacing;
      const prevY = y - rowH;
      ctx.strokeStyle = '#374151'; ctx.lineWidth = 2; ctx.setLineDash([4, 3]);
      ctx.beginPath();
      ctx.moveTo(prevX + r, prevY);
      ctx.lineTo(prevX + r + 10, prevY);
      ctx.lineTo(prevX + r + 10, y);
      ctx.lineTo(x - r, y);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Monomer circle
    ctx.fillStyle = info.color;
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.stroke();
    // Label
    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(m, x, y);
  });

  // Water count display
  const waterCount = Math.max(0, count - 1);
  if (waterCount > 0) {
    ctx.fillStyle = '#6b7280'; ctx.font = '12px system-ui'; ctx.textAlign = 'right'; ctx.textBaseline = 'bottom';
    ctx.fillText(waterCount + ' H\u2082O produced', W - 20, H - 10);
    // Small water icons
    for (let w = 0; w < Math.min(waterCount, 8); w++) {
      drawWaterMolecule(ctx, W - 80 - w * 30, H - 30, 0.5);
    }
  }
}

// ══════════════════════════════════════════════════════════════════════════
// PART 5: STRUCTURE-FUNCTION MATCHING
// ══════════════════════════════════════════════════════════════════════════
const matchPairs = [
  { structure: 'Glucose', func: 'Quick energy source for cells', type: 'carb' },
  { structure: 'Cellulose', func: 'Structural support in plant cell walls', type: 'carb' },
  { structure: 'Starch', func: 'Energy storage in plants', type: 'carb' },
  { structure: 'Phospholipid', func: 'Forms cell membrane bilayer', type: 'lipid' },
  { structure: 'Triglyceride', func: 'Long-term energy storage in adipose tissue', type: 'lipid' },
  { structure: 'Cholesterol', func: 'Membrane fluidity & steroid hormone precursor', type: 'lipid' },
  { structure: 'Hemoglobin', func: 'Oxygen transport in blood', type: 'protein' },
  { structure: 'Enzyme (e.g. amylase)', func: 'Catalyzes biochemical reactions', type: 'protein' },
  { structure: 'Keratin', func: 'Structural protein in hair, nails, skin', type: 'protein' },
  { structure: 'Antibody', func: 'Immune defense against pathogens', type: 'protein' },
  { structure: 'DNA', func: 'Stores hereditary genetic information', type: 'nucleic' },
  { structure: 'mRNA', func: 'Carries genetic code from DNA to ribosome', type: 'nucleic' },
];

let matchState = { pairs: [], selected: null, correct: 0, attempts: 0, startTime: null, timerId: null, done: false };

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = rand(0, i);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function startMatchGame() {
  // Pick 8 random pairs
  const shuffled = shuffle(matchPairs);
  matchState.pairs = shuffled.slice(0, 8);
  matchState.selected = null;
  matchState.correct = 0;
  matchState.attempts = 0;
  matchState.done = false;
  matchState.startTime = Date.now();

  if (matchState.timerId) clearInterval(matchState.timerId);
  matchState.timerId = setInterval(updateMatchTimer, 1000);

  renderMatchGame();
  updateMatchStats();
}

function updateMatchTimer() {
  if (matchState.done) { clearInterval(matchState.timerId); return; }
  const elapsed = Math.floor((Date.now() - matchState.startTime) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  $('match-timer').textContent = m + ':' + s.toString().padStart(2, '0');
}

function renderMatchGame() {
  const leftDiv = $('match-left');
  const rightDiv = $('match-right');
  leftDiv.innerHTML = '';
  rightDiv.innerHTML = '';

  const leftOrder = shuffle(matchState.pairs.map((p, i) => i));
  const rightOrder = shuffle(matchState.pairs.map((p, i) => i));

  leftOrder.forEach(i => {
    const p = matchState.pairs[i];
    const div = document.createElement('div');
    div.className = 'match-item';
    div.id = 'ml-' + i;
    div.textContent = p.structure;
    div.setAttribute('data-index', i);
    div.setAttribute('data-side', 'left');
    div.onclick = () => selectMatchItem('left', i);
    leftDiv.appendChild(div);
  });

  rightOrder.forEach(i => {
    const p = matchState.pairs[i];
    const div = document.createElement('div');
    div.className = 'match-item';
    div.id = 'mr-' + i;
    div.textContent = p.func;
    div.setAttribute('data-index', i);
    div.setAttribute('data-side', 'right');
    div.onclick = () => selectMatchItem('right', i);
    rightDiv.appendChild(div);
  });
}

function selectMatchItem(side, index) {
  if (matchState.done) return;
  const el = $(side === 'left' ? 'ml-' : 'mr-') + index;
  const item = document.getElementById((side === 'left' ? 'ml-' : 'mr-') + index);
  if (!item || item.classList.contains('correct')) return;

  if (matchState.selected === null) {
    // First selection
    matchState.selected = { side, index };
    item.classList.add('selected');
  } else {
    // Second selection - must be opposite side
    if (matchState.selected.side === side) {
      // Same side - deselect previous, select new
      document.getElementById((side === 'left' ? 'ml-' : 'mr-') + matchState.selected.index).classList.remove('selected');
      matchState.selected = { side, index };
      item.classList.add('selected');
      return;
    }

    matchState.attempts++;
    const leftIdx = side === 'left' ? index : matchState.selected.index;
    const rightIdx = side === 'right' ? index : matchState.selected.index;

    const prevItem = document.getElementById((matchState.selected.side === 'left' ? 'ml-' : 'mr-') + matchState.selected.index);

    if (leftIdx === rightIdx) {
      // Correct match!
      matchState.correct++;
      const leftItem = document.getElementById('ml-' + leftIdx);
      const rightItem = document.getElementById('mr-' + rightIdx);
      leftItem.classList.remove('selected');
      rightItem.classList.remove('selected');
      leftItem.classList.add('correct');
      rightItem.classList.add('correct');
    } else {
      // Wrong match
      item.classList.add('wrong');
      prevItem.classList.add('wrong');
      setTimeout(() => {
        item.classList.remove('wrong', 'selected');
        prevItem.classList.remove('wrong', 'selected');
      }, 600);
    }

    matchState.selected = null;
    updateMatchStats();

    if (matchState.correct === matchState.pairs.length) {
      matchState.done = true;
      clearInterval(matchState.timerId);
    }
  }
}

function updateMatchStats() {
  $('match-score').textContent = matchState.correct + '/' + matchState.pairs.length;
  $('match-attempts').textContent = matchState.attempts;
  $('match-correct').textContent = matchState.correct;
}

// ══════════════════════════════════════════════════════════════════════════
// PART 6: ELEMENT COMPOSITION
// ══════════════════════════════════════════════════════════════════════════
// Approximate elemental composition by mass %
const elementData = {
  carb:    { label: 'Carbohydrates', C: 40, H: 6.7, O: 53.3, N: 0, S: 0, P: 0, color: '#c41e3a' },
  lipid:   { label: 'Lipids',        C: 77, H: 12, O: 11, N: 0, S: 0, P: 0, color: '#d97706' },
  protein: { label: 'Proteins',      C: 53, H: 7, O: 23, N: 16, S: 1, P: 0, color: '#2563eb' },
  nucleic: { label: 'Nucleic Acids', C: 34, H: 4, O: 33, N: 15, S: 0, P: 9, color: '#7c3aed' }
};
const elementList = ['C', 'H', 'O', 'N', 'S', 'P'];
const elementColors = { C: '#374151', H: '#2563eb', O: '#dc2626', N: '#16a34a', S: '#d97706', P: '#7c3aed' };
let highlightedMacro = 'all';

function highlightElement(macro) {
  highlightedMacro = macro;
  document.querySelectorAll('#part6 .btn-group .btn').forEach(b => b.classList.remove('btn-active'));
  event.target.classList.add('btn-active');
  drawElementChart();
  drawCHRatioChart();
}

function drawElementChart() {
  const ctx = getCtx('element-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 40, right: 20, bottom: 60, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const macros = ['carb', 'lipid', 'protein', 'nucleic'];
  const nGroups = elementList.length;
  const nBars = macros.length;
  const groupW = plotW / nGroups;
  const barW = groupW / (nBars + 1);
  const maxVal = 80;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxVal * i / 4).toFixed(0) + '%', pad.left - 6, y + 4);
  }

  // Bars
  elementList.forEach((el, gi) => {
    const gx = pad.left + gi * groupW;

    macros.forEach((mac, bi) => {
      const val = elementData[mac][el];
      const x = gx + (bi + 0.5) * barW;
      const h = (val / maxVal) * plotH;

      // Dimming for non-highlighted
      const isHighlighted = highlightedMacro === 'all' || highlightedMacro === mac;
      ctx.globalAlpha = isHighlighted ? 1 : 0.15;
      ctx.fillStyle = elementData[mac].color;

      // Rounded top bar
      const r = 3;
      ctx.beginPath();
      ctx.moveTo(x, pad.top + plotH);
      ctx.lineTo(x, pad.top + plotH - h + r);
      ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
      ctx.lineTo(x + barW - r, pad.top + plotH - h);
      ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
      ctx.lineTo(x + barW, pad.top + plotH);
      ctx.closePath(); ctx.fill();

      // Value
      if (val > 0 && isHighlighted) {
        ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 9px system-ui'; ctx.textAlign = 'center';
        ctx.fillText(val + '%', x + barW / 2, pad.top + plotH - h - 4);
      }
      ctx.globalAlpha = 1;
    });

    // Element label
    ctx.fillStyle = elementColors[el]; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(el, gx + groupW / 2, H - pad.bottom + 20);
  });

  // Legend
  const legendY = 12;
  macros.forEach((mac, i) => {
    const lx = pad.left + i * 130;
    const isHighlighted = highlightedMacro === 'all' || highlightedMacro === mac;
    ctx.globalAlpha = isHighlighted ? 1 : 0.3;
    ctx.fillStyle = elementData[mac].color;
    ctx.fillRect(lx, legendY, 12, 12);
    ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText(elementData[mac].label, lx + 16, legendY + 10);
    ctx.globalAlpha = 1;
  });
}

function drawCHRatioChart() {
  const ctx = getCtx('ch-ratio-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 50, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const macros = ['carb', 'lipid', 'protein', 'nucleic'];
  const ratios = macros.map(m => elementData[m].H / elementData[m].C);
  const maxRatio = Math.max(...ratios) * 1.3;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxRatio * i / 4).toFixed(2), pad.left - 6, y + 4);
  }

  const n = macros.length;
  const barW = plotW / n * 0.5;
  const gap = plotW / n * 0.5;

  macros.forEach((mac, i) => {
    const val = ratios[i];
    const x = pad.left + (plotW / n) * i + gap / 2;
    const h = (val / maxRatio) * plotH;
    const isHighlighted = highlightedMacro === 'all' || highlightedMacro === mac;

    ctx.globalAlpha = isHighlighted ? 1 : 0.2;
    ctx.fillStyle = elementData[mac].color;

    const r = 4;
    ctx.beginPath();
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();

    // Value
    ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(val.toFixed(3), x + barW / 2, pad.top + plotH - h - 6);
    // Label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui';
    ctx.fillText(elementData[mac].label, x + barW / 2, H - pad.bottom + 16);

    ctx.globalAlpha = 1;
  });

  // Y-axis label
  ctx.save();
  ctx.translate(14, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = '#6b7280'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('H:C Ratio (higher = more energy)', 0, 0);
  ctx.restore();

  // Annotation arrow pointing to lipids
  if (highlightedMacro === 'all' || highlightedMacro === 'lipid') {
    const lipidX = pad.left + (plotW / n) * 1 + gap / 2 + barW / 2;
    const lipidH = (ratios[1] / maxRatio) * plotH;
    const tipY = pad.top + plotH - lipidH - 24;
    ctx.fillStyle = '#d97706'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('\u2191 Most energy-dense', lipidX, tipY);
  }
}

// ══════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ══════════════════════════════════════════════════════════════════════════
function init() {
  buildMacroCards();
  drawTestTube();
  drawReaction();
  drawPolymerCanvas();
  drawElementChart();
  drawCHRatioChart();
  startMatchGame();
}

window.addEventListener('load', init);
window.addEventListener('resize', () => {
  drawElementChart();
  drawCHRatioChart();
  drawPolymerCanvas();
  drawReaction();
});
</script>
</body>
</html>
