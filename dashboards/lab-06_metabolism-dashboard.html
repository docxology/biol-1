<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 6 Dashboard: Metabolism | BIOL-1</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f2f5; --card: #ffffff; --sidebar: #1a1a2e; --sidebar-hover: #252545;
  --accent: #c41e3a; --accent-light: #e8354f; --blue: #2563eb; --blue-light: #3b82f6;
  --green: #16a34a; --amber: #d97706; --purple: #7c3aed;
  --text: #1a1a1a; --text-muted: #6b7280; --border: #e5e7eb;
  --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
html { scroll-behavior: smooth; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }

/* ═══════════════════════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════════════════════ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; background: var(--sidebar); color: #e2e8f0; position: fixed;
  top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-header { padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
.sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.sidebar-nav { flex: 1; padding: 12px 0; }
.sidebar-nav a {
  display: flex; align-items: center; gap: 10px; padding: 10px 20px;
  color: #94a3b8; text-decoration: none; font-size: 13px; font-weight: 500;
  transition: all 0.15s; border-left: 3px solid transparent;
}
.sidebar-nav a:hover { background: var(--sidebar-hover); color: #e2e8f0; }
.sidebar-nav a.active { color: #fff; background: var(--sidebar-hover); border-left-color: var(--accent); }
.sidebar-nav .nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 6px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,0.08); flex-shrink: 0;
}
.sidebar-nav a.active .nav-num { background: var(--accent); color: #fff; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #64748b; }

.main { margin-left: 260px; flex: 1; padding: 32px; max-width: 1200px; }

/* ═══════════════════════════════════════════════════════════════════════
   CARDS & SECTIONS
   ═══════════════════════════════════════════════════════════════════════ */
.section { margin-bottom: 40px; scroll-margin-top: 24px; }
.section-header {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.section-num {
  display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--accent); color: #fff; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.section-title { font-size: 22px; font-weight: 700; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 24px; margin-bottom: 16px; border: 1px solid var(--border);
}
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.card-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .card-row, .card-row-3 { grid-template-columns: 1fr; } }

/* ═══════════════════════════════════════════════════════════════════════
   BUTTONS & INPUTS
   ═══════════════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
  border: none; cursor: pointer; transition: all 0.15s; font-family: var(--font);
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn-secondary { background: var(--blue); color: #fff; }
.btn-secondary:hover { background: var(--blue-light); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }

.slider-group { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.slider-group label { font-size: 13px; font-weight: 600; min-width: 80px; }
.slider-group input[type=range] { flex: 1; accent-color: var(--accent); }
.slider-val { font-family: var(--mono); font-size: 14px; font-weight: 700; min-width: 50px; text-align: right; }

select.input-select {
  padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;
  border: 2px solid var(--border); background: #fff; color: var(--text); font-family: var(--font);
  cursor: pointer; transition: border-color 0.15s;
}
select.input-select:hover { border-color: var(--accent); }

.input-field {
  padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;
  border: 2px solid var(--border); background: #fff; color: var(--text); font-family: var(--mono);
  width: 80px; text-align: center;
}

/* ═══════════════════════════════════════════════════════════════════════
   STATS & BADGES
   ═══════════════════════════════════════════════════════════════════════ */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 12px 0; }
.stat-box {
  text-align: center; padding: 14px 8px; border-radius: 8px;
  background: #f8fafc; border: 1px solid var(--border);
}
.stat-box .stat-val { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.stat-box .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-accent .stat-val { color: var(--accent); }
.stat-blue .stat-val { color: var(--blue); }
.stat-green .stat-val { color: var(--green); }
.stat-amber .stat-val { color: var(--amber); }
.stat-purple .stat-val { color: var(--purple); }

.badge {
  display: inline-block; padding: 2px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-red { background: #fef2f2; color: var(--accent); }
.badge-blue { background: #eff6ff; color: var(--blue); }
.badge-green { background: #f0fdf4; color: var(--green); }
.badge-amber { background: #fffbeb; color: var(--amber); }
.badge-purple { background: #f5f3ff; color: var(--purple); }

/* ═══════════════════════════════════════════════════════════════════════
   CHART CONTAINERS
   ═══════════════════════════════════════════════════════════════════════ */
.chart-wrap { position: relative; width: 100%; margin: 8px 0; }
.chart-wrap canvas { width: 100% !important; display: block; border-radius: 6px; }

/* ═══════════════════════════════════════════════════════════════════════
   ANALYSIS PANEL
   ═══════════════════════════════════════════════════════════════════════ */
.analysis-result {
  background: #f8fafc; border-radius: 8px; padding: 16px; margin: 10px 0;
  border-left: 4px solid var(--blue); font-size: 14px;
}
.analysis-result .ar-title { font-weight: 700; margin-bottom: 6px; }
.analysis-result code { font-family: var(--mono); background: #e2e8f0; padding: 1px 6px; border-radius: 4px; font-size: 13px; }
.analysis-result.ar-pass { border-left-color: var(--green); }
.analysis-result.ar-fail { border-left-color: var(--accent); }

/* ═══════════════════════════════════════════════════════════════════════
   CONVERGENCE LINE
   ═══════════════════════════════════════════════════════════════════════ */
.convergence-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 10px 0; font-size: 13px; }
.convergence-info .ci-dot { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   HERO BANNER
   ═══════════════════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, #1a1a2e 0%, #2d1b3d 50%, #3b1a2e 100%);
  color: #fff; border-radius: var(--radius); padding: 36px; margin-bottom: 32px;
  position: relative; overflow: hidden;
}
.hero::after {
  content: ''; position: absolute; top: -50%; right: -20%; width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(196,30,58,0.15) 0%, transparent 70%);
  pointer-events: none;
}
.hero h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.hero p { font-size: 15px; color: #cbd5e1; max-width: 600px; line-height: 1.7; }
.hero .bio-tags { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.hero .bio-tag {
  padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════
   ATP MOLECULE VISUALIZATION
   ═══════════════════════════════════════════════════════════════════════ */
.atp-visual {
  display: flex; align-items: center; justify-content: center; gap: 4px;
  margin: 16px 0; flex-wrap: wrap;
}
.atp-part {
  display: flex; align-items: center; justify-content: center;
  padding: 10px 18px; border-radius: 10px; font-weight: 700; font-size: 14px;
  transition: all 0.4s ease; cursor: default;
}
.atp-adenosine { background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
.atp-ribose { background: #fef3c7; color: #92400e; border: 2px solid #fcd34d; }
.atp-phosphate { background: #fce7f3; color: #9d174d; border: 2px solid #f9a8d4; }
.atp-bond { font-size: 20px; color: var(--accent); font-weight: 900; }
.atp-energy-burst {
  display: none; padding: 8px 16px; border-radius: 8px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f;
  font-weight: 800; font-size: 13px; animation: energyPulse 0.6s ease;
}
@keyframes energyPulse {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}
.atp-released .atp-phosphate:last-of-type { opacity: 0.3; transform: translateX(20px); }
.atp-released .atp-energy-burst { display: inline-block; }

/* ═══════════════════════════════════════════════════════════════════════
   PATHWAY VISUALIZATION
   ═══════════════════════════════════════════════════════════════════════ */
.pathway-flow {
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  margin: 12px 0; padding: 16px; background: #f8fafc; border-radius: 8px;
  border: 1px solid var(--border);
}
.pathway-step {
  padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 600;
  text-align: center; min-width: 80px;
}
.pathway-arrow { font-size: 18px; color: var(--text-muted); font-weight: 700; }
.pathway-catabolic .pathway-step { background: #fef2f2; color: var(--accent); border: 1px solid #fecaca; }
.pathway-anabolic .pathway-step { background: #eff6ff; color: var(--blue); border: 1px solid #bfdbfe; }
.pathway-energy {
  padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;
}
.pathway-energy-out { background: #f0fdf4; color: var(--green); border: 1px solid #bbf7d0; }
.pathway-energy-in { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }

/* ═══════════════════════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar { display: none; }
  .main { margin-left: 0; padding: 16px; }
}
</style>
</head>
<body>
<div class="layout">

<!-- ═══════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h1>BIOL-1: Biology</h1>
    <p>Lab 6 &mdash; Metabolism</p>
  </div>
  <nav class="sidebar-nav">
    <a href="#hero" class="active"><span class="nav-num">&bull;</span> Overview</a>
    <a href="#part1"><span class="nav-num">1</span> Enzyme Kinetics</a>
    <a href="#part2"><span class="nav-num">2</span> Temp &amp; pH Effects</a>
    <a href="#part3"><span class="nav-num">3</span> ATP Energy Currency</a>
    <a href="#part4"><span class="nav-num">4</span> Activation Energy</a>
    <a href="#part5"><span class="nav-num">5</span> Anabolic vs Catabolic</a>
    <a href="#part6"><span class="nav-num">6</span> Metabolic Rate</a>
  </nav>
  <div class="sidebar-footer">Interactive Lab Dashboard<br>&copy; 2026 BIOL-1</div>
</aside>

<!-- ═══════════════════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════════════════ -->
<div class="main">

<!-- HERO -->
<div class="hero" id="hero">
  <h2>Metabolism</h2>
  <p>Interactive simulations exploring enzyme kinetics, ATP energy coupling, activation energy, and metabolic pathways. Manipulate variables in real time to see how cells power life.</p>
  <div class="bio-tags">
    <span class="bio-tag">Enzymes</span>
    <span class="bio-tag">ATP</span>
    <span class="bio-tag">Energy Transfer</span>
  </div>
</div>

<!-- ═══════════════════════════ PART 1: ENZYME KINETICS ════════════════ -->
<div class="section" id="part1">
  <div class="section-header">
    <div class="section-num">1</div>
    <div><div class="section-title">Enzyme Kinetics Simulator</div>
    <div class="section-subtitle">Explore Michaelis-Menten kinetics and the effects of inhibitors on enzyme activity</div></div>
  </div>
  <div class="card">
    <div class="card-title">Michaelis-Menten Kinetics</div>
    <div class="slider-group">
      <label>[Substrate]</label>
      <input type="range" id="ek-substrate" min="0" max="100" value="50" oninput="ekUpdate()">
      <span class="slider-val" id="ek-sub-val">50</span>
    </div>
    <div class="slider-group">
      <label>Vmax</label>
      <input type="range" id="ek-vmax" min="10" max="200" value="100" oninput="ekUpdate()">
      <span class="slider-val" id="ek-vmax-val">100</span>
    </div>
    <div class="slider-group">
      <label>Km</label>
      <input type="range" id="ek-km" min="5" max="80" value="20" oninput="ekUpdate()">
      <span class="slider-val" id="ek-km-val">20</span>
    </div>
    <div class="btn-group">
      <button class="btn btn-sm btn-outline" id="ek-inh-none" onclick="ekSetInhibitor('none')" style="border-color:var(--green);color:var(--green);">No Inhibitor</button>
      <button class="btn btn-sm btn-outline" id="ek-inh-comp" onclick="ekSetInhibitor('competitive')">Competitive</button>
      <button class="btn btn-sm btn-outline" id="ek-inh-noncomp" onclick="ekSetInhibitor('noncompetitive')">Noncompetitive</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ek-velocity">-</div><div class="stat-label">Current V</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ek-vmax-display">100</div><div class="stat-label">Vmax</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ek-km-display">20</div><div class="stat-label">Km</div></div>
      <div class="stat-box stat-purple"><div class="stat-val" id="ek-inhibitor-label">None</div><div class="stat-label">Inhibitor</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Reaction Velocity vs [Substrate]</div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--accent);"></span> No inhibitor</span>
      <span><span class="ci-dot" style="background:var(--blue);"></span> With inhibitor</span>
      <span><span class="ci-dot" style="background:#9ca3af;"></span> Vmax / Km markers</span>
    </div>
    <div class="chart-wrap"><canvas id="ek-chart" height="300"></canvas></div>
  </div>
</div>

<!-- ═══════════════════════════ PART 2: TEMP & pH ═════════════════════ -->
<div class="section" id="part2">
  <div class="section-header">
    <div class="section-num">2</div>
    <div><div class="section-title">Temperature &amp; pH Effects</div>
    <div class="section-subtitle">See how temperature and pH affect enzyme activity with different enzyme presets</div></div>
  </div>
  <div class="card">
    <div class="card-title">Enzyme Preset</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" id="tp-preset-catalase" onclick="tpSetPreset('catalase')">Catalase (pH 7, 37&deg;C)</button>
      <button class="btn btn-sm btn-outline" id="tp-preset-pepsin" onclick="tpSetPreset('pepsin')">Pepsin (pH 2, 37&deg;C)</button>
      <button class="btn btn-sm btn-outline" id="tp-preset-trypsin" onclick="tpSetPreset('trypsin')">Trypsin (pH 8, 37&deg;C)</button>
      <button class="btn btn-sm btn-outline" id="tp-preset-taq" onclick="tpSetPreset('taq')">Taq Polymerase (pH 8, 72&deg;C)</button>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Temperature Effect</div>
      <div class="slider-group">
        <label>Temp (&deg;C)</label>
        <input type="range" id="tp-temp" min="0" max="100" value="37" oninput="tpUpdate()">
        <span class="slider-val" id="tp-temp-val">37&deg;C</span>
      </div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="tp-temp-activity">-</div><div class="stat-label">Activity %</div></div>
        <div class="stat-box stat-blue"><div class="stat-val" id="tp-temp-optimal">37&deg;C</div><div class="stat-label">Optimal</div></div>
        <div class="stat-box stat-amber"><div class="stat-val" id="tp-temp-zone">Active</div><div class="stat-label">Zone</div></div>
      </div>
      <div class="chart-wrap"><canvas id="tp-temp-chart" height="260"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">pH Effect</div>
      <div class="slider-group">
        <label>pH</label>
        <input type="range" id="tp-ph" min="0" max="14" value="7" step="0.5" oninput="tpUpdate()">
        <span class="slider-val" id="tp-ph-val">7.0</span>
      </div>
      <div class="stat-grid">
        <div class="stat-box stat-accent"><div class="stat-val" id="tp-ph-activity">-</div><div class="stat-label">Activity %</div></div>
        <div class="stat-box stat-green"><div class="stat-val" id="tp-ph-optimal">7.0</div><div class="stat-label">Optimal pH</div></div>
        <div class="stat-box stat-purple"><div class="stat-val" id="tp-ph-zone">Active</div><div class="stat-label">Zone</div></div>
      </div>
      <div class="chart-wrap"><canvas id="tp-ph-chart" height="260"></canvas></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 3: ATP ENERGY ════════════════════ -->
<div class="section" id="part3">
  <div class="section-header">
    <div class="section-num">3</div>
    <div><div class="section-title">ATP Energy Currency</div>
    <div class="section-subtitle">Visualize ATP hydrolysis, energy coupling, and the cellular energy budget</div></div>
  </div>
  <div class="card">
    <div class="card-title">ATP Molecule &mdash; Click to Hydrolyze</div>
    <div class="atp-visual" id="atp-molecule">
      <div class="atp-part atp-adenosine">Adenosine</div>
      <div class="atp-part atp-ribose">Ribose</div>
      <span class="atp-bond">&mdash;</span>
      <div class="atp-part atp-phosphate" id="atp-p1">P<sub>i</sub></div>
      <span class="atp-bond" id="atp-bond1">~</span>
      <div class="atp-part atp-phosphate" id="atp-p2">P<sub>i</sub></div>
      <span class="atp-bond" id="atp-bond2">~</span>
      <div class="atp-part atp-phosphate" id="atp-p3">P<sub>i</sub></div>
      <div class="atp-energy-burst" id="atp-burst">7.3 kcal/mol RELEASED</div>
    </div>
    <p style="font-size:13px;color:var(--text-muted);text-align:center;margin-bottom:12px;">The ~ symbols represent high-energy phosphoanhydride bonds. Click the button to break one.</p>
    <div class="btn-group" style="justify-content:center;">
      <button class="btn btn-primary" onclick="atpHydrolyze()">Hydrolyze ATP</button>
      <button class="btn btn-secondary" onclick="atpRegenerate()">Regenerate ATP</button>
      <button class="btn btn-outline" onclick="atpReset()">Reset Counter</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="atp-hydrolyzed">0</div><div class="stat-label">ATP Hydrolyzed</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="atp-regenerated">0</div><div class="stat-label">ATP Regenerated</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="atp-pool">10</div><div class="stat-label">ATP Pool</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="atp-energy-total">0.0</div><div class="stat-label">Energy (kcal)</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Energy Coupling &mdash; ATP Powers Endergonic Reactions</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Exergonic ATP hydrolysis (negative &Delta;G) is coupled to endergonic reactions (positive &Delta;G) to drive them forward. The net &Delta;G must be negative.</p>
    <div class="chart-wrap"><canvas id="atp-coupling-chart" height="260"></canvas></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val">-7.3</div><div class="stat-label">&Delta;G ATP (kcal/mol)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val">+5.0</div><div class="stat-label">&Delta;G Reaction</div></div>
      <div class="stat-box stat-green"><div class="stat-val">-2.3</div><div class="stat-label">&Delta;G Net (coupled)</div></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 4: ACTIVATION ENERGY ═════════════ -->
<div class="section" id="part4">
  <div class="section-header">
    <div class="section-num">4</div>
    <div><div class="section-title">Activation Energy Diagram</div>
    <div class="section-subtitle">Visualize how enzymes lower activation energy and see exergonic vs endergonic reactions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Energy Profile</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" id="ae-btn-exergonic" onclick="aeSetType('exergonic')">Exergonic (&Delta;G &lt; 0)</button>
      <button class="btn btn-sm btn-outline" id="ae-btn-endergonic" onclick="aeSetType('endergonic')">Endergonic (&Delta;G &gt; 0)</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-sm btn-secondary" id="ae-btn-enzyme" onclick="aeToggleEnzyme()">Toggle Enzyme</button>
      <button class="btn btn-sm btn-outline" onclick="aeAnimate()">Animate Particle</button>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="ae-ea">65</div><div class="stat-label">Ea (kJ/mol)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="ae-ea-enzyme">30</div><div class="stat-label">Ea w/ Enzyme</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="ae-dg">-25</div><div class="stat-label">&Delta;G (kJ/mol)</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="ae-enzyme-status">OFF</div><div class="stat-label">Enzyme</div></div>
    </div>
    <div class="chart-wrap"><canvas id="ae-chart" height="340"></canvas></div>
    <div class="convergence-info">
      <span><span class="ci-dot" style="background:var(--accent);"></span> Without enzyme</span>
      <span><span class="ci-dot" style="background:var(--green);"></span> With enzyme</span>
      <span><span class="ci-dot" style="background:var(--amber);"></span> Animated particle</span>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 5: ANABOLIC vs CATABOLIC ═════════ -->
<div class="section" id="part5">
  <div class="section-header">
    <div class="section-num">5</div>
    <div><div class="section-title">Anabolic vs Catabolic Pathways</div>
    <div class="section-subtitle">Compare energy-releasing catabolic reactions with energy-requiring anabolic reactions</div></div>
  </div>
  <div class="card">
    <div class="card-title">Pathway Explorer</div>
    <div class="btn-group">
      <button class="btn btn-sm btn-primary" id="pw-btn-glycolysis" onclick="pwSetPathway('glycolysis')">Glycolysis (Catabolic)</button>
      <button class="btn btn-sm btn-outline" id="pw-btn-krebs" onclick="pwSetPathway('krebs')">Krebs Cycle (Catabolic)</button>
      <button class="btn btn-sm btn-outline" id="pw-btn-protein" onclick="pwSetPathway('protein')">Protein Synthesis (Anabolic)</button>
      <button class="btn btn-sm btn-outline" id="pw-btn-photosynthesis" onclick="pwSetPathway('photosynthesis')">Photosynthesis (Anabolic)</button>
    </div>
    <div id="pw-display"></div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="pw-type">Catabolic</div><div class="stat-label">Type</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="pw-atp-produced">2</div><div class="stat-label">ATP Produced</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="pw-atp-consumed">0</div><div class="stat-label">ATP Consumed</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="pw-net-atp">+2</div><div class="stat-label">Net ATP</div></div>
    </div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Catabolic Overview</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Breaks down complex molecules into simpler ones, releasing energy stored in chemical bonds.</p>
      <div class="chart-wrap"><canvas id="pw-catabolic-chart" height="240"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Anabolic Overview</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">Builds complex molecules from simpler ones, requiring energy input (often from ATP).</p>
      <div class="chart-wrap"><canvas id="pw-anabolic-chart" height="240"></canvas></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ PART 6: METABOLIC RATE ════════════════ -->
<div class="section" id="part6">
  <div class="section-header">
    <div class="section-num">6</div>
    <div><div class="section-title">Metabolic Rate Calculator</div>
    <div class="section-subtitle">Explore how organism size, temperature, and activity affect metabolic rate</div></div>
  </div>
  <div class="card">
    <div class="card-title">Organism Parameters</div>
    <div class="slider-group">
      <label>Mass (kg)</label>
      <input type="range" id="mr-mass" min="0.01" max="5000" value="70" step="0.5" oninput="mrUpdate()">
      <span class="slider-val" id="mr-mass-val">70</span>
    </div>
    <div class="slider-group">
      <label>Temp (&deg;C)</label>
      <input type="range" id="mr-temp" min="5" max="45" value="37" oninput="mrUpdate()">
      <span class="slider-val" id="mr-temp-val">37&deg;C</span>
    </div>
    <div class="slider-group">
      <label>Activity</label>
      <input type="range" id="mr-activity" min="1" max="10" value="3" oninput="mrUpdate()">
      <span class="slider-val" id="mr-activity-val">3 (Light)</span>
    </div>
    <div class="stat-grid">
      <div class="stat-box stat-accent"><div class="stat-val" id="mr-bmr">-</div><div class="stat-label">BMR (kcal/day)</div></div>
      <div class="stat-box stat-blue"><div class="stat-val" id="mr-active">-</div><div class="stat-label">Active Rate</div></div>
      <div class="stat-box stat-green"><div class="stat-val" id="mr-sa-vol">-</div><div class="stat-label">SA:Vol Ratio</div></div>
      <div class="stat-box stat-amber"><div class="stat-val" id="mr-q10">-</div><div class="stat-label">Q10 Factor</div></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="mrAddScenario()">Add Scenario</button>
      <button class="btn btn-secondary" onclick="mrAddPresets()">Load Presets</button>
      <button class="btn btn-outline" onclick="mrClearScenarios()">Clear All</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Scenario Comparison</div>
    <div class="chart-wrap"><canvas id="mr-bar-chart" height="300"></canvas></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">SA:Volume Ratio vs Mass</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">Smaller organisms have higher surface area to volume ratios, leading to higher mass-specific metabolic rates.</p>
      <div class="chart-wrap"><canvas id="mr-sa-chart" height="240"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Q10 Temperature Coefficient</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">For every 10&deg;C increase in temperature, metabolic rate roughly doubles (Q10 &asymp; 2).</p>
      <div class="chart-wrap"><canvas id="mr-q10-chart" height="240"></canvas></div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ═══════════════════════════════════════════════════════════════════════
     JAVASCRIPT ENGINE
     ═══════════════════════════════════════════════════════════════════════ -->
<script>
// ── Utility ──────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

// ── Chart helper ─────────────────────────────────────────────────────────
function getCtx(id) {
  const c = $(id); const dpr = window.devicePixelRatio || 1;
  const w = c.offsetWidth || c.width || 300;
  const h = c.offsetHeight || c.height || 150;
  c.width = w * dpr; c.height = h * dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.W = w; ctx.H = h;
  return ctx;
}

function drawBarChart(ctx, opts = {}) {
  const { labels, values, expected, colors, maxVal, yLabel } = opts;
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = values.length, barW = plotW / n * 0.6, gap = plotW / n * 0.4;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const mv = maxVal || Math.max(...values, ...(expected||[0])) * 1.2 || 10;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui';
    ctx.textAlign = 'right'; ctx.fillText((mv * i/4).toFixed(mv > 10 ? 0 : 2), pad.left - 6, y + 4);
  }

  values.forEach((v, i) => {
    const x = pad.left + (plotW / n) * i + gap/2;
    const h = (v / mv) * plotH;
    ctx.fillStyle = colors ? colors[i] : '#c41e3a';
    ctx.beginPath();
    const r = 4;
    ctx.moveTo(x, pad.top + plotH);
    ctx.lineTo(x, pad.top + plotH - h + r);
    ctx.quadraticCurveTo(x, pad.top + plotH - h, x + r, pad.top + plotH - h);
    ctx.lineTo(x + barW - r, pad.top + plotH - h);
    ctx.quadraticCurveTo(x + barW, pad.top + plotH - h, x + barW, pad.top + plotH - h + r);
    ctx.lineTo(x + barW, pad.top + plotH);
    ctx.closePath(); ctx.fill();
    // label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + barW/2, H - pad.bottom + 16);
    // value on top
    if (v > 0) {
      ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 12px system-ui';
      ctx.fillText(v.toFixed(v % 1 ? 2 : 0), x + barW/2, pad.top + plotH - h - 6);
    }
  });

  // expected line
  if (expected) {
    expected.forEach((ev, i) => {
      const x = pad.left + (plotW / n) * i + gap/2;
      const y = pad.top + plotH - (ev / mv) * plotH;
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
      ctx.beginPath(); ctx.moveTo(x - 4, y); ctx.lineTo(x + barW + 4, y); ctx.stroke();
      ctx.setLineDash([]);
    });
  }
}

function drawLineChart(ctx, series, opts = {}) {
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 30, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const { yMin = 0, yMax = 1, refLine, xLabel } = opts;
  const yRange = yMax - yMin;
  // grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((yMin + yRange * i/4).toFixed(2), pad.left - 6, y + 4);
  }
  // ref line
  if (refLine !== undefined) {
    const ry = pad.top + plotH * (1 - (refLine - yMin) / yRange);
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pad.left, ry); ctx.lineTo(W - pad.right, ry); ctx.stroke();
    ctx.setLineDash([]);
  }

  series.forEach(s => {
    if (!s.data.length) return;
    const xMax = opts.xMax || s.data.length;
    ctx.strokeStyle = s.color; ctx.lineWidth = s.width || 2;
    ctx.beginPath();
    s.data.forEach((v, i) => {
      const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
      const y = pad.top + plotH * (1 - (v - yMin) / yRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    if (s.width !== 0) ctx.stroke();
    // dots
    if (s.dots && s.data.length < 80) {
      s.data.forEach((v, i) => {
        const x = pad.left + (i / Math.max(xMax - 1, 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - yMin) / yRange);
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
      });
    }
  });
}


// ══════════════════════════════════════════════════════════════════════════
// PART 1: ENZYME KINETICS
// ══════════════════════════════════════════════════════════════════════════
let ekInhibitor = 'none';

function ekMM(S, Vmax, Km) {
  return (Vmax * S) / (Km + S);
}

function ekMMInhibited(S, Vmax, Km, type) {
  const I = 50; // inhibitor concentration
  const Ki = 25;
  if (type === 'competitive') {
    // Competitive: apparent Km increases, Vmax stays same
    const Km_app = Km * (1 + I / Ki);
    return (Vmax * S) / (Km_app + S);
  } else if (type === 'noncompetitive') {
    // Noncompetitive: Vmax decreases, Km stays same
    const Vmax_app = Vmax / (1 + I / Ki);
    return (Vmax_app * S) / (Km + S);
  }
  return ekMM(S, Vmax, Km);
}

function ekSetInhibitor(type) {
  ekInhibitor = type;
  // Update button styles
  ['none', 'competitive', 'noncompetitive'].forEach(t => {
    const id = 'ek-inh-' + (t === 'none' ? 'none' : t === 'competitive' ? 'comp' : 'noncomp');
    const btn = $(id);
    if (t === type) {
      btn.className = 'btn btn-sm btn-primary';
    } else {
      btn.className = 'btn btn-sm btn-outline';
    }
  });
  const labels = { none: 'None', competitive: 'Competitive', noncompetitive: 'Noncompetitive' };
  $('ek-inhibitor-label').textContent = labels[type];
  ekUpdate();
}

function ekUpdate() {
  const S = parseFloat($('ek-substrate').value);
  const Vmax = parseFloat($('ek-vmax').value);
  const Km = parseFloat($('ek-km').value);
  $('ek-sub-val').textContent = S;
  $('ek-vmax-val').textContent = Vmax;
  $('ek-km-val').textContent = Km;
  $('ek-vmax-display').textContent = Vmax;
  $('ek-km-display').textContent = Km;

  let velocity;
  if (ekInhibitor === 'none') {
    velocity = ekMM(S, Vmax, Km);
  } else {
    velocity = ekMMInhibited(S, Vmax, Km, ekInhibitor);
  }
  $('ek-velocity').textContent = velocity.toFixed(1);

  drawEKChart();
}

function drawEKChart() {
  const ctx = getCtx('ek-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 30, bottom: 50, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const Vmax = parseFloat($('ek-vmax').value);
  const Km = parseFloat($('ek-km').value);
  const currentS = parseFloat($('ek-substrate').value);
  const maxS = 100;
  const maxV = Vmax * 1.15;
  const steps = 200;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = pad.top + plotH * (1 - i/5);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxV * i/5).toFixed(0), pad.left - 8, y + 4);
  }
  for (let i = 0; i <= 5; i++) {
    const x = pad.left + plotW * i/5;
    ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, pad.top + plotH); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
    ctx.fillText((maxS * i/5).toFixed(0), x, H - pad.bottom + 16);
  }

  // No inhibitor curve (always drawn)
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  for (let i = 0; i <= steps; i++) {
    const S = (i / steps) * maxS;
    const V = ekMM(S, Vmax, Km);
    const x = pad.left + (S / maxS) * plotW;
    const y = pad.top + plotH * (1 - V / maxV);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Inhibitor curve (if active)
  if (ekInhibitor !== 'none') {
    ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2.5;
    ctx.beginPath();
    for (let i = 0; i <= steps; i++) {
      const S = (i / steps) * maxS;
      const V = ekMMInhibited(S, Vmax, Km, ekInhibitor);
      const x = pad.left + (S / maxS) * plotW;
      const y = pad.top + plotH * (1 - V / maxV);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  // Vmax line
  const vmaxY = pad.top + plotH * (1 - Vmax / maxV);
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, vmaxY); ctx.lineTo(W - pad.right, vmaxY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Vmax = ' + Vmax, W - pad.right - 80, vmaxY - 6);

  // Km marker
  const kmX = pad.left + (Km / maxS) * plotW;
  const halfVmax = Vmax / 2;
  const halfVmaxY = pad.top + plotH * (1 - halfVmax / maxV);
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([4, 3]);
  ctx.beginPath(); ctx.moveTo(kmX, pad.top + plotH); ctx.lineTo(kmX, halfVmaxY); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.left, halfVmaxY); ctx.lineTo(kmX, halfVmaxY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Km = ' + Km, kmX, pad.top + plotH + 14);
  ctx.textAlign = 'right';
  ctx.fillText('Vmax/2', pad.left - 8, halfVmaxY + 14);

  // Current position marker
  let currentV;
  if (ekInhibitor === 'none') {
    currentV = ekMM(currentS, Vmax, Km);
  } else {
    currentV = ekMMInhibited(currentS, Vmax, Km, ekInhibitor);
  }
  const cx = pad.left + (currentS / maxS) * plotW;
  const cy = pad.top + plotH * (1 - currentV / maxV);
  ctx.fillStyle = ekInhibitor === 'none' ? '#c41e3a' : '#2563eb';
  ctx.beginPath(); ctx.arc(cx, cy, 7, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI * 2); ctx.fill();

  // Axis labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('[Substrate]', pad.left + plotW / 2, H - 6);
  ctx.save();
  ctx.translate(14, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('Reaction Velocity (V)', 0, 0);
  ctx.restore();
}


// ══════════════════════════════════════════════════════════════════════════
// PART 2: TEMPERATURE & pH EFFECTS
// ══════════════════════════════════════════════════════════════════════════
const enzymePresets = {
  catalase:  { name: 'Catalase',        optTemp: 37, optPH: 7.0, tempWidth: 18, phWidth: 2.5, color: '#c41e3a' },
  pepsin:    { name: 'Pepsin',           optTemp: 37, optPH: 2.0, tempWidth: 15, phWidth: 1.5, color: '#2563eb' },
  trypsin:   { name: 'Trypsin',          optTemp: 37, optPH: 8.0, tempWidth: 16, phWidth: 2.0, color: '#16a34a' },
  taq:       { name: 'Taq Polymerase',   optTemp: 72, optPH: 8.0, tempWidth: 12, phWidth: 2.0, color: '#7c3aed' }
};
let tpCurrentPreset = 'catalase';

function tpSetPreset(name) {
  tpCurrentPreset = name;
  const p = enzymePresets[name];
  $('tp-temp').value = p.optTemp;
  $('tp-ph').value = p.optPH;
  // Update button styles
  Object.keys(enzymePresets).forEach(k => {
    const btn = $('tp-preset-' + k);
    if (btn) btn.className = k === name ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';
  });
  tpUpdate();
}

function gaussianActivity(x, optimal, width) {
  return Math.exp(-0.5 * Math.pow((x - optimal) / width, 2)) * 100;
}

function tpUpdate() {
  const temp = parseFloat($('tp-temp').value);
  const ph = parseFloat($('tp-ph').value);
  const p = enzymePresets[tpCurrentPreset];

  $('tp-temp-val').textContent = temp + '\u00B0C';
  $('tp-ph-val').textContent = ph.toFixed(1);
  $('tp-temp-optimal').textContent = p.optTemp + '\u00B0C';
  $('tp-ph-optimal').textContent = p.optPH.toFixed(1);

  // Temperature activity (with denaturation at high temps)
  let tempActivity = gaussianActivity(temp, p.optTemp, p.tempWidth);
  if (temp > p.optTemp + p.tempWidth * 1.5) {
    // Sharp denaturation drop-off
    const excess = temp - (p.optTemp + p.tempWidth * 1.5);
    tempActivity *= Math.exp(-excess * 0.15);
  }
  tempActivity = clamp(tempActivity, 0, 100);
  $('tp-temp-activity').textContent = tempActivity.toFixed(1) + '%';

  // Temperature zone
  if (temp > p.optTemp + p.tempWidth * 2) {
    $('tp-temp-zone').textContent = 'Denatured';
    $('tp-temp-zone').parentElement.querySelector('.stat-label').style.color = '#c41e3a';
  } else if (tempActivity > 80) {
    $('tp-temp-zone').textContent = 'Optimal';
    $('tp-temp-zone').parentElement.querySelector('.stat-label').style.color = '';
  } else if (tempActivity > 30) {
    $('tp-temp-zone').textContent = 'Active';
    $('tp-temp-zone').parentElement.querySelector('.stat-label').style.color = '';
  } else {
    $('tp-temp-zone').textContent = 'Low Activity';
    $('tp-temp-zone').parentElement.querySelector('.stat-label').style.color = '';
  }

  // pH activity
  let phActivity = gaussianActivity(ph, p.optPH, p.phWidth);
  phActivity = clamp(phActivity, 0, 100);
  $('tp-ph-activity').textContent = phActivity.toFixed(1) + '%';

  if (phActivity > 80) {
    $('tp-ph-zone').textContent = 'Optimal';
  } else if (phActivity > 30) {
    $('tp-ph-zone').textContent = 'Active';
  } else {
    $('tp-ph-zone').textContent = 'Denatured';
  }

  drawTempChart();
  drawPHChart();
}

function drawTempChart() {
  const ctx = getCtx('tp-temp-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 45, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const p = enzymePresets[tpCurrentPreset];
  const temp = parseFloat($('tp-temp').value);

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((i * 25) + '%', pad.left - 6, y + 4);
  }

  // Denaturation zone shading
  const denatureStart = p.optTemp + p.tempWidth * 1.5;
  if (denatureStart < 100) {
    const dx = pad.left + (denatureStart / 100) * plotW;
    ctx.fillStyle = 'rgba(196,30,58,0.08)';
    ctx.fillRect(dx, pad.top, W - pad.right - dx, plotH);
    ctx.fillStyle = '#c41e3a'; ctx.font = '10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Denaturation', (dx + W - pad.right) / 2, pad.top + 14);
  }

  // Draw all enzyme presets as faded background
  Object.keys(enzymePresets).forEach(k => {
    if (k === tpCurrentPreset) return;
    const ep = enzymePresets[k];
    ctx.strokeStyle = ep.color; ctx.lineWidth = 1; ctx.globalAlpha = 0.2;
    ctx.beginPath();
    for (let t = 0; t <= 100; t++) {
      let a = gaussianActivity(t, ep.optTemp, ep.tempWidth);
      if (t > ep.optTemp + ep.tempWidth * 1.5) {
        a *= Math.exp(-(t - (ep.optTemp + ep.tempWidth * 1.5)) * 0.15);
      }
      a = clamp(a, 0, 100);
      const x = pad.left + (t / 100) * plotW;
      const y = pad.top + plotH * (1 - a / 100);
      t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;
  });

  // Main curve
  ctx.strokeStyle = p.color; ctx.lineWidth = 2.5;
  ctx.beginPath();
  for (let t = 0; t <= 100; t++) {
    let a = gaussianActivity(t, p.optTemp, p.tempWidth);
    if (t > p.optTemp + p.tempWidth * 1.5) {
      a *= Math.exp(-(t - (p.optTemp + p.tempWidth * 1.5)) * 0.15);
    }
    a = clamp(a, 0, 100);
    const x = pad.left + (t / 100) * plotW;
    const y = pad.top + plotH * (1 - a / 100);
    t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Current temperature marker
  let currentA = gaussianActivity(temp, p.optTemp, p.tempWidth);
  if (temp > p.optTemp + p.tempWidth * 1.5) {
    currentA *= Math.exp(-(temp - (p.optTemp + p.tempWidth * 1.5)) * 0.15);
  }
  currentA = clamp(currentA, 0, 100);
  const cx = pad.left + (temp / 100) * plotW;
  const cy = pad.top + plotH * (1 - currentA / 100);
  ctx.fillStyle = p.color;
  ctx.beginPath(); ctx.arc(cx, cy, 7, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI * 2); ctx.fill();

  // X-axis labels
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  for (let t = 0; t <= 100; t += 20) {
    const x = pad.left + (t / 100) * plotW;
    ctx.fillText(t + '\u00B0C', x, H - pad.bottom + 16);
  }
  ctx.font = 'bold 12px system-ui';
  ctx.fillText('Temperature (\u00B0C)', pad.left + plotW / 2, H - 6);
}

function drawPHChart() {
  const ctx = getCtx('tp-ph-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 45, left: 50 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const p = enzymePresets[tpCurrentPreset];
  const ph = parseFloat($('tp-ph').value);

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((i * 25) + '%', pad.left - 6, y + 4);
  }

  // pH gradient background
  const gradient = ctx.createLinearGradient(pad.left, 0, W - pad.right, 0);
  gradient.addColorStop(0, 'rgba(220,38,38,0.06)');
  gradient.addColorStop(0.5, 'rgba(22,163,74,0.06)');
  gradient.addColorStop(1, 'rgba(37,99,235,0.06)');
  ctx.fillStyle = gradient;
  ctx.fillRect(pad.left, pad.top, plotW, plotH);

  // Draw all enzyme presets as faded background
  Object.keys(enzymePresets).forEach(k => {
    if (k === tpCurrentPreset) return;
    const ep = enzymePresets[k];
    ctx.strokeStyle = ep.color; ctx.lineWidth = 1; ctx.globalAlpha = 0.2;
    ctx.beginPath();
    for (let i = 0; i <= 140; i++) {
      const phVal = i / 10;
      const a = clamp(gaussianActivity(phVal, ep.optPH, ep.phWidth), 0, 100);
      const x = pad.left + (phVal / 14) * plotW;
      const y = pad.top + plotH * (1 - a / 100);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;
  });

  // Main curve
  ctx.strokeStyle = p.color; ctx.lineWidth = 2.5;
  ctx.beginPath();
  for (let i = 0; i <= 140; i++) {
    const phVal = i / 10;
    const a = clamp(gaussianActivity(phVal, p.optPH, p.phWidth), 0, 100);
    const x = pad.left + (phVal / 14) * plotW;
    const y = pad.top + plotH * (1 - a / 100);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Current pH marker
  const currentA = clamp(gaussianActivity(ph, p.optPH, p.phWidth), 0, 100);
  const cx = pad.left + (ph / 14) * plotW;
  const cy = pad.top + plotH * (1 - currentA / 100);
  ctx.fillStyle = p.color;
  ctx.beginPath(); ctx.arc(cx, cy, 7, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI * 2); ctx.fill();

  // X-axis labels
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  for (let i = 0; i <= 14; i += 2) {
    const x = pad.left + (i / 14) * plotW;
    ctx.fillText(i, x, H - pad.bottom + 16);
  }
  ctx.font = 'bold 12px system-ui';
  ctx.fillText('pH', pad.left + plotW / 2, H - 6);

  // Acid / Base labels
  ctx.font = '10px system-ui'; ctx.fillStyle = '#dc2626'; ctx.textAlign = 'left';
  ctx.fillText('Acidic', pad.left + 4, pad.top + plotH - 4);
  ctx.fillStyle = '#2563eb'; ctx.textAlign = 'right';
  ctx.fillText('Basic', W - pad.right - 4, pad.top + plotH - 4);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 3: ATP ENERGY CURRENCY
// ══════════════════════════════════════════════════════════════════════════
let atpState = { pool: 10, hydrolyzed: 0, regenerated: 0, totalEnergy: 0 };

function atpHydrolyze() {
  if (atpState.pool <= 0) return;
  atpState.pool--;
  atpState.hydrolyzed++;
  atpState.totalEnergy += 7.3;

  // Visual effect
  const mol = $('atp-molecule');
  mol.classList.add('atp-released');
  const burst = $('atp-burst');
  burst.style.display = 'inline-block';
  burst.style.animation = 'none';
  burst.offsetHeight; // trigger reflow
  burst.style.animation = 'energyPulse 0.6s ease';

  const p3 = $('atp-p3');
  p3.style.opacity = '0.3';
  p3.style.transform = 'translateX(20px)';
  const b2 = $('atp-bond2');
  b2.style.color = 'var(--amber)';
  b2.textContent = '\u2717';

  setTimeout(() => {
    p3.style.opacity = '1';
    p3.style.transform = 'translateX(0)';
    b2.style.color = '';
    b2.textContent = '~';
    burst.style.display = 'none';
    mol.classList.remove('atp-released');
  }, 1200);

  atpUpdateUI();
}

function atpRegenerate() {
  atpState.pool++;
  atpState.regenerated++;
  atpUpdateUI();
}

function atpReset() {
  atpState = { pool: 10, hydrolyzed: 0, regenerated: 0, totalEnergy: 0 };
  atpUpdateUI();
}

function atpUpdateUI() {
  $('atp-hydrolyzed').textContent = atpState.hydrolyzed;
  $('atp-regenerated').textContent = atpState.regenerated;
  $('atp-pool').textContent = atpState.pool;
  $('atp-energy-total').textContent = atpState.totalEnergy.toFixed(1);
  drawATPCouplingChart();
}

function drawATPCouplingChart() {
  const ctx = getCtx('atp-coupling-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 30, bottom: 50, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const midY = pad.top + plotH / 2;

  // Zero line
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad.left, midY); ctx.lineTo(W - pad.right, midY); ctx.stroke();
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'right';
  ctx.fillText('\u0394G = 0', pad.left - 8, midY + 4);

  // Scale: -10 to +10
  const scale = 10;
  const gridSteps = [-10, -5, 5, 10];
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  gridSteps.forEach(v => {
    const y = midY - (v / scale) * (plotH / 2);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText(v > 0 ? '+' + v : v.toString(), pad.left - 8, y + 4);
  });

  // Three bars: ATP hydrolysis, Endergonic reaction, Net coupled
  const reactions = [
    { label: 'ATP Hydrolysis', dg: -7.3, color: '#c41e3a' },
    { label: 'Endergonic Rxn', dg: +5.0, color: '#2563eb' },
    { label: 'Net Coupled', dg: -2.3, color: '#16a34a' }
  ];

  const barW = plotW / reactions.length * 0.5;
  const groupW = plotW / reactions.length;

  reactions.forEach((r, i) => {
    const cx = pad.left + groupW * i + groupW / 2;
    const barH = Math.abs(r.dg / scale) * (plotH / 2);
    const y = r.dg < 0 ? midY : midY - barH;

    ctx.fillStyle = r.color;
    // Rounded rectangle
    const rr = 4;
    ctx.beginPath();
    ctx.moveTo(cx - barW/2 + rr, y);
    ctx.lineTo(cx + barW/2 - rr, y);
    ctx.quadraticCurveTo(cx + barW/2, y, cx + barW/2, y + rr);
    ctx.lineTo(cx + barW/2, y + barH - rr);
    ctx.quadraticCurveTo(cx + barW/2, y + barH, cx + barW/2 - rr, y + barH);
    ctx.lineTo(cx - barW/2 + rr, y + barH);
    ctx.quadraticCurveTo(cx - barW/2, y + barH, cx - barW/2, y + barH - rr);
    ctx.lineTo(cx - barW/2, y + rr);
    ctx.quadraticCurveTo(cx - barW/2, y, cx - barW/2 + rr, y);
    ctx.closePath();
    ctx.fill();

    // Value
    ctx.fillStyle = '#1a1a1a'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
    const valY = r.dg < 0 ? y + barH + 18 : y - 8;
    ctx.fillText((r.dg > 0 ? '+' : '') + r.dg.toFixed(1) + ' kcal/mol', cx, valY);

    // Arrow direction
    const arrowY = r.dg < 0 ? y + barH / 2 : y + barH / 2;
    ctx.fillStyle = '#fff'; ctx.font = 'bold 16px system-ui';
    ctx.fillText(r.dg < 0 ? '\u2193' : '\u2191', cx, arrowY + 6);

    // Label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(r.label, cx, H - 10);
  });

  // Y-axis label
  ctx.save();
  ctx.translate(14, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Free Energy \u0394G (kcal/mol)', 0, 0);
  ctx.restore();

  // Labels
  ctx.fillStyle = '#16a34a'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Exergonic (\u0394G < 0)', pad.left, midY + plotH / 2 + 12);
  ctx.fillStyle = '#dc2626'; ctx.textAlign = 'right';
  ctx.fillText('Endergonic (\u0394G > 0)', W - pad.right, pad.top - 2);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 4: ACTIVATION ENERGY
// ══════════════════════════════════════════════════════════════════════════
let aeState = {
  type: 'exergonic', // or 'endergonic'
  enzyme: false,
  particleX: -1, // -1 = not animating
  animFrame: null
};

function aeSetType(type) {
  aeState.type = type;
  $('ae-btn-exergonic').className = type === 'exergonic' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';
  $('ae-btn-endergonic').className = type === 'endergonic' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';

  if (type === 'exergonic') {
    $('ae-ea').textContent = '65';
    $('ae-ea-enzyme').textContent = '30';
    $('ae-dg').textContent = '-25';
  } else {
    $('ae-ea').textContent = '80';
    $('ae-ea-enzyme').textContent = '45';
    $('ae-dg').textContent = '+30';
  }
  aeState.particleX = -1;
  drawAEChart();
}

function aeToggleEnzyme() {
  aeState.enzyme = !aeState.enzyme;
  $('ae-enzyme-status').textContent = aeState.enzyme ? 'ON' : 'OFF';
  $('ae-btn-enzyme').className = aeState.enzyme ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-secondary';
  drawAEChart();
}

function aeGetEnergyCurve(t, reactantE, productE, Ea, peakPos) {
  // Smooth energy curve from reactant through transition state to product
  // t: 0 to 1 progress
  if (t <= peakPos) {
    // Rising to transition state
    const frac = t / peakPos;
    const height = Ea;
    return reactantE + height * Math.sin(frac * Math.PI / 2);
  } else {
    // Descending from transition state to products
    const frac = (t - peakPos) / (1 - peakPos);
    const peakE = reactantE + Ea;
    return peakE + (productE - peakE) * Math.sin(frac * Math.PI / 2);
  }
}

function drawAEChart() {
  const ctx = getCtx('ae-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 30, right: 30, bottom: 50, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  const isExergonic = aeState.type === 'exergonic';
  const reactantE = isExergonic ? 60 : 40;
  const productE = isExergonic ? 35 : 70;
  const Ea = isExergonic ? 65 : 80;
  const EaEnzyme = isExergonic ? 30 : 45;
  const dG = productE - reactantE;
  const peakPos = 0.35;

  const maxE = Math.max(reactantE + Ea, reactantE + EaEnzyme, productE) + 15;
  const minE = Math.min(reactantE, productE) - 10;
  const eRange = maxE - minE;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
  }

  // Function to draw energy curve path
  function drawCurvePath(ea, color, lineWidth, dashed) {
    ctx.strokeStyle = color; ctx.lineWidth = lineWidth;
    if (dashed) { ctx.setLineDash([6, 4]); } else { ctx.setLineDash([]); }
    ctx.beginPath();
    for (let i = 0; i <= 200; i++) {
      const t = i / 200;
      const e = aeGetEnergyCurve(t, reactantE, productE, ea, peakPos);
      const x = pad.left + t * plotW;
      const y = pad.top + plotH * (1 - (e - minE) / eRange);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Without enzyme curve
  drawCurvePath(Ea, '#c41e3a', 2.5, false);

  // With enzyme curve
  if (aeState.enzyme) {
    drawCurvePath(EaEnzyme, '#16a34a', 2.5, false);
  }

  // Reactant and product levels
  const rY = pad.top + plotH * (1 - (reactantE - minE) / eRange);
  const pY = pad.top + plotH * (1 - (productE - minE) / eRange);

  // Reactant level line
  ctx.strokeStyle = '#374151'; ctx.lineWidth = 1; ctx.setLineDash([4, 3]);
  ctx.beginPath(); ctx.moveTo(pad.left, rY); ctx.lineTo(pad.left + plotW * 0.15, rY); ctx.stroke();
  // Product level line
  ctx.beginPath(); ctx.moveTo(pad.left + plotW * 0.85, pY); ctx.lineTo(W - pad.right, pY); ctx.stroke();
  ctx.setLineDash([]);

  // Labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Reactants', pad.left + 4, rY - 8);
  ctx.textAlign = 'right';
  ctx.fillText('Products', W - pad.right - 4, pY - 8);

  // Ea annotation (without enzyme)
  const peakY_noEnz = pad.top + plotH * (1 - (reactantE + Ea - minE) / eRange);
  ctx.strokeStyle = '#c41e3a'; ctx.lineWidth = 1.5;
  const eaX = pad.left + peakPos * plotW + 30;
  ctx.beginPath(); ctx.moveTo(eaX, rY); ctx.lineTo(eaX, peakY_noEnz); ctx.stroke();
  // Arrow heads
  ctx.beginPath(); ctx.moveTo(eaX - 4, rY - 6); ctx.lineTo(eaX, rY); ctx.lineTo(eaX + 4, rY - 6); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(eaX - 4, peakY_noEnz + 6); ctx.lineTo(eaX, peakY_noEnz); ctx.lineTo(eaX + 4, peakY_noEnz + 6); ctx.stroke();
  ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Ea = ' + Ea, eaX + 6, (rY + peakY_noEnz) / 2 + 4);

  // Ea annotation (with enzyme)
  if (aeState.enzyme) {
    const peakY_enz = pad.top + plotH * (1 - (reactantE + EaEnzyme - minE) / eRange);
    const eaX2 = eaX + 60;
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(eaX2, rY); ctx.lineTo(eaX2, peakY_enz); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(eaX2 - 4, rY - 6); ctx.lineTo(eaX2, rY); ctx.lineTo(eaX2 + 4, rY - 6); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(eaX2 - 4, peakY_enz + 6); ctx.lineTo(eaX2, peakY_enz); ctx.lineTo(eaX2 + 4, peakY_enz + 6); ctx.stroke();
    ctx.fillStyle = '#16a34a'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText('Ea(enz) = ' + EaEnzyme, eaX2 + 6, (rY + peakY_enz) / 2 + 4);
  }

  // Delta G annotation
  const dgX = W - pad.right - 20;
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(dgX, rY); ctx.lineTo(dgX, pY); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(dgX - 4, pY + (dG < 0 ? -6 : 6)); ctx.lineTo(dgX, pY); ctx.lineTo(dgX + 4, pY + (dG < 0 ? -6 : 6)); ctx.stroke();
  ctx.fillStyle = '#2563eb'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'right';
  ctx.fillText('\u0394G = ' + (dG > 0 ? '+' : '') + dG, dgX - 6, (rY + pY) / 2 + 4);

  // Animated particle
  if (aeState.particleX >= 0 && aeState.particleX <= 1) {
    const ea = aeState.enzyme ? EaEnzyme : Ea;
    const e = aeGetEnergyCurve(aeState.particleX, reactantE, productE, ea, peakPos);
    const px = pad.left + aeState.particleX * plotW;
    const py = pad.top + plotH * (1 - (e - minE) / eRange);

    // Glow
    ctx.fillStyle = 'rgba(217,119,6,0.2)';
    ctx.beginPath(); ctx.arc(px, py - 12, 14, 0, Math.PI * 2); ctx.fill();
    // Particle
    ctx.fillStyle = '#d97706';
    ctx.beginPath(); ctx.arc(px, py - 12, 7, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(px, py - 12, 3, 0, Math.PI * 2); ctx.fill();
  }

  // Axis labels
  ctx.fillStyle = '#374151'; ctx.font = 'bold 12px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Reaction Progress', pad.left + plotW / 2, H - 10);
  ctx.save();
  ctx.translate(14, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('Free Energy (kJ/mol)', 0, 0);
  ctx.restore();

  // Transition state label
  const tsY = pad.top + plotH * (1 - (reactantE + Ea - minE) / eRange);
  ctx.fillStyle = '#c41e3a'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Transition State', pad.left + peakPos * plotW, tsY - 10);
}

function aeAnimate() {
  if (aeState.animFrame) cancelAnimationFrame(aeState.animFrame);
  aeState.particleX = 0;
  const startTime = performance.now();
  const duration = 2000;

  function step(now) {
    const elapsed = now - startTime;
    aeState.particleX = Math.min(1, elapsed / duration);
    drawAEChart();
    if (aeState.particleX < 1) {
      aeState.animFrame = requestAnimationFrame(step);
    } else {
      aeState.particleX = -1;
      setTimeout(() => drawAEChart(), 500);
    }
  }
  aeState.animFrame = requestAnimationFrame(step);
}


// ══════════════════════════════════════════════════════════════════════════
// PART 5: ANABOLIC vs CATABOLIC
// ══════════════════════════════════════════════════════════════════════════
const pathways = {
  glycolysis: {
    name: 'Glycolysis', type: 'Catabolic',
    steps: ['Glucose', 'G6P', 'F6P', 'F1,6BP', 'G3P', 'Pyruvate'],
    energyNotes: ['-1 ATP', '', '-1 ATP', '', '+2 ATP', '+2 ATP'],
    atpProduced: 4, atpConsumed: 2, nadh: 2,
    summary: 'Glucose (6C) is split into 2 pyruvate (3C), yielding net 2 ATP and 2 NADH.'
  },
  krebs: {
    name: 'Krebs Cycle', type: 'Catabolic',
    steps: ['Acetyl-CoA', 'Citrate', '\u03B1-KG', 'Succinyl-CoA', 'Succinate', 'Oxaloacetate'],
    energyNotes: ['', '', '+1 NADH', '+1 GTP', '+1 FADH\u2082', '+1 NADH'],
    atpProduced: 2, atpConsumed: 0, nadh: 8,
    summary: 'Per glucose (2 turns): 2 ATP (GTP), 6 NADH, 2 FADH\u2082, 4 CO\u2082 released.'
  },
  protein: {
    name: 'Protein Synthesis', type: 'Anabolic',
    steps: ['Amino Acids', 'tRNA Loading', 'Initiation', 'Elongation', 'Termination', 'Protein'],
    energyNotes: ['-1 ATP', '-1 GTP', '-1 GTP', '-2 GTP/aa', '', ''],
    atpProduced: 0, atpConsumed: 4, nadh: 0,
    summary: 'Amino acids are assembled into polypeptides. Requires ~4 ATP equivalents per amino acid added.'
  },
  photosynthesis: {
    name: 'Photosynthesis', type: 'Anabolic',
    steps: ['H\u2082O + CO\u2082', 'Light Rxns', 'ATP + NADPH', 'Calvin Cycle', 'G3P', 'Glucose'],
    energyNotes: ['Light energy', '+ATP,NADPH', '', '-9 ATP', '-6 NADPH', ''],
    atpProduced: 0, atpConsumed: 18, nadh: 0,
    summary: 'Light energy drives synthesis of glucose from CO\u2082 and H\u2082O. Uses 18 ATP and 12 NADPH per glucose.'
  }
};
let pwCurrent = 'glycolysis';

function pwSetPathway(name) {
  pwCurrent = name;
  const pw = pathways[name];

  // Update buttons
  Object.keys(pathways).forEach(k => {
    const btn = $('pw-btn-' + k);
    if (btn) btn.className = k === name ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';
  });

  // Update stats
  $('pw-type').textContent = pw.type;
  $('pw-atp-produced').textContent = pw.atpProduced;
  $('pw-atp-consumed').textContent = pw.atpConsumed;
  const net = pw.atpProduced - pw.atpConsumed;
  $('pw-net-atp').textContent = (net >= 0 ? '+' : '') + net;

  // Build pathway display
  const display = $('pw-display');
  const isCatabolic = pw.type === 'Catabolic';
  let html = '<div class="pathway-flow ' + (isCatabolic ? 'pathway-catabolic' : 'pathway-anabolic') + '">';
  pw.steps.forEach((step, i) => {
    if (i > 0) {
      html += '<div class="pathway-arrow">\u2192</div>';
    }
    html += '<div class="pathway-step">' + step;
    if (pw.energyNotes[i]) {
      const isRelease = pw.energyNotes[i].startsWith('+');
      html += '<br><span class="pathway-energy ' + (isRelease ? 'pathway-energy-out' : 'pathway-energy-in') + '">' + pw.energyNotes[i] + '</span>';
    }
    html += '</div>';
  });
  html += '</div>';
  html += '<div class="analysis-result' + (isCatabolic ? ' ar-pass' : '') + '"><div class="ar-title">' + pw.name + '</div><p>' + pw.summary + '</p></div>';
  display.innerHTML = html;

  drawPWCharts();
}

function drawPWCharts() {
  // Catabolic overview
  const ctxC = getCtx('pw-catabolic-chart');
  const catabolicData = {
    labels: ['Glycolysis', 'Krebs (x2)', 'ETC', 'Total'],
    values: [2, 2, 34, 38],
    colors: ['#c41e3a', '#d97706', '#7c3aed', '#16a34a']
  };
  drawBarChart(ctxC, {
    labels: catabolicData.labels,
    values: catabolicData.values,
    colors: catabolicData.colors,
    maxVal: 42
  });

  // Anabolic overview
  const ctxA = getCtx('pw-anabolic-chart');
  const anabolicData = {
    labels: ['Protein\nSynthesis', 'DNA\nReplication', 'Lipid\nSynthesis', 'Gluconeo-\ngenesis'],
    values: [4, 2, 7, 6],
    colors: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd']
  };
  drawBarChart(ctxA, {
    labels: anabolicData.labels,
    values: anabolicData.values,
    colors: anabolicData.colors,
    maxVal: 10
  });
}


// ══════════════════════════════════════════════════════════════════════════
// PART 6: METABOLIC RATE CALCULATOR
// ══════════════════════════════════════════════════════════════════════════
let mrScenarios = [];

function mrGetActivityLabel(val) {
  const labels = {
    1: 'Basal', 2: 'Sedentary', 3: 'Light', 4: 'Moderate',
    5: 'Active', 6: 'Very Active', 7: 'Vigorous',
    8: 'Intense', 9: 'Extreme', 10: 'Max'
  };
  return val + ' (' + (labels[val] || 'Custom') + ')';
}

function mrCalcBMR(mass) {
  // Kleiber's law: BMR = 70 * mass^0.75 (kcal/day)
  return 70 * Math.pow(mass, 0.75);
}

function mrCalcActive(bmr, activityLevel) {
  // Activity multiplier: 1.0 (basal) to 3.0 (extreme)
  const multiplier = 1 + (activityLevel - 1) * 0.22;
  return bmr * multiplier;
}

function mrCalcSAVol(mass) {
  // Approximate SA:Vol ratio for sphere of equivalent volume
  // density ~1000 kg/m^3, volume = mass/density
  const vol = mass / 1000; // m^3
  const r = Math.pow(3 * vol / (4 * Math.PI), 1/3); // m
  const sa = 4 * Math.PI * r * r;
  return sa / vol;
}

function mrCalcQ10(temp) {
  // Q10 factor relative to 37C baseline
  const delta = (temp - 37) / 10;
  return Math.pow(2.0, delta);
}

function mrUpdate() {
  const mass = parseFloat($('mr-mass').value);
  const temp = parseFloat($('mr-temp').value);
  const activity = parseInt($('mr-activity').value);

  $('mr-mass-val').textContent = mass >= 1 ? mass.toFixed(0) : mass.toFixed(2);
  $('mr-temp-val').textContent = temp + '\u00B0C';
  $('mr-activity-val').textContent = mrGetActivityLabel(activity);

  const bmr = mrCalcBMR(mass);
  const q10 = mrCalcQ10(temp);
  const adjustedBMR = bmr * q10;
  const activeRate = mrCalcActive(adjustedBMR, activity);
  const saVol = mrCalcSAVol(mass);

  $('mr-bmr').textContent = adjustedBMR >= 1000 ? (adjustedBMR / 1000).toFixed(1) + 'k' : adjustedBMR.toFixed(0);
  $('mr-active').textContent = activeRate >= 1000 ? (activeRate / 1000).toFixed(1) + 'k' : activeRate.toFixed(0);
  $('mr-sa-vol').textContent = saVol.toFixed(1);
  $('mr-q10').textContent = q10.toFixed(2);
}

function mrAddScenario() {
  const mass = parseFloat($('mr-mass').value);
  const temp = parseFloat($('mr-temp').value);
  const activity = parseInt($('mr-activity').value);
  const bmr = mrCalcBMR(mass) * mrCalcQ10(temp);
  const activeRate = mrCalcActive(bmr, activity);

  mrScenarios.push({
    label: mass >= 1 ? mass.toFixed(0) + 'kg' : mass.toFixed(2) + 'kg',
    mass, temp, activity, bmr, activeRate
  });
  drawMRBarChart();
}

function mrAddPresets() {
  const presets = [
    { mass: 0.02, temp: 37, activity: 5, label: 'Mouse (20g)' },
    { mass: 0.3, temp: 37, activity: 4, label: 'Rat (300g)' },
    { mass: 4, temp: 37, activity: 3, label: 'Cat (4kg)' },
    { mass: 70, temp: 37, activity: 3, label: 'Human (70kg)' },
    { mass: 500, temp: 37, activity: 3, label: 'Horse (500kg)' },
    { mass: 4000, temp: 37, activity: 2, label: 'Elephant (4t)' }
  ];
  mrScenarios = [];
  presets.forEach(p => {
    const bmr = mrCalcBMR(p.mass) * mrCalcQ10(p.temp);
    const activeRate = mrCalcActive(bmr, p.activity);
    mrScenarios.push({ ...p, bmr, activeRate });
  });
  drawMRBarChart();
}

function mrClearScenarios() {
  mrScenarios = [];
  drawMRBarChart();
}

function drawMRBarChart() {
  const ctx = getCtx('mr-bar-chart');
  const W = ctx.W, H = ctx.H;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  if (!mrScenarios.length) {
    ctx.fillStyle = '#9ca3af'; ctx.font = '13px system-ui'; ctx.textAlign = 'center';
    ctx.fillText('Add scenarios or load presets to compare metabolic rates', W / 2, H / 2);
    return;
  }

  const pad = { top: 30, right: 20, bottom: 50, left: 60 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  const n = mrScenarios.length;
  const groupW = plotW / n;
  const barW = groupW * 0.35;

  const maxVal = Math.max(...mrScenarios.map(s => s.activeRate)) * 1.2;

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    const val = maxVal * i / 4;
    ctx.fillText(val >= 1000 ? (val / 1000).toFixed(1) + 'k' : val.toFixed(0), pad.left - 6, y + 4);
  }

  mrScenarios.forEach((s, i) => {
    const cx = pad.left + groupW * i + groupW / 2;

    // BMR bar
    const bmrH = (s.bmr / maxVal) * plotH;
    ctx.fillStyle = '#2563eb';
    ctx.fillRect(cx - barW - 1, pad.top + plotH - bmrH, barW, bmrH);

    // Active rate bar
    const activeH = (s.activeRate / maxVal) * plotH;
    ctx.fillStyle = '#c41e3a';
    ctx.fillRect(cx + 1, pad.top + plotH - activeH, barW, activeH);

    // Values
    ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
    ctx.fillStyle = '#2563eb';
    const bmrStr = s.bmr >= 1000 ? (s.bmr / 1000).toFixed(1) + 'k' : s.bmr.toFixed(0);
    ctx.fillText(bmrStr, cx - barW / 2 - 1, pad.top + plotH - bmrH - 4);
    ctx.fillStyle = '#c41e3a';
    const actStr = s.activeRate >= 1000 ? (s.activeRate / 1000).toFixed(1) + 'k' : s.activeRate.toFixed(0);
    ctx.fillText(actStr, cx + barW / 2 + 1, pad.top + plotH - activeH - 4);

    // Label
    ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui';
    ctx.fillText(s.label, cx, H - pad.bottom + 16);
  });

  // Legend
  ctx.fillStyle = '#2563eb'; ctx.fillRect(pad.left, 8, 12, 12);
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('BMR (kcal/day)', pad.left + 18, 18);
  ctx.fillStyle = '#c41e3a'; ctx.fillRect(pad.left + 130, 8, 12, 12);
  ctx.fillStyle = '#374151'; ctx.fillText('Active Rate', pad.left + 148, 18);

  // Y-axis label
  ctx.save();
  ctx.translate(14, pad.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = '#374151'; ctx.font = 'bold 11px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Metabolic Rate (kcal/day)', 0, 0);
  ctx.restore();
}

function drawMRSAChart() {
  const ctx = getCtx('mr-sa-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 45, left: 55 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Log scale for mass: 0.01 to 5000
  const massPoints = [];
  for (let i = -2; i <= 3.7; i += 0.05) {
    massPoints.push(Math.pow(10, i));
  }

  const saVals = massPoints.map(m => mrCalcSAVol(m));
  const maxSA = Math.max(...saVals);

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxSA * i/4).toFixed(0), pad.left - 6, y + 4);
  }

  // Curve
  ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  massPoints.forEach((m, i) => {
    const logM = Math.log10(m);
    const x = pad.left + ((logM + 2) / 5.7) * plotW; // -2 to 3.7
    const y = pad.top + plotH * (1 - saVals[i] / maxSA);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Organism markers
  const organisms = [
    { mass: 0.02, name: 'Mouse' },
    { mass: 4, name: 'Cat' },
    { mass: 70, name: 'Human' },
    { mass: 4000, name: 'Elephant' }
  ];
  organisms.forEach(o => {
    const logM = Math.log10(o.mass);
    const x = pad.left + ((logM + 2) / 5.7) * plotW;
    const sa = mrCalcSAVol(o.mass);
    const y = pad.top + plotH * (1 - sa / maxSA);
    ctx.fillStyle = '#7c3aed';
    ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(x, y, 2, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#374151'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(o.name, x, y - 10);
  });

  // X-axis labels (log scale)
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  [-2, -1, 0, 1, 2, 3].forEach(exp => {
    const x = pad.left + ((exp + 2) / 5.7) * plotW;
    const label = exp < 0 ? (Math.pow(10, exp)).toFixed(exp === -2 ? 2 : 1) : Math.pow(10, exp).toString();
    ctx.fillText(label + ' kg', x, H - pad.bottom + 16);
  });
  ctx.font = 'bold 12px system-ui';
  ctx.fillText('Body Mass (log scale)', pad.left + plotW / 2, H - 6);
}

function drawMRQ10Chart() {
  const ctx = getCtx('mr-q10-chart');
  const W = ctx.W, H = ctx.H;
  const pad = { top: 20, right: 20, bottom: 45, left: 55 };
  const plotW = W - pad.left - pad.right, plotH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, 0, W, H);

  // Q10 curve: relative rate vs temperature
  const temps = [];
  const rates = [];
  for (let t = 5; t <= 45; t += 0.5) {
    temps.push(t);
    rates.push(mrCalcQ10(t));
  }
  const maxRate = Math.max(...rates);

  // Grid
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + plotH * (1 - i/4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#9ca3af'; ctx.font = '11px system-ui'; ctx.textAlign = 'right';
    ctx.fillText((maxRate * i/4).toFixed(2), pad.left - 6, y + 4);
  }

  // Reference line at Q10 = 1 (37C baseline)
  const refY = pad.top + plotH * (1 - 1 / maxRate);
  ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, refY); ctx.lineTo(W - pad.right, refY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui'; ctx.textAlign = 'left';
  ctx.fillText('Baseline (37\u00B0C)', pad.left + 4, refY - 4);

  // Curve
  ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2.5;
  ctx.beginPath();
  temps.forEach((t, i) => {
    const x = pad.left + ((t - 5) / 40) * plotW;
    const y = pad.top + plotH * (1 - rates[i] / maxRate);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Current temperature marker
  const currentTemp = parseFloat($('mr-temp').value);
  const currentQ10 = mrCalcQ10(currentTemp);
  const cx = pad.left + ((currentTemp - 5) / 40) * plotW;
  const cy = pad.top + plotH * (1 - currentQ10 / maxRate);
  ctx.fillStyle = '#d97706';
  ctx.beginPath(); ctx.arc(cx, cy, 7, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#374151'; ctx.font = 'bold 10px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Q10 = ' + currentQ10.toFixed(2), cx, cy - 12);

  // X-axis labels
  ctx.fillStyle = '#374151'; ctx.font = '11px system-ui'; ctx.textAlign = 'center';
  for (let t = 5; t <= 45; t += 10) {
    const x = pad.left + ((t - 5) / 40) * plotW;
    ctx.fillText(t + '\u00B0C', x, H - pad.bottom + 16);
  }
  ctx.font = 'bold 12px system-ui';
  ctx.fillText('Temperature (\u00B0C)', pad.left + plotW / 2, H - 6);
}


// ══════════════════════════════════════════════════════════════════════════
// SIDEBAR SCROLL HIGHLIGHT
// ══════════════════════════════════════════════════════════════════════════
function updateSidebar() {
  const sections = document.querySelectorAll('.section, .hero');
  const links = document.querySelectorAll('.sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    if (window.scrollY >= s.offsetTop - 100) current = s.id;
  });
  links.forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateSidebar);

// ══════════════════════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  // Part 1: Enzyme Kinetics
  ekSetInhibitor('none');
  ekUpdate();

  // Part 2: Temp & pH
  tpSetPreset('catalase');

  // Part 3: ATP
  atpUpdateUI();

  // Part 4: Activation Energy
  aeSetType('exergonic');

  // Part 5: Pathways
  pwSetPathway('glycolysis');

  // Part 6: Metabolic Rate
  mrUpdate();
  drawMRBarChart();
  drawMRSAChart();
  drawMRQ10Chart();
});

window.addEventListener('resize', () => {
  drawEKChart();
  drawTempChart(); drawPHChart();
  drawATPCouplingChart();
  drawAEChart();
  drawPWCharts();
  drawMRBarChart(); drawMRSAChart(); drawMRQ10Chart();
});
</script>
</body>
</html>
